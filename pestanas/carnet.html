<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carnet â€” CÃ¡ritas CNC</title>
  <link rel="stylesheet" href="styles-caritas.css" />
  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js" defer></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" defer></script>
  <script src="api.js/firebase-config-caritas.js" defer></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" defer></script>
  <script src="api.js/supabase-config-caritas.js" defer></script>
</head>
<body>
  <header class="container" style="text-align:center;margin:1rem auto;">
    <h1>ğŸ“Œ Carnet personal</h1>
    <a href="index.html" class="btn-ghost">â† Volver al inicio</a>
  </header>

  <main class="container card" style="max-width:400px;text-align:center;">
    <img id="fotoPerfil" src="img/avatar-placeholder.png" alt="Foto de perfil" class="foto" />
    <div class="datos">
      <p><b>Email:</b> <span id="email">â€”</span></p>
      <p><b>ID Usuario:</b> <span id="uid">â€”</span></p>
      <p class="codigo"><b>CÃ³digo:</b> <span id="codigo">â€”</span></p>
    </div>
    <canvas id="qrCanvas" width="180" height="180"></canvas>
    <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;">
      <button class="btn" id="btnLogout">ğŸ”’ Cerrar sesiÃ³n</button>
      <button class="btn-ghost" id="btnCopiar">ğŸ”— Copiar enlace</button>
    </div>
    <div id="msg" style="margin-top:1rem;"></div>
  </main>
<script>
(() => {
  'use strict';
  console.log("âœ… [Carnet] pestaÃ±a cargada");

  const supabase = window.CARITAS?.supabase;
  const auth = window.CARITAS?.auth;
  console.log("ğŸ”Œ Supabase conectado:", !!supabase);
  console.log("ğŸ”‘ Firebase auth listo:", !!auth);

  const msgBox = document.getElementById("msg");
  function showMsg(text, type="info"){
    msgBox.textContent = text;
    msgBox.className = type;
    console.log(`[MSG-${type}]`, text);
    setTimeout(()=>{ msgBox.textContent=""; },4000);
  }

  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  function avatarFallback(nombre){
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre||'Usuario')}&background=111&color=fff`;
  }

  function renderCarnet(user, cred){
    console.log("ğŸ“„ Renderizando carnet de:", user.email, user.uid);
    document.getElementById('email').textContent = esc(cred?.email || user.email || 'â€”');
    document.getElementById('uid').textContent = esc(cred?.user_id || user.uid || 'â€”');
    document.getElementById('codigo').textContent = esc(cred?.codigo_verificacion || 'N/A');
    document.getElementById('fotoPerfil').src = cred?.foto_url || avatarFallback(cred?.nombre || user.email);

    const url = `${location.origin}/credencial.html?id=${encodeURIComponent(cred?.user_id || user.uid)}`;
    QRCode.toCanvas(document.getElementById('qrCanvas'), url, err=>{
      if(err) {
        console.error("âŒ Error generando QR:", err);
        showMsg("âŒ Error generando QR","error");
      } else {
        console.log("âœ… QR generado con URL:", url);
      }
    });
    showMsg("âœ… Carnet cargado correctamente","success");
  }

  async function cargarCredencial(uid){
    console.log("ğŸ” Consultando credencial en Supabase:", uid);
    try {
      const { data, error } = await supabase.from('credenciales').select('*').eq('user_id', uid).single();
      if(error || !data) {
        console.warn("âš ï¸ No se encontrÃ³ credencial:", error);
        showMsg("âŒ No se encontrÃ³ tu credencial","error");
        return null;
      }
      console.log("âœ… Credencial obtenida:", data);
      return data;
    } catch(err){
      console.error("âŒ Error cargando credencial:", err);
      showMsg("âŒ Error cargando credencial","error");
      return null;
    }
  }

  function init(){
    if(!supabase || !auth){
      showMsg("âŒ Error: servicios no inicializados","error");
      return;
    }
    auth.onAuthStateChanged(async (user) => {
      if (!user){
        console.warn("âš ï¸ Usuario no autenticado, redirigiendo a login...");
        location.href = 'login.html';
        return;
      }
      console.log("ğŸ‘¤ SesiÃ³n activa:", user.email, user.uid);
      const cred = await cargarCredencial(user.uid);
      if(cred) renderCarnet(user, cred);
    });
  }

  // Botones
  document.getElementById('btnLogout').addEventListener('click', () => {
    console.log("ğŸ”’ BotÃ³n Logout clicado");
    auth?.signOut().then(()=>{
      localStorage.removeItem("caritasUser");
      location.href='login.html';
    });
  });

  document.getElementById('btnCopiar').addEventListener('click', () => {
    const uid = document.getElementById('uid').textContent;
    const url = `${location.origin}/credencial.html?id=${encodeURIComponent(uid)}`;
    console.log("ğŸ”— Copiando enlace:", url);
    navigator.clipboard.writeText(url)
      .then(()=> showMsg("ğŸ”— Enlace copiado al portapapeles","success"))
      .catch(err=> {
        console.error("âŒ Error al copiar enlace:", err);
        showMsg("âŒ No se pudo copiar enlace","error");
      });
  });

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>