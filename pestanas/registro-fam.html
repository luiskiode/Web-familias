<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Familias - CÃ¡ritas CNC</title>

<link rel="stylesheet" href="estilos-familias.css" />

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="api.js/firebase-config-caritas.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
<script src="api.js/supabase-config-caritas.js" defer></script>
</head>
<body>

<header class="app-header">
  <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Familias - CÃ¡ritas CNC</h1>
  <button onclick="window.close()">Cerrar</button>
</header>

<main>
  <!-- ğŸ“‹ Tabla de familias -->
  <section class="card">
    <h2>ğŸ“‹ Lista de Familias</h2>
    <table id="familiasTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombres</th>
          <th>DNI</th>
          <th>Apellido Familia</th>
          <th>DirecciÃ³n</th>
          <th>TelÃ©fono</th>
          <th>Observaciones</th>
          <th>Fecha Registro</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ğŸ“ Formulario de registro -->
  <section class="card" style="margin-top:2rem;">
    <h2>ğŸ“ Registro de Familia</h2>
    <form id="familiaForm">
      <label>ğŸ§‘â€ğŸ¦± Nombres y Apellidos*</label>
      <input type="text" name="nombres_apellidos" required />

      <label>ğŸ†” DNI*</label>
      <input type="text" name="dni_solicitante" maxlength="8" pattern="[0-9]{8}" required />

      <label>ğŸ  DirecciÃ³n*</label>
      <input type="text" name="direccion" required />

      <label>ğŸ“ TelÃ©fono*</label>
      <input type="text" name="telefono_contacto" pattern="[0-9]+" required />

      <label>ğŸ“ Observaciones</label>
      <textarea name="observaciones"></textarea>

      <button type="submit" class="submit-btn">ğŸ’¾ Guardar Familia</button>
    </form>
  </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tbody = document.querySelector("#familiasTable tbody");
  const form = document.getElementById("familiaForm");

  const supabase = window.CARITAS?.supabase;
  const auth = window.CARITAS?.auth;

  // =======================
  // ğŸ”‘ Requiere sesiÃ³n activa
  // =======================
  auth?.onAuthStateChanged(user => {
    if (!user) {
      alert("âš ï¸ Debes iniciar sesiÃ³n para ver y registrar familias.");
      window.close();
      return;
    }
    loadFamilias();
  });

  // =======================
  // ğŸ“‹ Cargar familias
  // =======================
  async function loadFamilias() {
    try {
      const { data, error } = await supabase.from("familias").select("*").order("id", { ascending: true });
      if (error) throw error;

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Sin registros</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      data.forEach(fam => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fam.id ?? ""}</td>
          <td>${fam.nombres_apellidos ?? ""}</td>
          <td>${fam.dni_solicitante ?? ""}</td>
          <td>${fam.apellido_familia ?? ""}</td>
          <td>${fam.direccion ?? ""}</td>
          <td>${fam.telefono_contacto ?? ""}</td>
          <td>${fam.observaciones ?? ""}</td>
          <td>${fam.fecha_registro ?? ""}</td>
        `;
        tbody.appendChild(tr);
      });

    } catch (err) {
      console.error("âŒ Error al cargar familias:", err.message);
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Error al cargar datos</td></tr>`;
    }
  }

  // =======================
  // ğŸ’¾ Registrar nueva familia
  // =======================
  form?.addEventListener("submit", async e => {
    e.preventDefault();
    const fd = new FormData(form);

    const payload = {
      nombres_apellidos: fd.get("nombres_apellidos"),
      dni_solicitante: fd.get("dni_solicitante"),
      apellido_familia: fd.get("apellido_familia") || "",
      direccion: fd.get("direccion"),
      telefono_contacto: fd.get("telefono_contacto"),
      observaciones: fd.get("observaciones") || "",
      fecha_registro: new Date().toISOString().split("T")[0]
    };

    try {
      const { error } = await supabase.from("familias").insert([payload]);
      if (error) throw error;

      alert("âœ… Familia registrada con Ã©xito");
      form.reset();
      loadFamilias();
    } catch (err) {
      console.error("âŒ Error al registrar familia:", err.message);
      alert("Error al registrar familia");
    }
  });
});
</script>

</body>
</html>