<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>👨‍👩‍👧 Registro de Familias — Cáritas CNC</title>
  <base href="/Web-familias/">
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script type="module" src="api.js/health-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>
  <!-- Manifest + meta PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#b91c1c">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Supabase -->
  <script type="module" src="api.js/supabase-config-caritas.js"></script>
</head>
<body>
  <main class="container card" style="max-width:700px;">
    <h2>
      Formulario de 
      <a href="#listado" style="text-decoration:none;">
        <span style="cursor:pointer">Registro</span>
      </a>
    </h2>
    <p>Complete todos los datos requeridos para registrar su solicitud de ayuda.</p>

    <form id="famForm" enctype="multipart/form-data">
      <label>👤 Nombre y apellidos del solicitante:</label>
      <input type="text" id="nombres_apellidos" required>

      <label>🪪 DNI del solicitante:</label>
      <input type="text" id="dni_solicitante" required>

      <label>👨‍👩‍👧 Apellido de la familia:</label>
      <input type="text" id="apellido_familia" required>

      <label>📞 Teléfono de contacto:</label>
      <input type="tel" id="telefono_contacto">

      <label>📝 Observaciones:</label>
      <textarea id="observaciones" rows="4"></textarea>

      <label>📍 Dirección de la familia:</label>
<div style="display:flex;gap:8px;align-items:center">
  <input type="text" id="direccion" placeholder="Ej: Calle 123, Ciudad" required style="flex:1">
  <button type="button" id="btnValidar" class="btn-ghost">🗺 Validar</button>
</div>

      <label>📂 Subir archivo de registro:</label>
      <input type="file" id="archivo" accept=".pdf,.doc,.docx">

      <label style="display:flex;align-items:center;gap:.4rem;margin-top:10px">
        <input type="checkbox" id="acceptTerms" required>
        Acepto <a href="#terminos">términos y condiciones</a>

      <button type="submit" class="btn">✅ Registrar familia</button>
    </form>
    <p id="famMsg" class="msg" style="margin-top:1rem;"></p>
  </main>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  console.log("✅ [Registro Familias] pestaña cargada");

  // Esperar a que Supabase esté listo
  document.addEventListener("supabase:ready:caritas", ()=>{
    const supabase = window.CARITAS?.supabase;
    console.log("🔌 Supabase conectado:", !!supabase);

    if(!supabase){
      alert("❌ Supabase no inicializado. Revisa supabase-config-caritas.js");
      return;
    }

    const form = document.getElementById('famForm');
    const msg = document.getElementById('famMsg');
    const btnValidar = document.getElementById('btnValidar');
    const acceptTerms = document.getElementById('acceptTerms');

    function showMsg(text,type="info"){
      msg.textContent=text;
      msg.className="msg "+type;
      setTimeout(()=>{ msg.textContent=""; msg.className="msg"; },4000);
    }

    // Botón validar dirección
    if (btnValidar) {
      btnValidar.addEventListener('click', ()=>{
        const dir = document.getElementById('direccion').value.trim();
        if(!dir){ 
          showMsg("⚠️ Ingresa la dirección primero","error"); 
          return; 
        }
        // Todos los archivos están en /pestanas/
        const url = `#validar-direccion?dir=${encodeURIComponent(dir)}`;
        location.hash = url;
        console.log("🗺 Abriendo validador con:", url);
        window.open(url, "_blank", "noopener,noreferrer");
      });
    }

    // Guardar familia en Supabase
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.textContent='';

      const nombres_apellidos = document.getElementById('nombres_apellidos').value.trim();
      const dni_solicitante = document.getElementById('dni_solicitante').value.trim();
      const apellido_familia = document.getElementById('apellido_familia').value.trim();
      const telefono_contacto = document.getElementById('telefono_contacto').value.trim();
      const observaciones = document.getElementById('observaciones').value.trim();
      const direccion = document.getElementById('direccion').value.trim();
      const archivo = document.getElementById('archivo').files[0];

      if(!acceptTerms.checked){
        showMsg("⚠️ Debes aceptar los términos.","error");
        return;
      }

      try {
        let archivo_url = null;
        if(archivo){
          const { data: up, error: upErr } = await supabase.storage
            .from('familias-files')
            .upload(`${Date.now()}_${archivo.name}`, archivo, { upsert:true });
          if(upErr) throw upErr;
          archivo_url = up?.path || null;
          console.log("✅ Archivo subido:", archivo_url);
        }

        const { data, error } = await supabase
          .from("familias")
          .insert({
            nombres_apellidos,
            dni_solicitante,
            apellido_familia,
            telefono_contacto,
            observaciones,
            direccion,
            archivo_url,
            visitada: false,
            creado_en: new Date().toISOString()
          })
          .select();

        if (error) {
          console.error("❌ Error al guardar familia:", error);
          showMsg("❌ Error: " + error.message,"error");
        } else {
          console.log("✅ Familia guardada:", data);
          showMsg("✅ Familia registrada correctamente","success");
          form.reset();
        }
      } catch (err) {
        console.error("❌ Excepción:", err);
        showMsg("❌ Error inesperado: " + err.message,"error");
      }
    });

    // Registrar service worker (está en /api.js/)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('api.js/service-worker.js')
        .then(()=> console.log("📲 Service Worker registrado"))
        .catch(err=> console.error("SW error:", err));
    }
  });
});
</script>

</body>
</html>