<section class="inicio-card" id="tab-inicio">

  <!-- ğŸ”” Bienvenida dinÃ¡mica -->
  <section id="bienvenida" class="card center" style="margin:1rem auto;max-width:800px;display:none">
    <h2 id="bienvenida-text">ğŸ‘‹ Bienvenid@ a tu plataforma de servicio</h2>
  </section>
    
  <!-- ğŸ“ Mensaje semanal -->
  <article class="card" id="mensaje-semanal">
    <h3 class="with-emoji" data-emoji="ğŸ“">Mensaje Semanal</h3>
    <div id="mensajeSemanalContent" class="muted">Cargando mensaje...</div>
  </article>

  <!-- ğŸ“Œ Pendientes (solo lectura) -->
  <article class="card">
    <header style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;">
      <h3>ğŸ“Œ Mis pendientes</h3>
      <small class="pill">vista solo lectura</small>
    </header>
    <div id="pendientes-home-empty" class="muted" hidden>
      Sin pendientes aÃºn. âœ¨
    </div>
    <table aria-label="Tabla de pendientes">
      <thead>
        <tr><th scope="col">Tarea</th><th scope="col" style="width:120px">Estado</th></tr>
      </thead>
      <tbody id="pendientesHomeBody"><tr><td colspan="2">Cargando...</td></tr></tbody>
    </table>
  </article>

  <!-- ğŸŒŸ MisiÃ³n / ğŸš€ VisiÃ³n -->
  <article class="card mision-vision">
    <div class="mision">
      <h3>ğŸŒŸ Nuestra MisiÃ³n</h3>
      <ul>
        <li>â¤ï¸ Servir con respeto y empatÃ­a a las familias mÃ¡s necesitadas.</li>
        <li>ğŸ™ Guiarnos por la fe, el compromiso y la compasiÃ³n.</li>
        <li>ğŸ¤ Promover dignidad, justicia y solidaridad.</li>
        <li>ğŸŒ± Trabajar unidos para crear oportunidades y esperanza.</li>
        <li>ğŸ”¥ Transformar vidas a travÃ©s de la acciÃ³n social.</li>
      </ul>
    </div>
    <div class="vision">
      <h3>ğŸš€ Nuestra VisiÃ³n</h3>
      <ul>
        <li>ğŸ› Ser referente de servicio y apoyo.</li>
        <li>ğŸ’¡ Construir una comunidad fraterna.</li>
        <li>âœ Inspirarnos en el Evangelio.</li>
        <li>ğŸŒ Promover justicia social y desarrollo integral.</li>
        <li>ğŸ¤— AcompaÃ±ar con acogida y transformaciÃ³n.</li>
      </ul>
    </div>
    <p class="agradecimiento">ğŸ™ Â¡Gracias por ser parte de esta misiÃ³n! â¤ï¸</p>
  </article>

  <!-- ğŸ“· GalerÃ­a -->
  <article class="card">
    <h3>ğŸ“· Nuestra comunidad</h3>
    <div id="galeriaGrid" class="galeria-grid">Cargando imÃ¡genes...</div>
  </article>

  <!-- ğŸ–¼ï¸ Modal galerÃ­a -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-label="Imagen ampliada">
    <button class="cerrar" id="modalClose" aria-label="Cerrar">âœ–ï¸</button>
    <img class="modal-contenido" id="img-ampliada" alt="Vista ampliada" />
    <div id="caption" class="muted" style="margin-top:.4rem"></div>
  </div>
</section>

<script>
(() => {
  'use strict';
  const supabase = window.CARITAS?.supabase;
  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  // === Mensaje Semanal ===
  async function cargarMensajeSemanal(){
    const box = document.getElementById("mensajeSemanalContent");
    try{
      const { data, error } = await supabase.from("mensajes")
        .select("contenido,fecha")
        .order("fecha",{ascending:false})
        .limit(1)
        .single();
      if(error || !data){ box.textContent="âŒ No hay mensaje disponible."; return; }
      box.innerHTML = esc(data.contenido);
    }catch(err){
      console.error(err);
      box.textContent="âŒ Error al cargar mensaje.";
    }
  }

  // === Pendientes (solo lectura) ===
  async function renderPendientesHome(){
    const tbody = document.getElementById('pendientesHomeBody');
    const empty = document.getElementById('pendientes-home-empty');
    tbody.innerHTML = '<tr><td colspan="2">Cargando...</td></tr>';
    try {
      const { data, error } = await supabase.from('pendientes').select('descripcion, estado').order('id',{ascending:true});
      if(error) throw error;
      tbody.innerHTML="";
      if(!data || data.length===0){ empty.hidden=false; return; }
      empty.hidden=true;
      data.forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${esc(p.descripcion)} â¤ï¸</td><td>${p.estado ? 'âœ”ï¸ Hecho':'â³ Pendiente'}</td>`;
        tbody.appendChild(tr);
      });
    }catch(err){
      console.error(err);
      tbody.innerHTML="";
      empty.hidden=false;
      empty.textContent="âŒ Error al cargar pendientes.";
    }
  }

  // === GalerÃ­a dinÃ¡mica ===
  async function cargarGaleria(){
    const grid=document.getElementById("galeriaGrid");
    grid.textContent="Cargando...";
    try{
      const { data, error } = await supabase.storage.from("galeria").list("",{ limit:12 });
      if(error) throw error;
      if(!data || data.length===0){ grid.textContent="No hay imÃ¡genes en la galerÃ­a."; return; }
      grid.innerHTML="";
      data.forEach(file=>{
        const url = supabase.storage.from("galeria").getPublicUrl(file.name).data.publicUrl;
        const img=document.createElement("img");
        img.src=url;
        img.alt="Foto comunidad";
        img.className="miniatura";
        img.loading="lazy";
        grid.appendChild(img);
      });
      bindGaleria();
    }catch(err){
      console.error(err);
      grid.textContent="âŒ Error cargando galerÃ­a.";
    }
  }

  // === Modal GalerÃ­a ===
  function bindGaleria(){
    const modal=document.getElementById('modal');
    const modalImg=document.getElementById('img-ampliada');
    const modalClose=document.getElementById('modalClose');
    const caption=document.getElementById('caption');
    document.querySelectorAll('#galeriaGrid img').forEach(img=>{
      img.addEventListener('click',()=>{
        modal.style.display='flex';
        modal.setAttribute('aria-hidden','false');
        modalImg.src=img.src;
        caption.textContent=img.alt||'';
      });
    });
    modalClose.addEventListener('click',()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });
    modal.addEventListener('click',e=>{ if(e.target===modal) modalClose.click(); });
    window.addEventListener('keydown',e=>{ if(e.key==='Escape') modalClose.click(); });
  }

  // Init
  document.addEventListener("DOMContentLoaded",()=>{
    cargarMensajeSemanal();
    renderPendientesHome();
    cargarGaleria();
  });
})();
</script>