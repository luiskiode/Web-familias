<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro â€” CÃ¡ritas CNC</title>
  <link rel="stylesheet" href="styles-caritas.css">
  <base href="/Web-familias/">
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script type="module" src="api.js/health-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="api.js/firebase-config-caritas.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="api.js/supabase-config-caritas.js"></script>
</head>
<body>
  <main class="container card" style="max-width:500px;">
    <h2>ğŸ“ Crear cuenta CÃ¡ritas CNC</h2>
    <form id="registerForm">
      <label>Email:
        <input type="email" id="regEmail" required>
      </label>
      <label>ContraseÃ±a:
        <input type="password" id="regPass" required minlength="6">
      </label>
      <button type="submit" class="btn">âœ… Registrarme</button>
    </form>
    <p id="regMsg" style="margin-top:1rem;"></p>
  </main>

<script>
(() => {
  'use strict';
  const form = document.getElementById('registerForm');
  const msg  = document.getElementById('regMsg');
  const supabase = window.CARITAS?.supabase;
  const auth     = window.CARITAS?.auth;

  function showMsg(text,type="info"){
    msg.textContent=text;
    msg.className=type;
    setTimeout(()=>{ msg.textContent=""; },4000);
  }

  function generarCodigo(){
    return Math.random().toString(36).substring(2,8).toUpperCase();
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = regEmail.value.trim();
    const pass  = regPass.value;

    if(!email || !pass){ showMsg('âŒ Completa todos los campos','error'); return; }

    try{
      // 1. Crear en Firebase
      const userCred = await auth.createUserWithEmailAndPassword(email,pass);
      const user = userCred.user;

      // 2. Upsert en Supabase credenciales
      const nombre = email.split('@')[0];
      const { error } = await supabase.from('credenciales').upsert({
        user_id: user.uid,
        email: user.email,
        nombre,
        codigo_verificacion: generarCodigo(),
        rol: 'Voluntario CÃ¡ritas CNC',
        creado_en: new Date().toISOString()
      });
      if(error) throw error;

      // 3. Guardar en localStorage
      localStorage.setItem('caritasUser', JSON.stringify({
        uid: user.uid,
        email: user.email,
        nombre,
        rol: 'Voluntario CÃ¡ritas CNC'
      }));

      showMsg('âœ… Cuenta creada, redirigiendoâ€¦','success');
      setTimeout(()=> location.href='index.html',1500);

    }catch(err){
      console.error('Registro error:',err);
      showMsg('âŒ '+(err.message||'Error en el registro'),'error');
    }
  });
})();
</script>
</body>
</html>