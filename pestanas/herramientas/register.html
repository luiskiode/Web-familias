<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ† Herramienta ‚Äî C√°ritas CNC</title>
  <base href="/Web-familias/">
  <link rel="stylesheet" href="../../styles-caritas.css">

  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://www.gstatic.com;
             style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <script type="module" src="../../api.js/self-heal-caritas.js"></script>
  <script type="module" src="../../api.js/health-caritas.js"></script>
  <script defer src="../../api.js/error-overlay.js"></script>

  <!-- ‚úÖ Supabase ESM -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";
    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.dispatchEvent(new Event("supabase:ready:caritas"));
    }
  </script>
</head>
<body>
  <main class="container card" style="max-width:500px;">
    <h2>üìù Crear cuenta C√°ritas CNC</h2>
    <form id="registerForm">
      <label>Email:
        <input type="email" id="regEmail" required>
      </label>
      <label>Contrase√±a:
        <input type="password" id="regPass" required minlength="6">
      </label>
      <button type="submit" class="btn">‚úÖ Registrarme</button>
    </form>
    <p id="regMsg" style="margin-top:1rem;"></p>
  </main>

<script>
(() => {
  'use strict';
  const form = document.getElementById('registerForm');
  const msg  = document.getElementById('regMsg');
  const supabase = window.CARITAS?.supabase;
  const auth     = window.CARITAS?.auth;

  function showMsg(text,type="info"){
    msg.textContent=text;
    msg.className=type;
    setTimeout(()=>{ msg.textContent=""; },4000);
  }

  function generarCodigo(){
    return Math.random().toString(36).substring(2,8).toUpperCase();
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = regEmail.value.trim();
    const pass  = regPass.value;

    if(!email || !pass){ showMsg('‚ùå Completa todos los campos','error'); return; }

    try{
      // 1. Crear en Firebase
      const userCred = await auth.createUserWithEmailAndPassword(email,pass);
      const user = userCred.user;

      // 2. Upsert en Supabase credenciales
      const nombre = email.split('@')[0];
      const { error } = await supabase.from('credenciales').upsert({
        user_id: user.uid,
        email: user.email,
        nombre,
        codigo_verificacion: generarCodigo(),
        rol: 'Voluntario C√°ritas CNC',
        creado_en: new Date().toISOString()
      });
      if(error) throw error;

      // 3. Guardar en localStorage
      localStorage.setItem('caritasUser', JSON.stringify({
        uid: user.uid,
        email: user.email,
        nombre,
        rol: 'Voluntario C√°ritas CNC'
      }));

      showMsg('‚úÖ Cuenta creada, redirigiendo‚Ä¶','success');
      setTimeout(()=> location.href='index.html',1500);

    }catch(err){
      console.error('Registro error:',err);
      showMsg('‚ùå '+(err.message||'Error en el registro'),'error');
    }
  });
})();
</script>
</body>
</html>