<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ† Servicios ‚Äî C√°ritas CNC</title>
  <base href="/Web-familias/">
  <link rel="stylesheet" href="../../styles-caritas.css">

  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://www.gstatic.com;
             style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <script type="module" src="../../api.js/self-heal-caritas.js"></script>
  <script type="module" src="../../api.js/health-caritas.js"></script>
  <script defer src="../../api.js/error-overlay.js"></script>

  <!-- ‚úÖ Supabase ESM -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";
    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.dispatchEvent(new Event("supabase:ready:caritas"));
    }
  </script>
</head>
<body>
  <header>
    <h1>üõ†Ô∏è Servicios C√°ritas CNC</h1>
  </header>

  <!-- Acciones r√°pidas -->
  <div class="acciones-rapidas">
    <a href="https://drive.google.com/drive/folders/1OaDPvylPIL_5ySTv4zWiU0YHbiZJiIpv?usp=drive_link" target="_blank" class="btn">üìÇ Acceso a Drive</a>
    <button id="btnEstadisticas" class="btn">üìä Ver Estad√≠sticas</button>
  </div>

  <div id="msg"></div>

  <!-- Calendario + Pendientes -->
  <div class="contenedor">
    <div id="calendar"></div>
    <div id="pendientes">
      <h3>üìå Pendientes</h3>
      <ul id="listaPendientes"></ul>
      <form id="formPendiente">
        <input type="text" id="descPendiente" placeholder="Descripci√≥n" required>
        <input type="date" id="fechaPendiente" required>
        <button type="submit">‚ûï Agregar</button>
      </form>
    </div>
  </div>

  <!-- Estad√≠sticas -->
  <div id="estadisticas" class="card">
    <h3>üìä Estad√≠sticas de Familias (seg√∫n observaciones)</h3>
    <canvas id="chartCasuisticas"></canvas>
  </div>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  console.log("‚úÖ [Servicios] cargado");

  const supabase = window.CARITAS?.supabase;
  const msg = document.getElementById("msg");
  const btnEstadisticas = document.getElementById("btnEstadisticas");
  const estadisticasDiv = document.getElementById("estadisticas");
  const ctx = document.getElementById("chartCasuisticas");

  function showMsg(text,type="info"){
    msg.textContent=text;
    msg.className=type;
    setTimeout(()=>{ msg.textContent=""; msg.className=""; },4000);
  }

  // =========================
  // üìå Pendientes
  // =========================
  const listaPendientes = document.getElementById("listaPendientes");
  const formPendiente = document.getElementById("formPendiente");

  async function cargarPendientes(){
    const { data, error } = await supabase.from("pendientes")
      .select("*")
      .order("fecha",{ascending:true});
    if(error){ console.error(error); return; }
    listaPendientes.innerHTML="";
    data.forEach(p=>{
      const li=document.createElement("li");
      li.textContent=`${p.descripcion} (${p.fecha}) ${p.estado?"‚úîÔ∏è":"‚è≥"}`;
      listaPendientes.appendChild(li);
    });
  }

  formPendiente.addEventListener("submit", async e=>{
    e.preventDefault();
    const desc=document.getElementById("descPendiente").value.trim();
    const fecha=document.getElementById("fechaPendiente").value;
    try{
      const { error } = await supabase.from("pendientes").insert({
        descripcion:desc, fecha:fecha, estado:false
      });
      if(error) throw error;
      showMsg("‚úÖ Pendiente agregado","success");
      enviarNotificacion("Nuevo pendiente",desc);
      formPendiente.reset();
      cargarPendientes();
      cargarEventos(); // recargar calendario
    }catch(err){
      console.error(err);
      showMsg("‚ùå Error al agregar pendiente","error");
    }
  });

  // =========================
  // üìÖ Calendario (FullCalendar)
  // =========================
  let calendar;
  function initCalendar(){
    const el=document.getElementById("calendar");
    calendar = new FullCalendar.Calendar(el,{
      initialView:"dayGridMonth",
      events: cargarEventos,
      dateClick: function(info){
        document.getElementById("fechaPendiente").value = info.dateStr;
      }
    });
    calendar.render();
  }

  async function cargarEventos(fetchInfo, successCallback, failureCallback){
    try{
      const { data, error } = await supabase.from("pendientes")
        .select("id, descripcion, fecha, estado");
      if(error) throw error;

      const eventos = data.map(p=>({
        id: p.id,
        title: (p.estado ? "‚úîÔ∏è " : "‚è≥ ") + p.descripcion,
        start: p.fecha,
        allDay: true,
        color: p.estado ? "green" : "orange"
      }));
      successCallback(eventos);
    }catch(err){
      console.error("‚ùå Error cargando eventos:",err);
      if(failureCallback) failureCallback(err);
    }
  }

  // =========================
  // üìä Estad√≠sticas
  // =========================
  let chartInstance=null;
  async function cargarEstadisticas(){
    showMsg("‚è≥ Procesando casu√≠sticas...","info");
    const { data, error } = await supabase.from("familias")
      .select("observaciones");
    if(error){ console.error(error); return; }

    // Clasificaci√≥n autom√°tica por palabras clave
    const categorias = {
      "Ayuda alimentaria": /alimento|comida|v√≠veres|hambre/i,
      "Asistencia m√©dica": /salud|medico|hospital|enfermedad|doctor/i,
      "Trabajo y econom√≠a": /trabajo|empleo|dinero|econom√≠a/i,
      "Acompa√±amiento espiritual": /espiritual|iglesia|oraci√≥n|misa/i,
      "Otros": /.*/
    };
    const conteo = {};
    data.forEach(f=>{
      const obs = f.observaciones || "";
      let encontrada = "Otros";
      for(const [cat,regex] of Object.entries(categorias)){
        if(regex.test(obs)){ encontrada=cat; break; }
      }
      conteo[encontrada] = (conteo[encontrada]||0)+1;
    });

    // Crear gr√°fico
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx,{
      type:"pie",
      data:{
        labels:Object.keys(conteo),
        datasets:[{
          data:Object.values(conteo),
          backgroundColor:["#e11d48","#2563eb","#16a34a","#9333ea","#6b7280"]
        }]
      }
    });

    estadisticasDiv.style.display="block";
    showMsg("‚úÖ Estad√≠sticas generadas","success");
  }

  btnEstadisticas.addEventListener("click", cargarEstadisticas);

  // =========================
  // üöÄ Inicializaci√≥n
  // =========================
  initCalendar();
  cargarPendientes();
});
</script>
</body>
</html>