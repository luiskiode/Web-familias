<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ† Validar Credencial ‚Äî C√°ritas CNC</title>
  <base href="/Web-familias/">
  <link rel="stylesheet" href="../../styles-caritas.css">

  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://www.gstatic.com;
             style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <script type="module" src="../../api.js/self-heal-caritas.js"></script>
  <script type="module" src="../../api.js/health-caritas.js"></script>
  <script defer src="../../api.js/error-overlay.js"></script>

  <!-- ‚úÖ Supabase ESM -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";
    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.dispatchEvent(new Event("supabase:ready:caritas"));
    }
  </script>
</head>
<body>
  <header class="container" style="text-align:center;margin:1rem auto;">
    <h1>ü™™ Validar Credencial</h1>
    <a href="index.html" class="btn-ghost">‚Üê Volver al inicio</a>
  </header>

  <main class="container card" style="max-width:500px;text-align:center;">
    <video id="video" autoplay playsinline muted style="width:100%;max-width:460px;background:#000;border:3px solid var(--primary);border-radius:10px;"></video>
    <p id="output" class="muted" style="margin-top:.5rem;">Apunta la c√°mara al QR de la credencial.</p>

    <section id="card" class="card" style="display:none;margin-top:1rem;">
      <img id="foto" class="foto" alt="Foto de la credencial" style="width:88px;height:88px;border-radius:50%;border:2px solid var(--primary);object-fit:cover;">
      <div><strong id="nombre">‚Äî</strong></div>
      <div id="email">‚Äî</div>
      <div>C√≥digo: <span id="codigo">‚Äî</span></div>
    </section>
  </main>

<script>
(() => {
  'use strict';
  const supabase = window.CARITAS?.supabase;
  const video = document.getElementById('video');
  const output = document.getElementById('output');
  const card = document.getElementById('card');
  const foto = document.getElementById('foto');
  const nombre = document.getElementById('nombre');
  const email = document.getElementById('email');
  const codigo = document.getElementById('codigo');

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d',{willReadFrequently:true});

  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  function parseQR(data){
    try{
      const url = new URL(data);
      const id = url.searchParams.get('id');
      if(id) return id;
    }catch{}
    try{
      const j = JSON.parse(data);
      if(j && j.user_id) return j.user_id;
    }catch{}
    return null;
  }

  async function cargarCredencial(uid){
    try{
      const { data, error } = await supabase
        .from('credenciales')
        .select('*')
        .eq('user_id', uid)
        .single();
      if(error || !data) throw error || new Error("No encontrada");

      foto.src = data.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre||'U')}&background=111&color=fff`;
      nombre.textContent = esc(data.nombre||"‚Äî");
      email.textContent = esc(data.email||"‚Äî");
      codigo.textContent = esc(data.codigo_verificacion||"N/A");
      card.style.display="block";
      output.textContent = "‚úÖ Credencial v√°lida";
      output.className = "success";
    }catch(e){
      console.error(e);
      card.style.display="none";
      output.textContent = "‚ùå Credencial no v√°lida";
      output.className = "error";
    }
  }

  function scanLoop(){
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const img=ctx.getImageData(0,0,canvas.width,canvas.height);
      const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
      if(code){
        const uid=parseQR(code.data);
        if(uid){ cargarCredencial(uid); stopScan(); }
      }
    }
    requestAnimationFrame(scanLoop);
  }

  function startScan(){
    navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(stream=>{
      video.srcObject=stream;
      scanLoop();
    }).catch(err=>{
      console.error(err);
      output.textContent="‚ùå No se pudo acceder a la c√°mara.";
      output.className="error";
    });
  }

  function stopScan(){
    if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  }

  document.addEventListener('DOMContentLoaded',startScan);
})();
</script>
</body>
</html>