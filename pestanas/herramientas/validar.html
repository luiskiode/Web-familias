<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validar Credencial — Cáritas CNC</title>
  <link rel="stylesheet" href="styles-caritas.css">
  <base href="/Web-familias/">
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script type="module" src="api.js/health-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>
  <!-- QR scanner -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="api.js/supabase-config-caritas.js"></script>
</head>
<body>
  <header class="container" style="text-align:center;margin:1rem auto;">
    <h1>🪪 Validar Credencial</h1>
    <a href="index.html" class="btn-ghost">← Volver al inicio</a>
  </header>

  <main class="container card" style="max-width:500px;text-align:center;">
    <video id="video" autoplay playsinline muted style="width:100%;max-width:460px;background:#000;border:3px solid var(--primary);border-radius:10px;"></video>
    <p id="output" class="muted" style="margin-top:.5rem;">Apunta la cámara al QR de la credencial.</p>

    <section id="card" class="card" style="display:none;margin-top:1rem;">
      <img id="foto" class="foto" alt="Foto de la credencial" style="width:88px;height:88px;border-radius:50%;border:2px solid var(--primary);object-fit:cover;">
      <div><strong id="nombre">—</strong></div>
      <div id="email">—</div>
      <div>Código: <span id="codigo">—</span></div>
    </section>
  </main>

<script>
(() => {
  'use strict';
  const supabase = window.CARITAS?.supabase;
  const video = document.getElementById('video');
  const output = document.getElementById('output');
  const card = document.getElementById('card');
  const foto = document.getElementById('foto');
  const nombre = document.getElementById('nombre');
  const email = document.getElementById('email');
  const codigo = document.getElementById('codigo');

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d',{willReadFrequently:true});

  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  function parseQR(data){
    try{
      const url = new URL(data);
      const id = url.searchParams.get('id');
      if(id) return id;
    }catch{}
    try{
      const j = JSON.parse(data);
      if(j && j.user_id) return j.user_id;
    }catch{}
    return null;
  }

  async function cargarCredencial(uid){
    try{
      const { data, error } = await supabase
        .from('credenciales')
        .select('*')
        .eq('user_id', uid)
        .single();
      if(error || !data) throw error || new Error("No encontrada");

      foto.src = data.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre||'U')}&background=111&color=fff`;
      nombre.textContent = esc(data.nombre||"—");
      email.textContent = esc(data.email||"—");
      codigo.textContent = esc(data.codigo_verificacion||"N/A");
      card.style.display="block";
      output.textContent = "✅ Credencial válida";
      output.className = "success";
    }catch(e){
      console.error(e);
      card.style.display="none";
      output.textContent = "❌ Credencial no válida";
      output.className = "error";
    }
  }

  function scanLoop(){
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const img=ctx.getImageData(0,0,canvas.width,canvas.height);
      const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
      if(code){
        const uid=parseQR(code.data);
        if(uid){ cargarCredencial(uid); stopScan(); }
      }
    }
    requestAnimationFrame(scanLoop);
  }

  function startScan(){
    navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(stream=>{
      video.srcObject=stream;
      scanLoop();
    }).catch(err=>{
      console.error(err);
      output.textContent="❌ No se pudo acceder a la cámara.";
      output.className="error";
    });
  }

  function stopScan(){
    if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  }

  document.addEventListener('DOMContentLoaded',startScan);
})();
</script>
</body>
</html>