<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üë®‚Äçüë©‚Äçüëß Familias ‚Äî C√°ritas CNC</title>

  <!-- üîó Rutas absolutas para GitHub Pages -->
  <base href="/Web-familias/">
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <!-- üé® Estilos globales -->
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- üîí CSP compatible con ESM (sin unsafe-eval) -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://www.gstatic.com;
             style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <!-- ‚úÖ Supabase (ESM, sin eval). Si ya existe, lo reutiliza -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";

    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log("‚úÖ Supabase inicializado (familias-list).");
    } else {
      console.log("‚Ü©Ô∏è Reutilizando Supabase global existente.");
    }

    // Aviso para quien escuche (opcional)
    document.dispatchEvent(new Event("supabase:ready:caritas"));
  </script>
</head>
<body>
  <header class="container" style="text-align:center;margin:1rem auto;">
    <h1>üë®‚Äçüë©‚Äçüëß Familias registradas</h1>
    <a href="#inicio" class="btn-ghost">‚Üê Volver al inicio</a>
  </header>

  <main class="container">
    <div class="card" style="max-width:1100px;">
      <div id="msg" class="muted" aria-live="polite"></div>

      <table id="familiasTable" aria-label="Tabla de familias registradas">
        <thead>
          <tr>
            <th style="width:70px">ID</th>
            <th>Nombres</th>
            <th>Direcci√≥n</th>
            <th style="width:140px">Tel√©fono</th>
            <th style="width:110px">Visitada</th>
            <th style="width:120px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="muted">Cargando‚Ä¶</td></tr>
        </tbody>
      </table>

      <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap">
        <button id="prevPage" class="btn-ghost" type="button">‚èÆ Anterior</button>
        <button id="nextPage" class="btn-ghost" type="button">Siguiente ‚è≠</button>
        <button id="guardarCambios" class="btn" type="button">üíæ Guardar cambios</button>
      </div>
    </div>
  </main>

  <script>
  // familias-list ‚Äî funciona standalone y dentro de la SPA
  (function () {
    'use strict';

    let tablaBody, msg;
    let page = 0;
    const pageSize = 20;
    const cambios = new Map(); // id -> boolean visitada

    function esc(s = "") {
      return String(s).replace(/[&<>"']/g, m =>
        ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[m])
      );
    }

    function showMsg(text, type = "info") {
      if (!msg) return console.log(`[MSG:${type}]`, text);
      msg.textContent = text;
      msg.className = type;
      setTimeout(() => { msg.textContent = ""; msg.className = "muted"; }, 4000);
    }

    async function cargarFamilias() {
      const supabase = window.CARITAS?.supabase;
      if (!supabase) { showMsg("‚è≥ Esperando Supabase‚Ä¶", "muted"); return; }

      try {
        const start = page * pageSize;
        const end = start + pageSize - 1;

        // Esqueleto mientras carga
        if (tablaBody) tablaBody.innerHTML =
          "<tr><td colspan='6' class='muted'>Cargando‚Ä¶</td></tr>";

        const { data, error } = await supabase
          .from("familias")
          .select("*")
          .order("id", { ascending: true })
          .range(start, end);

        if (error) throw error;

        if (!data || data.length === 0) {
          tablaBody.innerHTML =
            "<tr><td colspan='6' class='muted'>Sin registros</td></tr>";
          return;
        }

        tablaBody.innerHTML = "";
        data.forEach(fam => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(fam.id)}</td>
            <td>${esc(fam.nombres_apellidos || "")}</td>
            <td>${esc(fam.direccion || "")}</td>
            <td>${esc(fam.telefono_contacto || "")}</td>
            <td style="text-align:center">
              <input type="checkbox" data-id="${fam.id}" ${fam.visitada ? "checked" : ""}>
            </td>
            <td>
              <button class="btn btn-del" data-del="${fam.id}" type="button">üóë Eliminar</button>
            </td>`;
          tablaBody.appendChild(tr);
        });

        showMsg("‚úÖ Familias cargadas", "success");
      } catch (err) {
        console.error("‚ùå Error al cargar familias:", err);
        if (tablaBody) tablaBody.innerHTML =
          "<tr><td colspan='6'>Error al cargar datos</td></tr>";
        showMsg("‚ùå Error al cargar familias", "error");
      }
    }

    async function guardarCambios() {
      const supabase = window.CARITAS?.supabase;
      if (!supabase) return showMsg("‚ùå Supabase no inicializado", "error");
      try {
        for (const [id, visitada] of cambios) {
          await supabase.from("familias").update({ visitada }).eq("id", id);
        }
        cambios.clear();
        showMsg("‚úÖ Cambios guardados", "success");
        cargarFamilias();
      } catch (err) {
        console.error(err);
        showMsg("‚ùå Error guardando cambios", "error");
      }
    }

    function wireEvents() {
      document.getElementById("guardarCambios")
        ?.addEventListener("click", guardarCambios);

      document.getElementById("prevPage")
        ?.addEventListener("click", () => { if (page > 0) { page--; cargarFamilias(); } });

      document.getElementById("nextPage")
        ?.addEventListener("click", () => { page++; cargarFamilias(); });

      // Cambios de visitada
      document.getElementById("familiasTable")
        ?.addEventListener("change", e => {
          if (e.target && e.target.type === "checkbox") {
            cambios.set(e.target.dataset.id, e.target.checked);
          }
        });

      // Eliminar
      document.getElementById("familiasTable")
        ?.addEventListener("click", async e => {
          const id = e.target && e.target.dataset ? e.target.dataset.del : null;
          if (!id) return;
          if (!confirm("¬øEliminar familia?")) return;

          const supabase = window.CARITAS?.supabase;
          if (!supabase) return showMsg("‚ùå Supabase no inicializado", "error");

          try {
            await supabase.from("familias").delete().eq("id", id);
            showMsg("üóëÔ∏è Familia eliminada", "success");
            cargarFamilias();
          } catch (err) {
            console.error(err);
            showMsg("‚ùå Error eliminando familia", "error");
          }
        });
    }

    // üöÄ Inicializador reutilizable: vale para SPA (router) o pesta√±a directa
    function initFamiliasView() {
      // Cache de elementos
      const tableEl = document.getElementById("familiasTable");
      tablaBody = tableEl ? tableEl.querySelector("tbody") : null;
      msg = document.getElementById("msg");

      if (!tablaBody) {
        console.warn("‚ö†Ô∏è No se encontr√≥ #familiasTable en el DOM.");
        return;
      }

      wireEvents();
      cargarFamilias();
    }

    // Exponer para el router (si inyecta esta vista mediante innerHTML)
    window.initFamiliasView = initFamiliasView;

    // Si se abre directamente el archivo, arrancar al cargar DOM
    if (document.readyState === "complete" || document.readyState === "interactive") {
      setTimeout(initFamiliasView, 0);
    } else {
      document.addEventListener("DOMContentLoaded", initFamiliasView);
    }
  })();
  </script>
</body>
</html>