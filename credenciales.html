
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé´ Credenciales ‚Äî C√°ritas CNC</title>
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- üîå Supabase bootstrap -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";

    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.dispatchEvent(new Event("supabase:ready:caritas"));
    }
  </script>

  <!-- üîê Firebase bootstrap -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5X6LUG_dOwuaUf6jQUHw_LM5PFgOmc40",
      authDomain: "web-familias.firebaseapp.com",
      projectId: "web-familias",
      storageBucket: "web-familias.appspot.com",
      messagingSenderId: "261699620792",
      appId: "1:261699620792:web:8ff59afb72e96c371dc94d"
    };

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence).catch(()=>{});

    window.CARITAS = window.CARITAS || {};
    window.CARITAS.auth = auth;

    document.dispatchEvent(new Event("firebase:ready:caritas"));
    onAuthStateChanged(auth, () => document.dispatchEvent(new Event("firebase:ready:caritas")));
  </script>

  <!-- ‚ùå Desactiva cualquier self-heal/health en esta p√°gina para evitar dobles inyecciones -->
  <!-- <script type="module" src="api.js/self-heal-caritas.js"></script> -->
  <!-- <script type="module" src="api.js/health-caritas.js"></script> -->
  <!-- <script defer src="api.js/error-overlay.js"></script> -->
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <button class="btn" id="btn-dl-png">Descargar PNG (frente+reverso)</button>
      <button class="btn" id="btn-save-layout">üìè Guardar layout</button>
      <button class="btn" id="btn-copy-link">üîó Copiar enlace p√∫blico</button>

      <a class="btn" href="index.html">‚Üê Volver</a>
    </div>
    <!-- Editor (solo en view=carnet) -->
<div id="editor" class="editor" style="display:none">
  <div class="row">
    <label>Nombre</label>
    <input id="edit-nombre" type="text" placeholder="Tu nombre" />
    <small id="edit-nombre-hint" class="muted">Se guarda autom√°ticamente</small>
  </div>
  <div class="row">
    <label>Foto de perfil</label>
    <input id="edit-foto" type="file" accept="image/*" />
    <small class="muted">JPG/PNG recomendados</small>
  </div>
</div>
    <div class="sheet" id="sheet">
      <!-- FRENTE -->
      <section class="card front" id="card-front" aria-label="Credencial frente">
        <img class="wm" src="assets/logo-caritas.png" alt="">
        <div class="photo"><img id="foto" alt="Foto"></div>
        <div class="brand-row">
        <img class="logo" src="assets/logo-caritas.png" alt="C√°ritas" />
          <div class="name" id="nombre">‚Äî</div>
        </div>
        <div class="role" id="rol">Voluntario C√°ritas CNC</div>
        <div class="stripes" aria-hidden="true"><span></span><span></span><span></span></div>
        <div class="band">C√ÅRITAS CNC</div>
      </section>

      <!-- REVERSO -->
      <section class="card back" id="card-back" aria-label="Credencial reverso">
        <img class="logo" src="assets/logo-caritas.png" alt="C√°ritas">
        <div class="scan">SCAN ME</div>
        <div class="qr-box"><canvas id="qr"></canvas></div>
        <div class="stripes" aria-hidden="true"><span></span><span></span><span></span></div>
        <div class="footer">C√ÅRITAS CNC</div>
      </section>
    </div>
  </div>
  <!-- Vista Admin -->
<section id="admin" style="display:none; width:100%; max-width:980px">
  <div class="controls" style="justify-content:space-between">
    <div>
      <input id="adm-q" type="search" placeholder="Buscar por nombre, email, UID o c√≥digo" style="padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;width:340px">
      <button class="btn" id="adm-reload">Buscar</button>
    </div>
    <div class="muted">Solo usuarios con rol que comience por <b>Admin</b></div>
  </div>
  <div style="overflow:auto;border:1px solid #2a2a2a;border-radius:12px">
    <table id="adm-table" style="width:100%; border-collapse:collapse">
      <thead>
        <tr style="background:#16161a">
          <th style="padding:10px;text-align:left">Nombre</th>
          <th style="padding:10px;text-align:left">Email</th>
          <th style="padding:10px;text-align:left">Rol</th>
          <th style="padding:10px;text-align:left">C√≥digo</th>
          <th style="padding:10px">Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

  <!-- Logo C√°ritas simple (SVG) -->
  <svg width="0" height="0" style="position:absolute">
    <symbol id="logo-caritas" viewBox="0 0 100 100" fill="currentColor">
      <rect x="45" y="10" width="10" height="80" rx="4"/><rect x="10" y="45" width="80" height="10" rx="4"/>
      <circle cx="20" cy="20" r="6"/><circle cx="80" cy="20" r="6"/><circle cx="20" cy="80" r="6"/><circle cx="80" cy="80" r="6"/>
    </symbol>
  </svg>

  <!-- L√≥gica: ESM, QR + Supabase + Firebase -->
 <script type="module">
  import * as QR from "https://esm.sh/qrcode@1.5.3";

  // Evita doble ejecuci√≥n si el HTML se eval√∫a otra vez
  if (window.__CRED_INIT__) {
    console.debug("CRED: ya inicializado");
  } else {
    window.__CRED_INIT__ = true;
    let lastCred = null;  // cache de la fila actual
    // ========== Helpers ==========
    const esc = (s="") =>
      String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const urlFromBase = (rel)=> new URL(rel, document.baseURI).href;
    // Dibuja el QR del tama√±o del contenedor .qr-box (2x para nitidez)
// QR robusto: respeta el tama√±o de .qr-box, re-render en resize
async function drawQR(canvasId, url){
  const el  = document.getElementById(canvasId);
  const box = el?.parentElement;
  if (!el || !box) return;

  const dpr = Math.max(2, Math.round(window.devicePixelRatio || 2));

  const render = () => {
    let w = box.getBoundingClientRect().width;          // px visibles
    if (!w) {
      // Fallback: leer --qr en mm y convertir a px (96dpi ‚âà 3.78 px/mm)
      const qrVar = getComputedStyle(document.documentElement).getPropertyValue('--qr').trim(); // ej. "34mm"
      const mm    = parseFloat(qrVar) || 34;
      w = mm * 3.7795;
    }
    const px = Math.max(80, Math.round(w * dpr));       // m√≠nimo 80px * dpr
    QR.toCanvas(el, url, { width: px, margin: 1 });
  };

  // Espera a layout estable
  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
  render();

  // Re-render si cambia el tama√±o del contenedor
  new ResizeObserver(() => render()).observe(box);
}
    // Esperas Firebase (debe estar bootstrapped en <head>)
    function waitForAuth(timeout=12000){
      if (window.CARITAS?.auth) return Promise.resolve(window.CARITAS.auth);
      const t0 = performance.now();
      return new Promise((resolve,reject)=>{
        const onReady = ()=>{ document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); };
        document.addEventListener('firebase:ready:caritas', onReady);
        const iv=setInterval(()=>{
          if (window.CARITAS?.auth){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); }
          if (performance.now()-t0>timeout){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); reject(new Error("Firebase no inicializado")); }
        },50);
      });
    }
    async function waitForUser(){
      const auth = await waitForAuth().catch(()=>null);
      return auth?.currentUser || await new Promise(r=>auth?.onAuthStateChanged?.(u=>r(u||null)));
    }

    // Supabase (expuesto en <head>)
    const supabase = window.CARITAS?.supabase;

    // ========== RPC ==========
    async function getPublicCred(uid){
      const { data, error } = await supabase.rpc("get_credencial_publica", { uid });
      if (error) throw error;
      return (Array.isArray(data) ? data[0] : data) || null;
    }
    async function upsertCred(uid, email, nombre, foto_url=null){
      const { data, error } = await supabase.rpc("upsert_mi_credencial", {
        uid, p_email: email, p_nombre: nombre, p_rol: "Voluntario C√°ritas CNC", p_foto: foto_url
      });
      if (error) throw error;
      return data;
    }

    // ========== Render (frente + reverso) ==========
    async function renderCarnet(user){
      const nombreBase = user?.displayName || (user?.email||"").split("@")[0] || "Usuario";

      // Leer; si no existe, crear sin pisar foto y volver a leer
      let data = await getPublicCred(user.uid).catch(()=>null);
      if (!data){
        await upsertCred(user.uid, user.email, nombreBase, null);
        data = await getPublicCred(user.uid).catch(()=>null);
      }
      if(!data){ alert("‚ùå No se pudo cargar el carnet"); return; }

      const nombre = data.nombre || nombreBase;
      lastCred = data;


      // Frente
      document.getElementById("nombre").textContent = esc(nombre);
      document.getElementById("rol").textContent    = esc(data.rol || "Voluntario C√°ritas CNC");
      document.getElementById("foto").src = data.foto_url
        || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;

      // Reverso (QR a vista p√∫blica)
      const qrUrl = urlFromBase(`credenciales.html?view=public&id=${user.uid}`);
      await drawQR("qr", qrUrl);
    }
    // ---------- util ----------
const toast = (t)=> alert(t);

// Auto-guardar nombre SIN perder foto
let saveNameTimer = null;
async function saveNombreAuto(user, nombre){
  const hint = document.getElementById("edit-nombre-hint");
  try{
    hint.textContent = "Guardando‚Ä¶";
    const foto = lastCred?.foto_url || null;
    await upsertCred(user.uid, user.email, nombre, foto); // enviamos nombre+foto actual
    lastCred = { ...(lastCred||{}), nombre };
    hint.textContent = "‚úÖ Guardado";
    await renderCarnet(user);
  }catch(e){
    console.error(e); hint.textContent = "‚ùå Error al guardar";
  }finally{
    setTimeout(()=>{ if(hint.textContent.startsWith("‚úÖ")) hint.textContent="Se guarda autom√°ticamente"; }, 1200);
  }
}

// Subir foto SIN perder nombre
async function saveFoto(user, file){
  const ext  = (file.name.split(".").pop() || "jpg").toLowerCase();
  const path = `credenciales/${user.uid}-${Date.now()}.${ext}`;
  const up = await supabase.storage.from("fotos").upload(path, file, { upsert:true });
  if (up.error) throw up.error;
  const { data: pub } = supabase.storage.from("fotos").getPublicUrl(path);
  const foto_url = pub.publicUrl;

  const nombre = (lastCred?.nombre || user.displayName || (user.email||"").split("@")[0] || "Usuario");
  await upsertCred(user.uid, user.email, nombre, foto_url); // enviamos nombre+foto nueva
  lastCred = { ...(lastCred||{}), foto_url, nombre };
  await renderCarnet(user);
  alert("‚úÖ Foto actualizada");
}

// ---------- ADMIN ----------
async function isAdmin(uid){
  const { data, error } = await supabase.rpc("is_admin", { uid });
  if (error) return false;
  return !!data;
}
async function loadAdmin(q=""){
  const { data, error } = await supabase.rpc("admin_list_credenciales", { p_search: q, p_limit: 100, p_offset: 0 });
  if (error) throw error;
  const tbody = document.querySelector("#adm-table tbody");
  tbody.innerHTML = "";
  (data||[]).forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:10px">${row.nombre||"‚Äî"}</td>
      <td style="padding:10px">${row.email||"‚Äî"}</td>
      <td style="padding:10px">${row.rol||"‚Äî"}</td>
      <td style="padding:10px;font-family:monospace">${row.codigo||"‚Äî"}</td>
      <td style="padding:10px;text-align:center">
        <a class="btn" href="credenciales.html?view=public&id=${row.user_id}">Ver</a>
      </td>`;
    tbody.appendChild(tr);
  });
}
    // ========== Descargar PNG (ESM/UMD robusto) ==========
    document.getElementById("btn-dl-png").addEventListener("click", async ()=>{
      let html2canvas;
      try {
        const mod = await import("https://esm.sh/html2canvas@1.4.1");
        html2canvas = (mod && (mod.default||mod));
      } catch {
        await import("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js");
        html2canvas = window.html2canvas;
      }
      if (typeof html2canvas !== "function") {
        alert("No se pudo cargar html2canvas"); return;
      }
      const node = document.getElementById("sheet");
      const canvas = await html2canvas(node, { backgroundColor: null, scale: 3, useCORS: true });
      const link = document.createElement('a');
      link.download = `credencial-cnc_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // ---------- ROUTER ----------
const params = new URLSearchParams(location.search);
const view = params.get("view");

if (view === "public"){
  const uid = params.get("id");
  const data = uid ? await getPublicCred(uid).catch(()=>null) : null;
  if(!data){ alert("‚ùå Credencial no encontrada"); location.href="index.html"; }
  else{
    const nombre = data?.nombre || "Voluntario";
    document.getElementById("nombre").textContent = esc(nombre);
    document.getElementById("rol").textContent    = esc(data?.rol || "Voluntario C√°ritas CNC");
    document.getElementById("foto").src = data?.foto_url
      || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;
    await drawQR("qr", new URL(`credenciales.html?view=public&id=${uid}`, document.baseURI).href);
    // Oculta editor
    document.getElementById("editor")?.style.setProperty("display","none");
    document.getElementById("admin")?.style.setProperty("display","none");
  }

} else if (view === "admin"){
  const user = await waitForUser();
  if (!user) { location.href="login.html"; }
  else if (!await isAdmin(user.uid)) { alert("Acceso solo para Admin"); location.href="index.html"; }
  else {
    // mostrar tabla y ocultar tarjeta/editor
    document.getElementById("sheet")?.style.setProperty("display","none");
    document.getElementById("editor")?.style.setProperty("display","none");
    document.getElementById("admin")?.style.setProperty("display","");
    await loadAdmin();

    document.getElementById("adm-reload").addEventListener("click", ()=> {
      const q = document.getElementById("adm-q").value.trim();
      loadAdmin(q);
    });
  }

} else { // view=carnet (por defecto)
  const user = await waitForUser();
  if (!user) { location.href="login.html"; }
  else {
    await renderCarnet(user);
    // mostrar editor
    const ed = document.getElementById("editor");
    ed && (ed.style.display = "");

    // auto-guardar nombre
    const inputNombre = document.getElementById("edit-nombre");
    if (inputNombre){
      inputNombre.value = document.getElementById("nombre").textContent.trim();
      inputNombre.addEventListener("input", ()=>{
        clearTimeout(saveNameTimer);
        const nombre = inputNombre.value.trim();
        saveNameTimer = setTimeout(()=> saveNombreAuto(user, nombre), 500);
      });
    }

    // subir foto
    const inputFoto = document.getElementById("edit-foto");
    inputFoto?.addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      try { await saveFoto(user, f); }
      catch(err){ console.error(err); alert("‚ùå No se pudo subir la foto"); }
      finally { e.target.value = ""; }
    });
  }
}
    
    // ========== Calibraci√≥n (flechas y +/-) ==========
    (function(){
      const root = document.documentElement;
      function loadLayout(){
        try{
          const cfg = JSON.parse(localStorage.getItem("cred:layout")||"{}");
          ["--cx","--cy","--d"].forEach(k=> cfg[k] && root.style.setProperty(k, cfg[k]));
        }catch{}
      }
      function saveLayout(){
        const cs = getComputedStyle(root);
        const cfg = {
          "--cx": cs.getPropertyValue("--cx").trim(),
          "--cy": cs.getPropertyValue("--cy").trim(),
          "--d" : cs.getPropertyValue("--d").trim()
        };
        localStorage.setItem("cred:layout", JSON.stringify(cfg));
        alert("üìè Layout guardado");
      }
      loadLayout();
      document.addEventListener("keydown",(e)=>{
        if (e.target && (e.target.tagName==="INPUT" || e.target.isContentEditable)) return;
        const cs = getComputedStyle(root);
        const num = v => parseFloat(String(v).replace("mm",""))||0;
        let cx = num(cs.getPropertyValue("--cx"));
        let cy = num(cs.getPropertyValue("--cy"));
        let d  = num(cs.getPropertyValue("--d"));
        const step = e.shiftKey ? 1 : .5;
        let used=false;
        switch(e.key){
          case "ArrowLeft":  cx -= step; used=true; break;
          case "ArrowRight": cx += step; used=true; break;
          case "ArrowUp":    cy -= step; used=true; break;
          case "ArrowDown":  cy += step; used=true; break;
          case "+": case "=": d += step; used=true; break;
          case "-":           d -= step; used=true; break;
        }
        if (!used) return;
        e.preventDefault();
        root.style.setProperty("--cx", cx+"mm");
        root.style.setProperty("--cy", cy+"mm");
        root.style.setProperty("--d" , Math.max(10, d)+"mm");
      });
      document.getElementById("btn-save-layout")?.addEventListener("click", saveLayout);
    })();

  } // __CRED_INIT__

  // Copiar mi enlace p√∫blico (carnet)
document.getElementById("btn-copy-link")?.addEventListener("click", ()=>{
  const user = window.CARITAS?.auth?.currentUser;
  if (!user) return alert("Debes iniciar sesi√≥n");
  const url = new URL(`credenciales.html?view=public&id=${user.uid}`, document.baseURI).href;
  navigator.clipboard.writeText(url).then(
    ()=> alert("‚úÖ Enlace copiado"),
    ()=> alert(url) // fallback simple si Clipboard falla
  );
});
</script>
</body>
</html>