
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎫 Credenciales — Cáritas CNC</title>

  <!-- 🛣️ Importante para GitHub Pages -->
  <base href="/Web-familias/">
  <link rel="stylesheet" href="styles-caritas.css">

  <!-- 🔒 CSP -->
  <meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
           script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://www.gstatic.com;
           style-src  'self' 'unsafe-inline' https://unpkg.com;
           img-src * data: blob:;
           connect-src *;
           font-src * data:;">

  <!-- 🛠 Diagnóstico (una sola vez) -->
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script type="module" src="api.js/health-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>

  <!-- ✅ Supabase -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";
    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.dispatchEvent(new Event("supabase:ready:caritas"));
    }
  </script>
</head>
<body>
  <h1 style="text-align:center;">🎫 Credenciales Cáritas CNC</h1>

  <!-- 📌 Carnet personal -->
  <section id="view-carnet" style="display:none;">
    <div class="perfil-card card" style="max-width:400px;margin:auto;">
      <div class="perfil-left">
        <img id="fotoCarnet" src="img/avatar-placeholder.png" alt="Foto de perfil">
      </div>
      <div class="perfil-center">
        <h2 id="nombreCarnet">—</h2>
        <p id="emailCarnet">—</p>
        <span id="rolCarnet" class="pill">Voluntario Cáritas CNC</span>
        <p class="codigo">Código: <span id="codigoCarnet">—</span></p>
        <div class="acciones">
          <button id="btnCopiar">🔗 Copiar enlace</button>
          <button id="btnDescargar">⬇️ Descargar QR</button>
          <button id="btnLogout">🔒 Cerrar sesión</button>
        </div>
      </div>
      <div class="perfil-right">
        <canvas id="qrCarnet" width="140" height="140"></canvas>
      </div>
    </div>
  </section>

  <!-- 📌 Credencial pública -->
  <section id="view-public" style="display:none;">
    <div class="perfil-card card" style="max-width:420px;margin:auto;">
      <div class="perfil-left">
        <img id="fotoPublic" src="img/avatar-placeholder.png" alt="Foto de perfil">
      </div>
      <div class="perfil-center">
        <h2 id="nombrePublic">—</h2>
        <p id="emailPublic">—</p>
        <span id="rolPublic" class="pill">—</span>
        <p class="codigo">Código: <span id="codigoPublic">—</span></p>
      </div>
      <div class="perfil-right">
        <canvas id="qrPublic" width="140" height="140"></canvas>
      </div>
    </div>
  </section>

  <!-- 📌 Admin listado -->
  <section id="view-admin" style="display:none;">
    <header class="container" style="text-align:center;margin:1rem auto;">
      <h2>🪪 Listado de credenciales</h2>
      <input class="search" id="q" type="search" placeholder="Buscar por nombre o email…" />
    </header>
    <main class="container">
      <div id="msgAdmin"></div>
      <div class="grid" id="grid"></div>
      <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;">
        <button id="prevPage" class="btn-ghost">⏮ Anterior</button>
        <button id="nextPage" class="btn-ghost">Siguiente ⏭</button>
      </div>
    </main>
  </section>

  <div id="msg" style="margin:1rem;text-align:center;"></div>
<!-- 🔐 Firebase ESM bootstrap: inicializa y expone window.CARITAS.auth en esta página -->
<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD5X6LUG_dOwuaUf6jQUHw_LM5PFgOmc40",
    authDomain: "web-familias.firebaseapp.com",
    projectId: "web-familias",
    storageBucket: "web-familias.appspot.com",
    messagingSenderId: "261699620792",
    appId: "1:261699620792:web:8ff59afb72e96c371dc94d"
  };

  const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence).catch(()=>{});

  window.CARITAS = window.CARITAS || {};
  window.CARITAS.auth = auth;

  // Notifica listo y re-notifica en cada cambio
  document.dispatchEvent(new Event("firebase:ready:caritas"));
  onAuthStateChanged(auth, () => document.dispatchEvent(new Event("firebase:ready:caritas")));
</script>
<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  const supabase = window.CARITAS?.supabase;
  const msgBox = document.getElementById("msg");
  const params = new URLSearchParams(location.search);
  const view = params.get("view");

  const showMsg = (t, type="info")=>{
    msgBox.textContent=t; msgBox.className=type;
    if(type!=="info") setTimeout(()=> msgBox.textContent="", 4000);
  };
  const esc = (s="") => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const urlFromBase = (rel)=> new URL(rel, document.baseURI).href;

  // Espera a que Firebase esté disponible aquí
  function waitForAuth(timeout=12000){
    return new Promise((resolve,reject)=>{
      if (window.CARITAS?.auth) return resolve(window.CARITAS.auth);
      const t0=performance.now();
      const onReady=()=>{ document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); };
      document.addEventListener('firebase:ready:caritas', onReady);
      const iv=setInterval(()=>{
        if (window.CARITAS?.auth){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); }
        if (performance.now()-t0>timeout){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(null); }
      }, 50);
    });
  }
  async function waitForUser(timeout=12000){
    const auth = await waitForAuth(timeout);
    if (!auth) return null;
    // onAuthStateChanged garantiza que espere a restaurar sesión
    return new Promise((resolve)=>{
      let settled=false;
      const off = auth.onAuthStateChanged(u=>{
        if (settled) return;
        settled=true; off();
        resolve(u || null);
      });
      // Fallback por si ya está resuelto
      setTimeout(()=>{ if(!settled){ settled=true; off(); resolve(auth.currentUser || null); } }, 1500);
    });
  }

  // Helpers RPC (igual que ya tenías)
  async function getPublicCred(uid){
    const { data, error } = await supabase.rpc("get_credencial_publica", { uid });
    if (error) { console.error(error); return null; }
    return data;
  }
  async function upsertCred(uid, email, nombre, foto_url=null){
    const { data, error } = await supabase.rpc("upsert_mi_credencial", {
      uid, p_email: email, p_nombre: nombre, p_rol: "Voluntario Cáritas CNC", p_foto: foto_url
    });
    if (error) { console.error(error); return null; }
    return data;
  }
  async function cargarCarnet(user){
    const nombreBase = user.displayName || (user.email||"").split("@")[0];
    await upsertCred(user.uid, user.email, nombreBase, null);
    const data = await getPublicCred(user.uid);
    if(!data){ showMsg("❌ No se pudo cargar el carnet","error"); return; }
    document.getElementById("nombreCarnet").textContent = esc(data.nombre);
    document.getElementById("emailCarnet").textContent  = esc(data.email);
    document.getElementById("rolCarnet").textContent    = esc(data.rol||"Voluntario Cáritas CNC");
    document.getElementById("codigoCarnet").textContent = esc(data.codigo_verificacion||"");
    document.getElementById("fotoCarnet").src = data.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre)}&background=111&color=fff`;
    // QR
    try{
      if (typeof QRCode === "undefined") { await import("https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"); }
      const qrUrl = urlFromBase(`credenciales.html?view=public&id=${user.uid}`);
      QRCode.toCanvas(document.getElementById("qrCarnet"), qrUrl);
    }catch{}
  }
  async function cargarPublica(uid){
    const data = await getPublicCred(uid);
    if(!data){ showMsg("❌ Credencial no encontrada","error"); return; }
    document.getElementById("nombrePublic").textContent = esc(data.nombre);
    document.getElementById("emailPublic").textContent  = esc(data.email);
    document.getElementById("rolPublic").textContent    = esc(data.rol||"Voluntario Cáritas CNC");
    document.getElementById("codigoPublic").textContent = esc(data.codigo_verificacion||"");
    document.getElementById("fotoPublic").src = data.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre)}&background=111&color=fff`;
  }

  // ---------- Router ----------
  if(view==="carnet"){
    document.getElementById("view-carnet").style.display="";
    const user = await waitForUser(12000);
    if(!user){ location.href = urlFromBase("login.html"); return; }
    await cargarCarnet(user);
    // botones
    const auth = window.CARITAS.auth;
    document.getElementById("btnCopiar").onclick=()=>{
      const uid=auth?.currentUser?.uid;
      if(!uid) return showMsg("❌ No hay usuario","error");
      navigator.clipboard.writeText(urlFromBase(`credenciales.html?view=public&id=${uid}`)).then(()=> showMsg("🔗 Enlace copiado","success"));
    };
    document.getElementById("btnDescargar").onclick=()=>{
      const link=document.createElement("a");
      link.download="credencial-qr.png";
      link.href=document.getElementById("qrCarnet").toDataURL("image/png");
      link.click();
    };
    document.getElementById("btnLogout").onclick=()=>{ auth?.signOut?.(); localStorage.removeItem("caritasUser"); location.href=urlFromBase("login.html"); };
  }
  else if(view==="public"){
    document.getElementById("view-public").style.display="";
    const uid=params.get("id");
    if(uid) cargarPublica(uid);
    else showMsg("❌ Falta parámetro id","error");
  }
  else if(view==="admin"){
    // tu bloque admin tal cual…
  } else {
    location.href = urlFromBase("index.html");
  }
});
</script>
</body>
</html>