
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé´ Credenciales ‚Äî C√°ritas CNC</title>

  <!-- üõ£Ô∏è Importante para GitHub Pages -->
  <base href="/Web-familias/">
  <link rel="stylesheet" href="styles-caritas.css">

  <!-- üîí CSP -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://esm.sh;
             style-src  'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <!-- üõ† Diagn√≥stico (una sola vez) -->
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script type="module" src="api.js/health-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>

  <!-- ‚úÖ Supabase -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";
    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.dispatchEvent(new Event("supabase:ready:caritas"));
    }
  </script>
</head>
<body>
  <h1 style="text-align:center;">üé´ Credenciales C√°ritas CNC</h1>

  <!-- üìå Carnet personal -->
  <section id="view-carnet" style="display:none;">
    <div class="perfil-card card" style="max-width:400px;margin:auto;">
      <div class="perfil-left">
        <img id="fotoCarnet" src="img/avatar-placeholder.png" alt="Foto de perfil">
      </div>
      <div class="perfil-center">
        <h2 id="nombreCarnet">‚Äî</h2>
        <p id="emailCarnet">‚Äî</p>
        <span id="rolCarnet" class="pill">Voluntario C√°ritas CNC</span>
        <p class="codigo">C√≥digo: <span id="codigoCarnet">‚Äî</span></p>
        <div class="acciones">
          <button id="btnCopiar">üîó Copiar enlace</button>
          <button id="btnDescargar">‚¨áÔ∏è Descargar QR</button>
          <button id="btnLogout">üîí Cerrar sesi√≥n</button>
        </div>
      </div>
      <div class="perfil-right">
        <canvas id="qrCarnet" width="140" height="140"></canvas>
      </div>
    </div>
  </section>

  <!-- üìå Credencial p√∫blica -->
  <section id="view-public" style="display:none;">
    <div class="perfil-card card" style="max-width:420px;margin:auto;">
      <div class="perfil-left">
        <img id="fotoPublic" src="img/avatar-placeholder.png" alt="Foto de perfil">
      </div>
      <div class="perfil-center">
        <h2 id="nombrePublic">‚Äî</h2>
        <p id="emailPublic">‚Äî</p>
        <span id="rolPublic" class="pill">‚Äî</span>
        <p class="codigo">C√≥digo: <span id="codigoPublic">‚Äî</span></p>
      </div>
      <div class="perfil-right">
        <canvas id="qrPublic" width="140" height="140"></canvas>
      </div>
    </div>
  </section>

  <!-- üìå Admin listado -->
  <section id="view-admin" style="display:none;">
    <header class="container" style="text-align:center;margin:1rem auto;">
      <h2>ü™™ Listado de credenciales</h2>
      <input class="search" id="q" type="search" placeholder="Buscar por nombre o email‚Ä¶" />
    </header>
    <main class="container">
      <div id="msgAdmin"></div>
      <div class="grid" id="grid"></div>
      <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;">
        <button id="prevPage" class="btn-ghost">‚èÆ Anterior</button>
        <button id="nextPage" class="btn-ghost">Siguiente ‚è≠</button>
      </div>
    </main>
  </section>

  <div id="msg" style="margin:1rem;text-align:center;"></div>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  const supabase = window.CARITAS?.supabase;
  const msgBox = document.getElementById("msg");
  const params = new URLSearchParams(location.search);
  const view = params.get("view");

  // Esperar Firebase Auth (si est√° disponible)
  function waitForAuth(timeout=8000){
    return new Promise((resolve,reject)=>{
      if (window.CARITAS?.auth) return resolve(window.CARITAS.auth);
      const t0=performance.now();
      const onReady=()=>{ document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); };
      document.addEventListener('firebase:ready:caritas', onReady);
      const iv=setInterval(()=>{
        if (window.CARITAS?.auth){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); }
        if (performance.now()-t0>timeout){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(null); } // no bloquea
      }, 50);
    });
  }

  const showMsg = (t, type="info")=>{
    msgBox.textContent=t; msgBox.className=type;
    if(type!=="info") setTimeout(()=> msgBox.textContent="", 4000);
  };
  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );
  const urlFromBase = (rel)=> new URL(rel, document.baseURI).href;

  // Asegurar QRCode (fallback)
  if (typeof QRCode === "undefined") {
    try { await import("https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"); }
    catch(e){ console.warn("No se pudo cargar QRCode:", e); }
  }

  // ---------- RPC helpers
  async function getPublicCred(uid){
    const { data, error } = await supabase.rpc("get_credencial_publica", { uid });
    if (error) { console.error(error); return null; }
    return data;
  }
  async function upsertCred(uid, email, nombre, foto_url=null){
    const { data, error } = await supabase.rpc("upsert_mi_credencial", {
      uid, p_email: email, p_nombre: nombre,
      p_rol: "Voluntario C√°ritas CNC", p_foto: foto_url
    });
    if (error) { console.error(error); return null; }
    return data;
  }

  // ---------- Carnet personal (usa RPC, no upsert directo a tabla)
  async function cargarCarnet(user){
    // Asegura existencia m√≠nima
    const nombreBase = user.displayName || (user.email||"").split("@")[0];
    await upsertCred(user.uid, user.email, nombreBase, null);
    const data = await getPublicCred(user.uid);
    if(!data){ showMsg("‚ùå No se pudo cargar el carnet","error"); return; }

    document.getElementById("nombreCarnet").textContent = esc(data.nombre);
    document.getElementById("emailCarnet").textContent  = esc(data.email);
    document.getElementById("rolCarnet").textContent    = esc(data.rol||"Voluntario C√°ritas CNC");
    document.getElementById("codigoCarnet").textContent = esc(data.codigo_verificacion||"");
    document.getElementById("fotoCarnet").src = data.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre)}&background=111&color=fff`;

    const qrUrl = urlFromBase(`credenciales.html?view=public&id=${user.uid}`);
    if (window.QRCode) QRCode.toCanvas(document.getElementById("qrCarnet"), qrUrl);
  }

  // ---------- Credencial p√∫blica (RPC)
  async function cargarPublica(uid){
    const data = await getPublicCred(uid);
    if(!data){ showMsg("‚ùå Credencial no encontrada","error"); return; }
    document.getElementById("nombrePublic").textContent = esc(data.nombre);
    document.getElementById("emailPublic").textContent  = esc(data.email);
    document.getElementById("rolPublic").textContent    = esc(data.rol||"Voluntario C√°ritas CNC");
    document.getElementById("codigoPublic").textContent = esc(data.codigo_verificacion||"");
    document.getElementById("fotoPublic").src = data.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre)}&background=111&color=fff`;
    const qrUrl = urlFromBase(`credenciales.html?view=public&id=${uid}`);
    if (window.QRCode) QRCode.toCanvas(document.getElementById("qrPublic"), qrUrl);
  }

  // ---------- Admin listado (RPC list_credenciales_admin)
  let page=0, pageSize=20, lastQ="";
  async function getCredencialesAdmin(q){
    const { data, error } = await supabase.rpc("list_credenciales_admin", {
      p_page: page, p_size: pageSize, p_q: q || null
    });
    if (error) { console.error(error); return []; }
    return data || [];
  }
  async function renderCredenciales(){
    const grid=document.getElementById("grid");
    const lista=await getCredencialesAdmin(lastQ);
    grid.innerHTML="";
    if(lista.length===0){ grid.innerHTML="<p>No hay credenciales.</p>"; return; }
    lista.forEach(c=>{
      const el=document.createElement("article");
      el.className="card";
      el.innerHTML=`
        <div class="row">
          <img class="foto" src="${c.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.nombre)}&background=004aad&color=fff`}" alt="Foto de ${esc(c.nombre)}">
          <div>
            <strong>${esc(c.nombre)}</strong>
            <div class="muted">${esc(c.email)}</div>
            <div class="muted">C√≥digo: ${esc(c.codigo_verificacion||"")}</div>
          </div>
        </div>
        <div style="margin-top:10px;">
          <a class="btn" href="${urlFromBase(`credenciales.html?view=public&id=${encodeURIComponent(c.user_id)}`)}" target="_blank">Ver</a>
        </div>`;
      grid.appendChild(el);
    });
  }

  // ---------- Router por ?view=
  const auth = await waitForAuth();

  if(view==="carnet"){
    document.getElementById("view-carnet").style.display="";
    if(!auth?.currentUser){
      // escucha login y luego carga carnet
      auth?.onAuthStateChanged?.(u=>{
        if(!u){ location.href = urlFromBase("login.html"); return; }
        cargarCarnet(u);
      });
      if (!auth) location.href = urlFromBase("login.html");
    } else {
      cargarCarnet(auth.currentUser);
    }
    document.getElementById("btnCopiar").onclick=()=>{
      const uid=auth?.currentUser?.uid;
      if(!uid) return showMsg("‚ùå No hay usuario","error");
      navigator.clipboard.writeText(urlFromBase(`credenciales.html?view=public&id=${uid}`)).then(()=> showMsg("üîó Enlace copiado","success"));
    };
    document.getElementById("btnDescargar").onclick=()=>{
      const link=document.createElement("a");
      link.download="credencial-qr.png";
      link.href=document.getElementById("qrCarnet").toDataURL("image/png");
      link.click();
    };
    document.getElementById("btnLogout").onclick=()=>{ auth?.signOut?.(); localStorage.removeItem("caritasUser"); location.href=urlFromBase("login.html"); };
  }
  else if(view==="public"){
    document.getElementById("view-public").style.display="";
    const uid=params.get("id");
    if(uid) cargarPublica(uid);
    else showMsg("‚ùå Falta par√°metro id","error");
  }
  else if(view==="admin"){
    document.getElementById("view-admin").style.display="";
    const user=JSON.parse(localStorage.getItem("caritasUser")||"{}");
    if(!["Administrador","admin","editor"].includes(user.rol)){
      showMsg("‚ùå No tienes permiso para ver esta secci√≥n","error");
      setTimeout(()=> location.href=urlFromBase("index.html"),2000);
    }else{
      renderCredenciales();
      document.getElementById("prevPage").onclick=()=>{ if(page>0){page--;renderCredenciales();} };
      document.getElementById("nextPage").onclick=()=>{ page++;renderCredenciales(); };
      document.getElementById("q").oninput=e=>{ lastQ=e.target.value.trim(); renderCredenciales(); };
    }
  } else {
    location.href = urlFromBase("index.html");
  }
});
</script>
</body>
</html>