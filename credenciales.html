
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé´ Credenciales ‚Äî C√°ritas CNC</title>

  <!-- üõ£Ô∏è Importante para GitHub Pages -->
  <base href="/Web-familias/">
  <link rel="stylesheet" href="styles-caritas.css">
  <style>
  /* Asegura contraste en la tarjeta del carnet */
  .perfil-card, .perfil-card h2, .perfil-card p, .perfil-card .codigo, .perfil-card .codigo span {
    color: #fff !important;
  }
</style>
  <!-- üîí CSP -->
  <meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
           script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://www.gstatic.com;
           style-src  'self' 'unsafe-inline' https://unpkg.com;
           img-src * data: blob:;
           connect-src *;
           font-src * data:;">

  <!-- üõ† Diagn√≥stico (una sola vez) -->
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script type="module" src="api.js/health-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>

  <!-- ‚úÖ Supabase -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";
    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.dispatchEvent(new Event("supabase:ready:caritas"));
    }
  </script>
</head>
<body>
  <h1 style="text-align:center;">üé´ Credenciales C√°ritas CNC</h1>

  <!-- üìå Carnet personal -->
  <section id="view-carnet" style="display:none;">
    <div class="perfil-card card" style="max-width:400px;margin:auto;">
      <div class="perfil-left">
        <img id="fotoCarnet" src="img/avatar-placeholder.png" alt="Foto de perfil">
      </div>
      <div class="perfil-center">
        <h2 id="nombreCarnet">‚Äî</h2>
        <p id="emailCarnet">‚Äî</p>
        <span id="rolCarnet" class="pill">Voluntario C√°ritas CNC</span>
        <p class="codigo">C√≥digo: <span id="codigoCarnet">‚Äî</span></p>
        <div class="acciones">
          <button id="btnCopiar">üîó Copiar enlace</button>
          <button id="btnDescargar">‚¨áÔ∏è Descargar QR</button>
          <button id="btnLogout">üîí Cerrar sesi√≥n</button>
        </div>
      </div>
      <div class="perfil-right">
        <canvas id="qrCarnet" width="140" height="140"></canvas>
      </div>
    </div>
  </section>

  <!-- üìå Credencial p√∫blica -->
  <section id="view-public" style="display:none;">
    <div class="perfil-card card" style="max-width:420px;margin:auto;">
      <div class="perfil-left">
        <img id="fotoPublic" src="img/avatar-placeholder.png" alt="Foto de perfil">
      </div>
      <div class="perfil-center">
        <h2 id="nombrePublic">‚Äî</h2>
        <p id="emailPublic">‚Äî</p>
        <span id="rolPublic" class="pill">‚Äî</span>
        <p class="codigo">C√≥digo: <span id="codigoPublic">‚Äî</span></p>
      </div>
      <div class="perfil-right">
        <canvas id="qrPublic" width="140" height="140"></canvas>
      </div>
    </div>
  </section>

  <!-- üìå Admin listado -->
  <section id="view-admin" style="display:none;">
    <header class="container" style="text-align:center;margin:1rem auto;">
      <h2>ü™™ Listado de credenciales</h2>
      <input class="search" id="q" type="search" placeholder="Buscar por nombre o email‚Ä¶" />
    </header>
    <main class="container">
      <div id="msgAdmin"></div>
      <div class="grid" id="grid"></div>
      <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;">
        <button id="prevPage" class="btn-ghost">‚èÆ Anterior</button>
        <button id="nextPage" class="btn-ghost">Siguiente ‚è≠</button>
      </div>
    </main>
  </section>

  <div id="msg" style="margin:1rem;text-align:center;"></div>
<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  "use strict";

  // -------- helpers b√°sicos --------
  const msgBox = document.getElementById("msg");
  const params = new URLSearchParams(location.search);
  const view = params.get("view");

  const showMsg = (t, type="info")=>{
    if (!msgBox) return;
    msgBox.textContent=t; msgBox.className=type;
    if(type!=="info") setTimeout(()=> msgBox.textContent="", 4000);
  };
  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );
  const urlFromBase = (rel)=> new URL(rel, document.baseURI).href;

  // -------- esperas robustas --------
  async function waitForSupabase(timeout=8000){
    if (window.CARITAS?.supabase) return window.CARITAS.supabase;
    const t0 = performance.now();
    return new Promise((resolve,reject)=>{
      const onReady = ()=>{ document.removeEventListener("supabase:ready:caritas", onReady); resolve(window.CARITAS.supabase); };
      document.addEventListener("supabase:ready:caritas", onReady);
      const iv = setInterval(()=>{
        if (window.CARITAS?.supabase){ clearInterval(iv); document.removeEventListener("supabase:ready:caritas", onReady); resolve(window.CARITAS.supabase); }
        if (performance.now()-t0 > timeout){ clearInterval(iv); document.removeEventListener("supabase:ready:caritas", onReady); reject(new Error("Supabase no inicializado")); }
      },50);
    });
  }

  function waitForAuth(timeout=12000){
    if (window.CARITAS?.auth) return Promise.resolve(window.CARITAS.auth);
    const t0=performance.now();
    return new Promise((resolve,reject)=>{
      const onReady=()=>{ document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); };
      document.addEventListener('firebase:ready:caritas', onReady);
      const iv=setInterval(()=>{
        if (window.CARITAS?.auth){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); }
        if (performance.now()-t0>timeout){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); reject(new Error("Firebase no inicializado")); }
      }, 50);
    });
  }

  async function waitForUser(timeout=12000){
    const auth = await waitForAuth(timeout).catch(()=>null);
    if (!auth) return null;
    return new Promise((resolve)=>{
      let settled=false;
      const off = auth.onAuthStateChanged(u=>{
        if (settled) return;
        settled=true; off();
        resolve(u || null);
      });
      // fallback r√°pido si ya est√° resuelto el usuario
      setTimeout(()=>{ if(!settled){ settled=true; off(); resolve(auth.currentUser || null); } }, 1500);
    });
  }

  const supabase = await waitForSupabase().catch(err=>{ console.error(err); showMsg("‚ùå Supabase no inicializado","error"); });

  // -------- RPC helpers --------
  async function getPublicCred(uid){
    const { data, error } = await supabase.rpc("get_credencial_publica", { uid });
    if (error) { console.error(error); return null; }
    return data;
  }

  async function upsertCred(uid, email, nombre, foto_url=null){
    const { data, error } = await supabase.rpc("upsert_mi_credencial", {
      uid, p_email: email, p_nombre: nombre,
      p_rol: "Voluntario C√°ritas CNC",
      p_foto: foto_url
    });
    if (error) { console.error(error); return null; }
    return data;
  }

  // -------- carnet personal --------
  async function cargarCarnet(user){
    const nombreBase = user?.displayName || (user?.email || "").split("@")[0] || "Usuario";

    // Asegura existencia (si ya existe, no falla)
    try { await upsertCred(user.uid, user.email, nombreBase, null); } catch(e){ console.warn(e); }

    // Lee la credencial p√∫blica
    let data = null;
    try { data = await getPublicCred(user.uid); } catch(e){ console.error(e); }
    if(!data){ showMsg("‚ùå No se pudo cargar el carnet","error"); return; }

    // Fallbacks visibles
    const nombre = data.nombre || nombreBase;
    const email  = data.email  || user.email || "";
    const codigo = (data.codigo_verificacion && data.codigo_verificacion.trim())
                    ? data.codigo_verificacion
                    : (user.uid || "").substring(0,8).toUpperCase();

    // Si faltaba c√≥digo/nombre/email en BD, lo persistimos ahora
    if (!data.codigo_verificacion || data.nombre !== nombre || data.email !== email) {
      try { await upsertCred(user.uid, email, nombre, data.foto_url || null); } catch(e){ console.warn(e); }
      data = { ...data, nombre, email, codigo_verificacion: codigo };
    }

    // Pintar UI
    document.getElementById("nombreCarnet").textContent = esc(nombre);
    document.getElementById("emailCarnet").textContent  = esc(email);
    document.getElementById("rolCarnet").textContent    = esc(data.rol || "Voluntario C√°ritas CNC");
    document.getElementById("codigoCarnet").textContent = esc(codigo);
    document.getElementById("fotoCarnet").src = data.foto_url
      || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;

    // QR
    try{
      if (typeof QRCode === "undefined") {
        await import("https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js");
      }
      const qrUrl = urlFromBase(`credenciales.html?view=public&id=${user.uid}`);
      await QRCode.toCanvas(document.getElementById("qrCarnet"), qrUrl);
    }catch(err){
      console.warn("QR no disponible:", err);
    }
  }

  // -------- vista p√∫blica --------
  async function cargarPublica(uid){
    const data = await getPublicCred(uid);
    if(!data){ showMsg("‚ùå Credencial no encontrada","error"); return; }

    document.getElementById("nombrePublic").textContent = esc(data.nombre || "‚Äî");
    document.getElementById("emailPublic").textContent  = esc(data.email  || "‚Äî");
    document.getElementById("rolPublic").textContent    = esc(data.rol   || "Voluntario C√°ritas CNC");
    document.getElementById("codigoPublic").textContent = esc(data.codigo_verificacion || "‚Äî");
    document.getElementById("fotoPublic").src = data.foto_url
      || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre||"Usuario")}&background=111&color=fff`;

    // (opcional) QR de la vista p√∫blica
    try{
      if (typeof QRCode === "undefined") {
        await import("https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js");
      }
      const qrUrl = urlFromBase(`credenciales.html?view=public&id=${uid}`);
      await QRCode.toCanvas(document.getElementById("qrPublic"), qrUrl);
    }catch{}
  }

  // -------- Router --------
  if(view==="carnet"){
    document.getElementById("view-carnet").style.display="";
    const user = await waitForUser(12000);
    if(!user){ location.href = urlFromBase("login.html"); return; }
    await cargarCarnet(user);

    // botones
    const auth = window.CARITAS.auth;
    document.getElementById("btnCopiar").onclick=()=>{
      const uid=auth?.currentUser?.uid;
      if(!uid) return showMsg("‚ùå No hay usuario","error");
      navigator.clipboard
        .writeText(urlFromBase(`credenciales.html?view=public&id=${uid}`))
        .then(()=> showMsg("üîó Enlace copiado","success"));
    };
    document.getElementById("btnDescargar").onclick=()=>{
      const link=document.createElement("a");
      link.download="credencial-qr.png";
      link.href=document.getElementById("qrCarnet").toDataURL("image/png");
      link.click();
    };
    document.getElementById("btnLogout").onclick=()=>{
      auth?.signOut?.();
      localStorage.removeItem("caritasUser");
      location.href=urlFromBase("login.html");
    };
  }
  else if(view==="public"){
    document.getElementById("view-public").style.display="";
    const uid=params.get("id");
    if(uid) cargarPublica(uid);
    else showMsg("‚ùå Falta par√°metro id","error");
  }
  else if(view==="admin"){
    // TODO: aqu√≠ puedes insertar tu render de admin usando la RPC list_credenciales_admin
    showMsg("Vista admin en construcci√≥n","info");
  } else {
    location.href = urlFromBase("index.html");
  }
});
</script>
</body>
</html>