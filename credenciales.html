
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé´ Credenciales ‚Äî C√°ritas CNC</title>
  

  <!-- <script type="module" src="api.js/self-heal-caritas.js"></script> -->
<!-- <script type="module" src="api.js/health-caritas.js"></script> -->
<!-- <script defer src="api.js/error-overlay.js"></script> -->
 
  <script type="module">
  import * as QR from "https://esm.sh/qrcode@1.5.3";

  // Evitar doble inicializaci√≥n si el HTML se vuelve a evaluar
  if (window.__CRED_INIT__) {
    console.debug("CRED: m√≥dulo ya inicializado, se omite duplicado.");
  } else {
    window.__CRED_INIT__ = true;

    // ===== Helpers =====
    const esc = (s = "") =>
      String(s).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    const urlFromBase = (rel)=> new URL(rel, document.baseURI).href;

    // Esperas Firebase (ya lo inicializas en el <head>)
    function waitForAuth(timeout=12000){
      if (window.CARITAS?.auth) return Promise.resolve(window.CARITAS.auth);
      const t0=performance.now();
      return new Promise((resolve,reject)=>{
        const onReady=()=>{ document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); };
        document.addEventListener('firebase:ready:caritas', onReady);
        const iv=setInterval(()=>{
          if (window.CARITAS?.auth){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); }
          if (performance.now()-t0>timeout){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); reject(new Error("Firebase no inicializado")); }
        },50);
      });
    }
    async function waitForUser(){
      const auth = await waitForAuth();
      return auth?.currentUser || await new Promise(r=>auth?.onAuthStateChanged?.(u=>r(u||null)));
    }

    // Supabase (lo expusiste en el bloque del <head>)
    const supabase = window.CARITAS?.supabase;

    // ===== RPC helpers =====
    async function getPublicCred(uid){
      const { data, error } = await supabase.rpc("get_credencial_publica", { uid });
      if (error) throw error;
      return (Array.isArray(data) ? data[0] : data) || null; // <- fila √∫nica
    }
    async function upsertCred(uid, email, nombre, foto_url=null){
      const { data, error } = await supabase.rpc("upsert_mi_credencial", {
        uid, p_email: email, p_nombre: nombre, p_rol: "Voluntario C√°ritas CNC", p_foto: foto_url
      });
      if (error) throw error;
      return data;
    }

    // ===== Render carnet (frente + reverso) =====
    async function drawCarnet(user){
      const nombreBase = user?.displayName || (user?.email||"").split("@")[0] || "Usuario";

      // 1) Leer
      let data = await getPublicCred(user.uid).catch(()=>null);
      // 2) Si no existe, crear sin pisar foto
      if (!data){
        await upsertCred(user.uid, user.email, nombreBase, null);
        data = await getPublicCred(user.uid).catch(()=>null);
      }
      if(!data){ alert("‚ùå No se pudo cargar el carnet"); return; }

      const nombre = data.nombre || nombreBase;

      // Frente
      document.getElementById("nombre").textContent = esc(nombre);
      document.getElementById("rol").textContent    = esc(data.rol || "Voluntario C√°ritas CNC");
      document.getElementById("foto").src = data.foto_url
        || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;

      // Reverso (QR apunta a la vista p√∫blica)
      const qrUrl = urlFromBase(`credenciales.html?view=public&id=${user.uid}`);
      await QR.toCanvas(document.getElementById("qr"), qrUrl, { width:260, margin:1 });
    }

    // ===== Descargar PNG (ambas caras) =====
    document.getElementById("btn-dl-png").addEventListener("click", async ()=>{
      const { default: html2canvas } = await import("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js");
      const node = document.getElementById("sheet");
      const canvas = await html2canvas(node, { backgroundColor: null, scale: 3, useCORS: true });
      const link = document.createElement('a');
      link.download = `credencial-cnc_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // ===== Router (view=carnet / public) =====
    const params = new URLSearchParams(location.search);
    const view = params.get("view");
    if (view === "public"){
      const uid = params.get("id");
      const data = uid ? await getPublicCred(uid).catch(()=>null) : null;
      if(!data){ alert("‚ùå No se pudo cargar la credencial p√∫blica"); }
      const nombre = data?.nombre || "Voluntario";
      document.getElementById("nombre").textContent = esc(nombre);
      document.getElementById("rol").textContent    = esc(data?.rol || "Voluntario C√°ritas CNC");
      document.getElementById("foto").src = data?.foto_url
        || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;
      await QR.toCanvas(document.getElementById("qr"), urlFromBase(`credenciales.html?view=public&id=${uid}`), { width:260, margin:1 });
    } else {
      const user = await waitForUser();
      if (!user) { location.href="login.html"; }
      else { await drawCarnet(user); }  // <- nuevo nombre
    }

    // ===== Calibraci√≥n: teclas + guardado =====
    (function(){
      const root = document.documentElement;
      function loadLayout(){
        try{
          const cfg = JSON.parse(localStorage.getItem("cred:layout")||"{}");
          ["--cx","--cy","--d"].forEach(k=> cfg[k] && root.style.setProperty(k, cfg[k]));
        }catch{}
      }
      function saveLayout(){
        const cs = getComputedStyle(root);
        const cfg = {
          "--cx": cs.getPropertyValue("--cx").trim(),
          "--cy": cs.getPropertyValue("--cy").trim(),
          "--d" : cs.getPropertyValue("--d").trim()
        };
        localStorage.setItem("cred:layout", JSON.stringify(cfg));
        alert("üìè Layout guardado");
      }
      loadLayout();
      document.addEventListener("keydown",(e)=>{
        if (e.target && (e.target.tagName==="INPUT" || e.target.isContentEditable)) return;
        const cs = getComputedStyle(root);
        const num = v => parseFloat(String(v).replace("mm",""))||0;
        let cx = num(cs.getPropertyValue("--cx"));
        let cy = num(cs.getPropertyValue("--cy"));
        let d  = num(cs.getPropertyValue("--d"));
        const step = e.shiftKey ? 1 : .5;
        let used=false;
        switch(e.key){
          case "ArrowLeft":  cx -= step; used=true; break;
          case "ArrowRight": cx += step; used=true; break;
          case "ArrowUp":    cy -= step; used=true; break;
          case "ArrowDown":  cy += step; used=true; break;
          case "+": case "=": case "NumpadAdd": d += step; used=true; break;
          case "-": case "NumpadSubtract": d -= step; used=true; break;
        }
        if (!used) return;
        e.preventDefault();
        root.style.setProperty("--cx", cx+"mm");
        root.style.setProperty("--cy", cy+"mm");
        root.style.setProperty("--d" , Math.max(10, d)+"mm");
      });
      document.getElementById("btn-save-layout")?.addEventListener("click", saveLayout);
    })();

  }
</script>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <button class="btn" id="btn-dl-png">Descargar PNG (frente+reverso)</button>
      <button class="btn" id="btn-save-layout">üìè Guardar layout</button>
      <a class="btn" href="index.html">‚Üê Volver</a>
    </div>

    <div class="sheet" id="sheet">
      <!-- FRENTE -->
      <section class="card front" id="card-front" aria-label="Credencial frente">
        <svg class="wm" viewBox="0 0 100 100" aria-hidden="true"><use href="#logo-caritas"></use></svg>
        <div class="photo"><img id="foto" alt="Foto"></div>
        <div class="brand-row">
          <svg class="logo" viewBox="0 0 100 100" aria-hidden="true"><use href="#logo-caritas"></use></svg>
          <div class="name" id="nombre">‚Äî</div>
        </div>
        <div class="role" id="rol">Voluntario C√°ritas CNC</div>
        <div class="stripes" aria-hidden="true"><span></span><span></span><span></span></div>
        <div class="band">C√ÅRITAS CNC</div>
      </section>

      <!-- REVERSO -->
      <section class="card back" id="card-back" aria-label="Credencial reverso">
        <svg class="wm" viewBox="0 0 100 100" aria-hidden="true"><use href="#logo-caritas"></use></svg>
        <div class="scan">SCAN ME</div>
        <div class="qr-box"><canvas id="qr"></canvas></div>
        <div class="stripes" aria-hidden="true"><span></span><span></span><span></span></div>
        <div class="footer">C√ÅRITAS CNC</div>
      </section>
    </div>
  </div>

  <!-- Logo C√°ritas simple (SVG) -->
  <svg width="0" height="0" style="position:absolute">
    <symbol id="logo-caritas" viewBox="0 0 100 100" fill="currentColor">
      <rect x="45" y="10" width="10" height="80" rx="4"/><rect x="10" y="45" width="80" height="10" rx="4"/>
      <circle cx="20" cy="20" r="6"/><circle cx="80" cy="20" r="6"/><circle cx="20" cy="80" r="6"/><circle cx="80" cy="80" r="6"/>
    </symbol>
  </svg>

  <!-- L√≥gica: ESM, QR + Supabase + Firebase -->
  <script type="module">
    import * as QR from "https://esm.sh/qrcode@1.5.3"; // ‚úÖ ESM real

    // Helpers
  const esc = (s = "") =>
  String(s).replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[m]));
      const urlFromBase = (rel)=> new URL(rel, document.baseURI).href;

    // Esperas
    function waitForAuth(timeout=12000){
      if (window.CARITAS?.auth) return Promise.resolve(window.CARITAS.auth);
      const t0=performance.now();
      return new Promise((resolve,reject)=>{
        const onReady=()=>{ document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); };
        document.addEventListener('firebase:ready:caritas', onReady);
        const iv=setInterval(()=>{
          if (window.CARITAS?.auth){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); }
          if (performance.now()-t0>timeout){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); reject(new Error("Firebase no inicializado")); }
        }, 50);
      });
    }
    async function waitForUser(){ const auth = await waitForAuth().catch(()=>null); return auth?.currentUser || new Promise(r=>{ auth?.onAuthStateChanged?.(u=>r(u||null)); }); }

    // Supabase (ya se expone en <head>)
    const supabase = window.CARITAS?.supabase;

    // RPC helpers (iguales a los que usas)
    async function getPublicCred(uid){
  const { data, error } = await supabase.rpc("get_credencial_publica", { uid });
  if (error) throw error;
  return (Array.isArray(data) ? data[0] : data) || null;
  }
    async function upsertCred(uid, email, nombre, foto_url=null){
      const { data, error } = await supabase.rpc("upsert_mi_credencial", {
        uid, p_email: email, p_nombre: nombre, p_rol: "Voluntario C√°ritas CNC", p_foto: foto_url
      });
      if (error) throw error; return data;
    }

    // Render credencial (frente+reverso)
    async function renderCarnet(user){
      const nombreBase = user?.displayName || (user?.email||"").split("@")[0] || "Usuario";
      try { await upsertCred(user.uid, user.email, nombreBase, null); } catch {}

      let data = null;
      try { data = await getPublicCred(user.uid); } catch {}
      if(!data){ alert("‚ùå No se pudo cargar el carnet"); return; }

      const nombre = data.nombre || nombreBase;
      const email  = data.email  || user.email || "";

      // Frente
      document.getElementById("nombre").textContent = esc(nombre);
      document.getElementById("rol").textContent    = esc(data.rol || "Voluntario C√°ritas CNC");
      document.getElementById("foto").src = data.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;

      // Reverso (QR solo atr√°s)
      const qrUrl = urlFromBase(`credenciales.html?view=public&id=${user.uid}`);
      await QR.toCanvas(document.getElementById("qr"), qrUrl, { width:260, margin:1 });
    }

    // Descargar PNG (ambas caras)
    document.getElementById("btn-dl-png").addEventListener("click", async ()=>{
      const { default: html2canvas } = await import("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js");
      const node = document.getElementById("sheet");
      const canvas = await html2canvas(node, {backgroundColor: null, scale: 3, useCORS: true});
      const link = document.createElement('a');
      link.download = `credencial-cnc_${(Date.now())}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // Router simple (view=carnet / public)
    const params = new URLSearchParams(location.search);
    const view = params.get("view");
    if (view === "public"){
      const uid = params.get("id");
      const data = uid ? await getPublicCred(uid).catch(()=>null) : null;
      if (!data) { alert("‚ùå Credencial no encontrada"); location.href="index.html"; }
      document.getElementById("nombre").textContent = esc(data.nombre||"‚Äî");
      document.getElementById("rol").textContent    = esc(data.rol||"Voluntario C√°ritas CNC");
      document.getElementById("foto").src           = data.foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre||"CNC")}&background=111&color=fff`;
      // Reverso: QR a esta vista p√∫blica
      await QR.toCanvas(document.getElementById("qr"), urlFromBase(`credenciales.html?view=public&id=${uid}`), { width:260, margin:1 });
    } else {
      const user = await waitForUser();
      if (!user) { location.href="login.html"; }
      else { await renderCarnet(user); }
    }
    // ====== Calibraci√≥n: teclas y persistencia local ======
(function(){
  const root = document.documentElement;

  function loadLayout(){
    try{
      const cfg = JSON.parse(localStorage.getItem("cred:layout")||"{}");
      ["--cx","--cy","--d"].forEach(k=> cfg[k] && root.style.setProperty(k, cfg[k]));
    }catch{}
  }
  function saveLayout(){
    const cs = getComputedStyle(root);
    const cfg = {
      "--cx": cs.getPropertyValue("--cx").trim(),
      "--cy": cs.getPropertyValue("--cy").trim(),
      "--d" : cs.getPropertyValue("--d").trim()
    };
    localStorage.setItem("cred:layout", JSON.stringify(cfg));
    alert("üìè Layout guardado");
  }
  loadLayout();

  // Atajos: flechas mueven, +/- cambia di√°metro (Shift = paso grande)
  document.addEventListener("keydown",(e)=>{
    // No estorbar inputs
    if (e.target && (e.target.tagName==="INPUT" || e.target.isContentEditable)) return;

    const cs = getComputedStyle(root);
    const toNum = (v) => parseFloat(String(v).replace("mm",""))||0;
    let cx = toNum(cs.getPropertyValue("--cx"));
    let cy = toNum(cs.getPropertyValue("--cy"));
    let d  = toNum(cs.getPropertyValue("--d"));
    const step = e.shiftKey ? 1 : .5; // mm

    let used=false;
    switch(e.key){
      case "ArrowLeft":  cx -= step; used=true; break;
      case "ArrowRight": cx += step; used=true; break;
      case "ArrowUp":    cy -= step; used=true; break;
      case "ArrowDown":  cy += step; used=true; break;
      case "+": case "=": case "NumpadAdd": d += step; used=true; break;
      case "-": case "NumpadSubtract": d -= step; used=true; break;
    }
    if (!used) return;
    e.preventDefault();
    root.style.setProperty("--cx", cx+"mm");
    root.style.setProperty("--cy", cy+"mm");
    root.style.setProperty("--d" ,  Math.max(10, d)+"mm");
  });

  document.getElementById("btn-save-layout")?.addEventListener("click", saveLayout);
})();

async function renderCarnet(user){
  const nombreBase = user?.displayName || (user?.email||"").split("@")[0] || "Usuario";

  // 1) Intentar leer
  let data = await getPublicCred(user.uid).catch(()=>null);

  // 2) Si no existe, crear sin foto (no pisa foto existente) y volver a leer
  if (!data){
    await upsertCred(user.uid, user.email, nombreBase, null);
    data = await getPublicCred(user.uid).catch(()=>null);
  }
  if(!data){ alert("‚ùå No se pudo cargar el carnet"); return; }

  const nombre = data.nombre || nombreBase;
  document.getElementById("nombre").textContent = esc(nombre);
  document.getElementById("rol").textContent    = esc(data.rol || "Voluntario C√°ritas CNC");
  document.getElementById("foto").src = data.foto_url
    || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;

  const qrUrl = urlFromBase(`credenciales.html?view=public&id=${user.uid}`);
  await QR.toCanvas(document.getElementById("qr"), qrUrl, { width:260, margin:1 });
}
  </script>
</body>
</html>