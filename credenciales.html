
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <base href="/Web-familias/">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé´ Credenciales ‚Äî C√°ritas CNC</title>
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- üîå Supabase bootstrap -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";

    window.CARITAS = window.CARITAS || {};
    if (!window.CARITAS.supabase) {
      window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      document.dispatchEvent(new Event("supabase:ready:caritas"));
    }
  </script>

  <!-- üîê Firebase bootstrap -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5X6LUG_dOwuaUf6jQUHw_LM5PFgOmc40",
      authDomain: "web-familias.firebaseapp.com",
      projectId: "web-familias",
      storageBucket: "web-familias.appspot.com",
      messagingSenderId: "261699620792",
      appId: "1:261699620792:web:8ff59afb72e96c371dc94d"
    };

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence).catch(()=>{});

    window.CARITAS = window.CARITAS || {};
    window.CARITAS.auth = auth;

    document.dispatchEvent(new Event("firebase:ready:caritas"));
    onAuthStateChanged(auth, () => document.dispatchEvent(new Event("firebase:ready:caritas")));
  </script>

  <!-- ‚ùå Desactiva cualquier self-heal/health en esta p√°gina para evitar dobles inyecciones -->
  <!-- <script type="module" src="api.js/self-heal-caritas.js"></script> -->
  <!-- <script type="module" src="api.js/health-caritas.js"></script> -->
  <!-- <script defer src="api.js/error-overlay.js"></script> -->
</head>
<body>
  <div class="controls" style="gap:10px; flex-wrap:wrap; align-items:center">
  <!-- Acciones -->
  <div style="display:flex; gap:8px; flex-wrap:wrap">
    <button class="btn" id="btn-dl-png">Descargar PNG (frente+reverso)</button>
    <button class="btn" id="btn-save-layout">üìè Guardar layout</button>
    <button class="btn" id="btn-copy-link">üîó Copiar enlace p√∫blico</button>
    <a class="btn" href="index.html">‚Üê Volver</a>
    <a class="btn" id="btn-admin-local" style="display:none">üóÇÔ∏è Administrar</a>
  </div>

  <!-- Dise√±o -->
  <div style="display:flex; gap:8px; flex-wrap:wrap">
    <label class="btn">üìÑ Plantilla frente <input type="file" id="tpl-front" accept="image/*" hidden></label>
    <label class="btn">üìÑ Plantilla reverso <input type="file" id="tpl-back"  accept="image/*" hidden></label>
    <select id="card-orient" class="btn" style="cursor:pointer">
      <option value="landscape">Horizontal</option>
      <option value="portrait">Gafete (vertical)</option>
    </select>
    <label class="btn">Tama√±o
      <input type="range" id="card-size" min="70" max="120" value="100" step="1" style="vertical-align:middle">
    </label>
  </div>

  <!-- Mover solo lo elegido -->
  <div style="display:flex; gap:8px; flex-wrap:wrap">
    <select id="move-target" class="btn" style="cursor:pointer">
      <option value="brand">Mover: Nombre + Logo</option>
      <option value="logo">Mover: Solo Logo</option>
      <option value="role">Mover: Rol</option>
    </select>
    <button class="btn" id="mv-up">‚Üë</button>
    <button class="btn" id="mv-left">‚Üê</button>
    <button class="btn" id="mv-right">‚Üí</button>
    <button class="btn" id="mv-down">‚Üì</button>
  </div>
</div>
    <!-- Editor (solo en view=carnet) -->
<div id="editor" class="editor" style="display:none">
  <div class="row">
    <label>Nombre</label>
    <input id="edit-nombre" type="text" placeholder="Tu nombre" />
    <small id="edit-nombre-hint" class="muted">Se guarda autom√°ticamente</small>
  </div>
  <div class="row">
    <label>Foto de perfil</label>
    <input id="edit-foto" type="file" accept="image/*" />
    <small class="muted">JPG/PNG recomendados</small>
  </div>
</div>
   <div class="sheet" id="sheet">
  <!-- FRENTE -->
  <section class="card front" id="card-front" aria-label="Credencial frente">
    <img class="wm" src="assets/logo-caritas.png" alt="">
    <img class="tpl" id="tpl-img-front" alt="" />
    <div class="photo"><img id="foto" alt="Foto"></div>

    <div class="brand-row">
      <img class="logo" src="assets/logo-caritas.png" alt="C√°ritas" />
      <div class="name" id="nombre">‚Äî</div>
    </div>

    <div class="role" id="rol">Voluntario C√°ritas CNC</div>
    <div class="stripes" aria-hidden="true"><span></span><span></span><span></span></div>
    <div class="band">C√ÅRITAS CNC</div>
  </section>

  <!-- REVERSO -->
  <section class="card back" id="card-back" aria-label="Credencial reverso">
    <img class="wm" src="assets/logo-caritas.png" alt="">
    <img class="tpl" id="tpl-img-back" alt="" />
    <img class="logo" src="assets/logo-caritas.png" alt="C√°ritas">

    <div class="scan">SCAN ME</div>
    <div class="qr-box"><canvas id="qr"></canvas></div>

    <div class="stripes" aria-hidden="true"><span></span><span></span><span></span></div>
    <div class="footer">C√ÅRITAS CNC</div>
  </section>
</div>
  </div>
  <!-- Vista Admin -->
<section id="admin" style="display:none; width:100%; max-width:980px">
  <div class="controls" style="justify-content:space-between">
    <div>
      <input id="adm-q" type="search" placeholder="Buscar por nombre, email, UID o c√≥digo" style="padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;width:340px">
      <button class="btn" id="adm-reload">Buscar</button>
    </div>
    <div class="muted">Solo usuarios con rol que comience por <b>Admin</b></div>
  </div>
  <div style="overflow:auto;border:1px solid #2a2a2a;border-radius:12px">
    <table id="adm-table" style="width:100%; border-collapse:collapse">
      <thead>
        <tr style="background:#16161a">
          <th style="padding:10px;text-align:left">Nombre</th>
          <th style="padding:10px;text-align:left">Email</th>
          <th style="padding:10px;text-align:left">Rol</th>
          <th style="padding:10px;text-align:left">C√≥digo</th>
          <th style="padding:10px">Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

  <!-- Logo C√°ritas simple (SVG) -->
  <svg width="0" height="0" style="position:absolute">
    <symbol id="logo-caritas" viewBox="0 0 100 100" fill="currentColor">
      <rect x="45" y="10" width="10" height="80" rx="4"/><rect x="10" y="45" width="80" height="10" rx="4"/>
      <circle cx="20" cy="20" r="6"/><circle cx="80" cy="20" r="6"/><circle cx="20" cy="80" r="6"/><circle cx="80" cy="80" r="6"/>
    </symbol>
  </svg>

  <!-- L√≥gica: ESM, QR + Supabase + Firebase -->
 <script type="module">
  import * as QR from "https://esm.sh/qrcode@1.5.3";

  // Evita doble ejecuci√≥n si el HTML se eval√∫a otra vez
  if (window.__CRED_INIT__) {
    console.debug("CRED: ya inicializado");
  } else {
    window.__CRED_INIT__ = true;
    let lastCred = null;  // cache de la fila actual
    // ========== Helpers ==========
    const esc = (s="") =>
      String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const urlFromBase = (rel)=> new URL(rel, document.baseURI).href;
    // Dibuja el QR del tama√±o del contenedor .qr-box (2x para nitidez)
// QR robusto: respeta el tama√±o de .qr-box, re-render en resize
async function drawQR(canvasId, url){
  const el  = document.getElementById(canvasId);
  const box = el?.parentElement;
  if (!el || !box) return;

  const dpr = Math.max(2, Math.round(window.devicePixelRatio || 2));

  const render = () => {
    let w = box.getBoundingClientRect().width;          // px visibles
    if (!w) {
      // Fallback: leer --qr en mm y convertir a px (96dpi ‚âà 3.78 px/mm)
      const qrVar = getComputedStyle(document.documentElement).getPropertyValue('--qr').trim(); // ej. "34mm"
      const mm    = parseFloat(qrVar) || 34;
      w = mm * 3.7795;
    }
    const px = Math.max(80, Math.round(w * dpr));       // m√≠nimo 80px * dpr
    QR.toCanvas(el, url, { width: px, margin: 1 });
  };

  // Espera a layout estable
  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
  render();

  // Re-render si cambia el tama√±o del contenedor
  new ResizeObserver(() => render()).observe(box);
}
    // Esperas Firebase (debe estar bootstrapped en <head>)
    function waitForAuth(timeout=12000){
      if (window.CARITAS?.auth) return Promise.resolve(window.CARITAS.auth);
      const t0 = performance.now();
      return new Promise((resolve,reject)=>{
        const onReady = ()=>{ document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); };
        document.addEventListener('firebase:ready:caritas', onReady);
        const iv=setInterval(()=>{
          if (window.CARITAS?.auth){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); resolve(window.CARITAS.auth); }
          if (performance.now()-t0>timeout){ clearInterval(iv); document.removeEventListener('firebase:ready:caritas', onReady); reject(new Error("Firebase no inicializado")); }
        },50);
      });
    }
    async function waitForUser(){
      const auth = await waitForAuth().catch(()=>null);
      return auth?.currentUser || await new Promise(r=>auth?.onAuthStateChanged?.(u=>r(u||null)));
    }

    // Supabase (expuesto en <head>)
    const supabase = window.CARITAS?.supabase;

    // ========== RPC ==========
    async function getPublicCred(uid){
      const { data, error } = await supabase.rpc("get_credencial_publica", { uid });
      if (error) throw error;
      return (Array.isArray(data) ? data[0] : data) || null;
    }
    async function upsertCred(uid, email, nombre, foto_url=null){
      const { data, error } = await supabase.rpc("upsert_mi_credencial", {
        uid, p_email: email, p_nombre: nombre, p_rol: "Voluntario C√°ritas CNC", p_foto: foto_url
      });
      if (error) throw error;
      return data;
    }

    // ========== Render (frente + reverso) ==========
    async function renderCarnet(user){
      const nombreBase = user?.displayName || (user?.email||"").split("@")[0] || "Usuario";

      // Leer; si no existe, crear sin pisar foto y volver a leer
      let data = await getPublicCred(user.uid).catch(()=>null);
      if (!data){
        await upsertCred(user.uid, user.email, nombreBase, null);
        data = await getPublicCred(user.uid).catch(()=>null);
      }
      if(!data){ alert("‚ùå No se pudo cargar el carnet"); return; }

      const nombre = data.nombre || nombreBase;
      lastCred = data;


      // Frente
      document.getElementById("nombre").textContent = esc(nombre);
      document.getElementById("rol").textContent    = esc(data.rol || "Voluntario C√°ritas CNC");
      document.getElementById("foto").src = data.foto_url
        || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;

      // Reverso (QR a vista p√∫blica)
      const qrUrl = urlFromBase(`credenciales.html?view=public&id=${user.uid}`);
      await drawQR("qr", qrUrl);
    }
    // ---------- util ----------
const toast = (t)=> alert(t);
function fitText(el, max=5.8, min=4.6){ // tama√±os en mm
  const toPx = mm => mm * 3.7795;
  let size = max;
  el.style.fontSize = max+'mm';
  const w = el.parentElement?.clientWidth || 160;
  while (el.scrollWidth > w && size > min){
    size -= .2;
    el.style.fontSize = size+'mm';
  }
}

// Auto-guardar nombre SIN perder foto
let saveNameTimer = null;
async function saveNombreAuto(user, nombre){
  const hint = document.getElementById("edit-nombre-hint");
  try{
    hint.textContent = "Guardando‚Ä¶";
    const foto = lastCred?.foto_url || null;
    await upsertCred(user.uid, user.email, nombre, foto);
    lastCred = { ...(lastCred||{}), nombre };
    hint.textContent = "‚úÖ Guardado";
    await renderCarnet(user);
    // Ajusta tama√±o del nombre al ancho disponible
    fitText(document.getElementById("nombre"));
  }catch(e){
    console.error(e); hint.textContent = "‚ùå Error al guardar";
  }finally{
    setTimeout(()=>{ if(hint.textContent.startsWith("‚úÖ")) hint.textContent="Se guarda autom√°ticamente"; }, 1200);
  }
}



// Subir foto SIN perder nombre
async function saveFoto(user, file){
  const ext  = (file.name.split(".").pop() || "jpg").toLowerCase();
  const path = `credenciales/${user.uid}-${Date.now()}.${ext}`;
  const up = await supabase.storage.from("fotos").upload(path, file, { upsert:true });
  if (up.error) throw up.error;
  const { data: pub } = supabase.storage.from("fotos").getPublicUrl(path);
  const foto_url = pub.publicUrl;

  const nombre = (lastCred?.nombre || user.displayName || (user.email||"").split("@")[0] || "Usuario");
  await upsertCred(user.uid, user.email, nombre, foto_url); // enviamos nombre+foto nueva
  lastCred = { ...(lastCred||{}), foto_url, nombre };
  await renderCarnet(user);
  alert("‚úÖ Foto actualizada");
}

// ---------- ADMIN ----------
async function isAdmin(uid){
  const { data, error } = await supabase.rpc("is_admin", { uid });
  if (error) return false;
  return !!data;
}
async function loadAdmin(q=""){
  const { data, error } = await supabase.rpc("admin_list_credenciales", { p_search: q, p_limit: 100, p_offset: 0 });
  if (error) throw error;
  const tbody = document.querySelector("#adm-table tbody");
  tbody.innerHTML = "";
  (data||[]).forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:10px">${row.nombre||"‚Äî"}</td>
      <td style="padding:10px">${row.email||"‚Äî"}</td>
      <td style="padding:10px">${row.rol||"‚Äî"}</td>
      <td style="padding:10px;font-family:monospace">${row.codigo||"‚Äî"}</td>
      <td style="padding:10px;text-align:center">
        <a class="btn" href="credenciales.html?view=public&id=${row.user_id}">Ver</a>
      </td>`;
    tbody.appendChild(tr);
  });
}
    // ========== Descargar PNG (ESM/UMD robusto) ==========
    document.getElementById("btn-dl-png").addEventListener("click", async ()=>{
      let html2canvas;
      try {
        const mod = await import("https://esm.sh/html2canvas@1.4.1");
        html2canvas = (mod && (mod.default||mod));
      } catch {
        await import("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js");
        html2canvas = window.html2canvas;
      }
      if (typeof html2canvas !== "function") {
        alert("No se pudo cargar html2canvas"); return;
      }
      const node = document.getElementById("sheet");
      const canvas = await html2canvas(node, { backgroundColor: null, scale: 3, useCORS: true });
      const link = document.createElement('a');
      link.download = `credencial-cnc_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

   // ---------- ROUTER ----------
const params = new URLSearchParams(location.search);
const view = params.get("view");

if (view === "public"){
  const uid = params.get("id");
  const data = uid ? await getPublicCred(uid).catch(()=>null) : null;
  if(!data){
    alert("‚ùå Credencial no encontrada");
    location.href = "index.html";
  } else {
    const nombre = data?.nombre || "Voluntario";
    document.getElementById("nombre").textContent = esc(nombre);
    document.getElementById("rol").textContent    = esc(data?.rol || "Voluntario C√°ritas CNC");
    document.getElementById("foto").src = data?.foto_url
      || `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=111&color=fff`;
    await drawQR("qr", new URL(`credenciales.html?view=public&id=${uid}`, document.baseURI).href);
    document.getElementById("editor")?.style.setProperty("display","none");
    document.getElementById("admin")?.style.setProperty("display","none");
  }

} else if (view === "admin"){
  const user = await waitForUser();
  if (!user) {
    location.href = "login.html?next=" + encodeURIComponent(location.pathname + location.search);
  } else if (!await isAdmin(user.uid)) {
    alert("Acceso solo para Admin");
    location.href = "index.html";
  } else {
    document.getElementById("sheet")?.style.setProperty("display","none");
    document.getElementById("editor")?.style.setProperty("display","none");
    document.getElementById("admin")?.style.setProperty("display","");
    await loadAdmin();
    document.getElementById("adm-reload").addEventListener("click", ()=>{
      const q = document.getElementById("adm-q").value.trim();
      loadAdmin(q);
    });
  }

} else { // view=carnet (por defecto)
  const user = await waitForUser();
  if (!user) {
    location.href = "login.html?next=" + encodeURIComponent(location.pathname + location.search);
  } else {
    await renderCarnet(user);

    // mostrar editor
    const ed = document.getElementById("editor");
    ed && (ed.style.display = "");

    // auto-guardar nombre (debounce)
    const inputNombre = document.getElementById("edit-nombre");
    if (inputNombre){
      inputNombre.value = document.getElementById("nombre").textContent.trim();
      inputNombre.addEventListener("input", ()=>{
        clearTimeout(saveNameTimer);
        const nombre = inputNombre.value.trim();
        saveNameTimer = setTimeout(()=> saveNombreAuto(user, nombre), 500);
      });
    }

    // subir foto
    const inputFoto = document.getElementById("edit-foto");
    inputFoto?.addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      try { await saveFoto(user, f); }
      catch(err){ console.error(err); alert("‚ùå No se pudo subir la foto"); }
      finally { e.target.value = ""; }
    });
  }
}
    // ========= Plantilla + orientaci√≥n + tama√±o (no altera tus funciones) =========
(function(){
  const frontImg = document.getElementById("tpl-img-front");
  const backImg  = document.getElementById("tpl-img-back");
  const sel      = document.getElementById("card-orient");
  const rng      = document.getElementById("card-size");
  const cardF    = document.getElementById("card-front");
  const cardB    = document.getElementById("card-back");

  // Cargar plantillas desde archivos (objeto URL)
  document.getElementById("tpl-front")?.addEventListener("change", e=>{
    const f = e.target.files?.[0]; if(!f) return;
    frontImg.src = URL.createObjectURL(f);
  });
  document.getElementById("tpl-back")?.addEventListener("change", e=>{
    const f = e.target.files?.[0]; if(!f) return;
    backImg.src = URL.createObjectURL(f);
  });

  // Orientaci√≥n: horizontal / gafete (vertical)
  function applyOrient(v){
    const isPortrait = v === "portrait";
    cardF.classList.toggle("gafete", isPortrait);
    cardB.classList.toggle("gafete", isPortrait);

    // Ajustar dimensiones base
    const baseW = 85.6, baseH = 54;
    const pct   = Number(rng.value||100)/100;
    const w = isPortrait ? baseH : baseW;
    const h = isPortrait ? baseW : baseH;
    document.documentElement.style.setProperty("--card-w", (w*pct)+"mm");
    document.documentElement.style.setProperty("--card-h", (h*pct)+"mm");
  }
  sel?.addEventListener("change", ()=> applyOrient(sel.value));
  applyOrient(sel?.value || "landscape");

  // Tama√±o: escala porcentual del est√°ndar
  rng?.addEventListener("input", ()=>{
    const isPortrait = cardF.classList.contains("gafete");
    const baseW = 85.6, baseH = 54;
    const pct   = Number(rng.value||100)/100;
    const w = isPortrait ? baseH : baseW;
    const h = isPortrait ? baseW : baseH;
    document.documentElement.style.setProperty("--card-w", (w*pct)+"mm");
    document.documentElement.style.setProperty("--card-h", (h*pct)+"mm");
  });
})();

    // ========== Calibraci√≥n (flechas y +/-) ==========
    (function(){
      const root = document.documentElement;
      function loadLayout(){
        try{
          const cfg = JSON.parse(localStorage.getItem("cred:layout")||"{}");
          ["--cx","--cy","--d"].forEach(k=> cfg[k] && root.style.setProperty(k, cfg[k]));
        }catch{}
      }
      function saveLayout(){
        const cs = getComputedStyle(root);
        const cfg = {
          "--cx": cs.getPropertyValue("--cx").trim(),
          "--cy": cs.getPropertyValue("--cy").trim(),
          "--d" : cs.getPropertyValue("--d").trim()
        };
        localStorage.setItem("cred:layout", JSON.stringify(cfg));
        alert("üìè Layout guardado");
      }
      loadLayout();
      document.addEventListener("keydown",(e)=>{
        if (e.target && (e.target.tagName==="INPUT" || e.target.isContentEditable)) return;
        const cs = getComputedStyle(root);
        const num = v => parseFloat(String(v).replace("mm",""))||0;
        let cx = num(cs.getPropertyValue("--cx"));
        let cy = num(cs.getPropertyValue("--cy"));
        let d  = num(cs.getPropertyValue("--d"));
        const step = e.shiftKey ? 1 : .5;
        let used=false;
        switch(e.key){
          case "ArrowLeft":  cx -= step; used=true; break;
          case "ArrowRight": cx += step; used=true; break;
          case "ArrowUp":    cy -= step; used=true; break;
          case "ArrowDown":  cy += step; used=true; break;
          case "+": case "=": d += step; used=true; break;
          case "-":           d -= step; used=true; break;
        }
        if (!used) return;
        e.preventDefault();
        root.style.setProperty("--cx", cx+"mm");
        root.style.setProperty("--cy", cy+"mm");
        root.style.setProperty("--d" , Math.max(10, d)+"mm");
      });
      document.getElementById("btn-save-layout")?.addEventListener("click", saveLayout);
    })();

  } // __CRED_INIT__

  // Copiar mi enlace p√∫blico (carnet)
document.getElementById("btn-copy-link")?.addEventListener("click", ()=>{
  const user = window.CARITAS?.auth?.currentUser;
  if (!user) return alert("Debes iniciar sesi√≥n");
  const url = new URL(`credenciales.html?view=public&id=${user.uid}`, document.baseURI).href;
  navigator.clipboard.writeText(url).then(
    ()=> alert("‚úÖ Enlace copiado"),
    ()=> alert(url) // fallback simple si Clipboard falla
  );
});
// ========= Persistencia: plantilla + orientaci√≥n + tama√±o =========
// Guarda en localStorage y restaura en todas las vistas (carnet / p√∫blica / admin)
(function(){
  const DESIGN_KEY = "cred:design";

  const frontImg = document.getElementById("tpl-img-front");
  const backImg  = document.getElementById("tpl-img-back");
  const sel      = document.getElementById("card-orient");
  const rng      = document.getElementById("card-size");
  const cardF    = document.getElementById("card-front");
  const cardB    = document.getElementById("card-back");

  // ---- helpers de estado ----
  function saveDesign(partial={}){
    const prev = JSON.parse(localStorage.getItem(DESIGN_KEY) || "{}");
    const design = { ...prev, ...partial };
    localStorage.setItem(DESIGN_KEY, JSON.stringify(design));
    return design;
  }
  function applyOrientValue(orient="landscape", pct=1){
    const isPortrait = orient === "portrait";
    cardF?.classList.toggle("gafete", isPortrait);
    cardB?.classList.toggle("gafete", isPortrait);

    const baseW = 85.6, baseH = 54; // mm CR80
    const w = (isPortrait ? baseH : baseW) * pct;
    const h = (isPortrait ? baseW : baseH) * pct;
    document.documentElement.style.setProperty("--card-w", w + "mm");
    document.documentElement.style.setProperty("--card-h", h + "mm");
  }
  function applyDesign(design={}){
    const orient = design.orient || "landscape";
    const size   = Number(design.size || 100);      // %
    sel && (sel.value = orient);
    rng && (rng.value = size);
    applyOrientValue(orient, size/100);

    if (design.tplFront && frontImg) frontImg.src = design.tplFront;
    if (design.tplBack  && backImg)  backImg.src  = design.tplBack;
  }
  function loadDesign(){
    const design = JSON.parse(localStorage.getItem(DESIGN_KEY) || "{}");
    applyDesign(design);
  }

  // ---- carga inicial (todas las vistas) ----
  loadDesign();

  // ---- UI listeners ----
  sel?.addEventListener("change", ()=>{
    const design = saveDesign({ orient: sel.value });
    applyDesign(design);
  });

  rng?.addEventListener("input", ()=>{
    const size = Number(rng.value || 100);
    const design = saveDesign({ size });
    applyDesign(design);
  });

  // Convertir archivo a DataURL y reducir tama√±o para caber en localStorage
  async function fileToDataURL(file, max=1400){
    const raw = await new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
    // Downscale en canvas (reduce peso, mantiene aspecto)
    return await new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const w = img.width, h = img.height;
        const scale = Math.min(1, max / Math.max(w,h));
        const cw = Math.round(w * scale), ch = Math.round(h * scale);
        const c = document.createElement("canvas");
        c.width = cw; c.height = ch;
        c.getContext("2d").drawImage(img, 0, 0, cw, ch);
        resolve(c.toDataURL("image/jpeg", 0.9));
      };
      img.src = raw;
    });
  }

  document.getElementById("tpl-front")?.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    const dataURL = await fileToDataURL(f, 1600);
    if (frontImg) frontImg.src = dataURL;
    saveDesign({ tplFront: dataURL });
  });

  document.getElementById("tpl-back")?.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    const dataURL = await fileToDataURL(f, 1600);
    if (backImg) backImg.src = dataURL;
    saveDesign({ tplBack: dataURL });
  });

  // Integramos con tu bot√≥n existente "üìè Guardar layout"
  document.getElementById("btn-save-layout")?.addEventListener("click", ()=>{
    saveDesign({
      orient: sel?.value || "landscape",
      size: Number(rng?.value || 100)
      // Las plantillas ya se guardan cuando las eliges
    });
    // Tu alerta de "Layout guardado" ya se muestra en tu handler actual
  }, { capture:true });
})();
// ====== Mover Nombre/Logo/Rol + Guardar en layout ======
(function(){
  const root = document.documentElement;
  const $ = (id)=> document.getElementById(id);

  const targets = {
    brand: ["--brand-dx","--brand-dy"],
    logo:  ["--logo-dx","--logo-dy"],
    role:  ["--role-dx","--role-dy"]
  };
  function num(v){ return parseFloat(String(v).replace("mm","")) || 0; }
  function nudge(dx, dy){
    const t = $("#move-target")?.value || "brand";
    const [vx, vy] = targets[t];
    const cs = getComputedStyle(root);
    const nx = num(cs.getPropertyValue(vx)) + dx;
    const ny = num(cs.getPropertyValue(vy)) + dy;
    root.style.setProperty(vx, nx+"mm");
    root.style.setProperty(vy, ny+"mm");
  }

  // Botonera
  $("#mv-up")?.addEventListener("click",  (e)=>{ e.preventDefault(); nudge(0,  -.5); });
  $("#mv-down")?.addEventListener("click",(e)=>{ e.preventDefault(); nudge(0,   .5); });
  $("#mv-left")?.addEventListener("click",(e)=>{ e.preventDefault(); nudge(-.5, 0 ); });
  $("#mv-right")?.addEventListener("click",(e)=>{ e.preventDefault(); nudge( .5, 0 ); });

  // Teclado: mantener ALT para mover (flechas); Shift = paso 1 mm
  document.addEventListener("keydown",(e)=>{
    if (!e.altKey) return;                             // solo cuando mantienes Alt
    if (e.target && (e.target.tagName==="INPUT" || e.target.isContentEditable)) return;
    const step = e.shiftKey ? 1 : .5;
    let used=false;
    switch(e.key){
      case "ArrowUp":    nudge(0,-step); used=true; break;
      case "ArrowDown":  nudge(0, step); used=true; break;
      case "ArrowLeft":  nudge(-step,0); used=true; break;
      case "ArrowRight": nudge( step,0); used=true; break;
    }
    if (used) e.preventDefault();
  });

  // Integrar con "üìè Guardar layout": guardamos tambi√©n estos offsets
  const LKEY = "cred:layout";
  function saveLayoutPlus(){
    const cs = getComputedStyle(root);
    const keys = ["--cx","--cy","--d","--brand-dx","--brand-dy","--logo-dx","--logo-dy","--role-dx","--role-dy"];
    const cfg = {};
    keys.forEach(k=> cfg[k] = cs.getPropertyValue(k).trim());
    try{
      const prev = JSON.parse(localStorage.getItem(LKEY)||"{}");
      localStorage.setItem(LKEY, JSON.stringify({ ...prev, ...cfg }));
    }catch{}
    alert("üìè Layout guardado (foto + nombre/logo/rol)");
  }
  // Capturamos el click para asegurar guardado completo (sin romper tu handler)
  document.getElementById("btn-save-layout")?.addEventListener("click", (e)=>{
    e.stopImmediatePropagation?.();
    saveLayoutPlus();
  }, {capture:true});

  // Cargar si existe
  (function loadLayoutPlus(){
    try{
      const cfg = JSON.parse(localStorage.getItem(LKEY)||"{}");
      ["--brand-dx","--brand-dy","--logo-dx","--logo-dy","--role-dx","--role-dy"].forEach(k=>{
        if (cfg[k]) root.style.setProperty(k, cfg[k]);
      });
    }catch{}
  })();

  // Guardar credencial (BD): nombre/foto actuales
  $("#btn-save-cred")?.addEventListener("click", async ()=>{
    try{
      const user = await waitForUser();
      if (!user) return location.href = "login.html?next=" + encodeURIComponent(location.pathname + location.search);
      const nombre = document.getElementById("nombre")?.textContent?.trim() || "";
      const foto   = document.getElementById("foto")?.src || null;
      await upsertCred(user.uid, user.email, nombre || null, foto || null);
      alert("‚úÖ Credencial guardada");
      await renderCarnet(user);
    }catch(err){
      console.error(err);
      alert("‚ùå No se pudo guardar la credencial");
    }
  });
})();
// ====== Movimiento preciso (solo el target elegido) + Drag ======
(function(){
  const root = document.documentElement;
  const $ = s => document.getElementById(s);

  const targets = {
    brand: { el: document.querySelector('.brand-row'), vx: '--brand-dx', vy: '--brand-dy' },
    logo:  { el: document.querySelector('.brand-row .logo'), vx: '--logo-dx',  vy: '--logo-dy'  },
    role:  { el: document.querySelector('.role'), vx: '--role-dx', vy: '--role-dy' },
  };

  const sel = $('#move-target');
  const getT = () => targets[sel?.value || 'brand'];

  const mmPerPx = () => {
    // convierte desplazamiento en px a mm seg√∫n ancho real de la tarjeta
    const card = document.querySelector('.card.front');
    const rect = card.getBoundingClientRect();
    const wmm  = parseFloat(getComputedStyle(root).getPropertyValue('--card-w')) || 85.6;
    return wmm / rect.width;
  };

  const toNum = v => parseFloat(String(v).replace('mm','')) || 0;
  function nudge(dxmm, dymm){
    const t = getT();
    const cs = getComputedStyle(root);
    root.style.setProperty(t.vx, (toNum(cs.getPropertyValue(t.vx)) + dxmm) + 'mm');
    root.style.setProperty(t.vy, (toNum(cs.getPropertyValue(t.vy)) + dymm) + 'mm');
  }

  // Flechas con Alt (Shift = paso 1mm)
  document.addEventListener('keydown', (e)=>{
    if (!e.altKey) return;
    if (e.target && (e.target.tagName==='INPUT' || e.target.isContentEditable)) return;
    const step = e.shiftKey ? 1 : .5;
    let used=false;
    switch(e.key){
      case 'ArrowUp':    nudge(0,-step); used=true; break;
      case 'ArrowDown':  nudge(0, step); used=true; break;
      case 'ArrowLeft':  nudge(-step,0); used=true; break;
      case 'ArrowRight': nudge( step,0); used=true; break;
    }
    if (used) e.preventDefault();
  });

  // Botones
  $('#mv-up')   ?.addEventListener('click', e=>{e.preventDefault(); nudge(0,-.5);});
  $('#mv-down') ?.addEventListener('click', e=>{e.preventDefault(); nudge(0, .5);});
  $('#mv-left') ?.addEventListener('click', e=>{e.preventDefault(); nudge(-.5,0);});
  $('#mv-right')?.addEventListener('click', e=>{e.preventDefault(); nudge( .5,0);});

  // Drag (solo el target seleccionado)
  function makeDraggable(){
    Object.values(targets).forEach(t => t.el?.classList.add('drag-ready'));
    let dragging = null, startX=0, startY=0, startVX=0, startVY=0;

    function onDown(e){
      const t = getT();
      if (!t.el || !t.el.contains(e.target)) return; // drag solo sobre el target activo
      dragging = t;
      const cs = getComputedStyle(root);
      startVX = toNum(cs.getPropertyValue(t.vx));
      startVY = toNum(cs.getPropertyValue(t.vy));
      startX = e.clientX; startY = e.clientY;
      t.el.classList.add('dragging');
      window.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp, { once:true });
      e.preventDefault();
    }
    function onMove(e){
      if (!dragging) return;
      const mul = mmPerPx();
      const dxmm = (e.clientX-startX) * mul;
      const dymm = (e.clientY-startY) * mul;
      root.style.setProperty(dragging.vx, (startVX + dxmm) + 'mm');
      root.style.setProperty(dragging.vy, (startVY + dymm) + 'mm');
    }
    function onUp(){
      if (dragging?.el) dragging.el.classList.remove('dragging');
      dragging = null;
      window.removeEventListener('pointermove', onMove);
    }
    // Escuchamos el √°rea de la tarjeta frontal para iniciar drag
    document.getElementById('card-front')?.addEventListener('pointerdown', onDown);
  }
  makeDraggable();

  // Guardar en layout (sumamos offsets al storage)
  const LKEY = 'cred:layout';
  function saveLayoutPlus(){
    const cs = getComputedStyle(root);
    const keys = ['--cx','--cy','--d','--brand-dx','--brand-dy','--logo-dx','--logo-dy','--role-dx','--role-dy'];
    const cfg = {}; keys.forEach(k => cfg[k] = cs.getPropertyValue(k).trim());
    try{
      const prev = JSON.parse(localStorage.getItem(LKEY)||'{}');
      localStorage.setItem(LKEY, JSON.stringify({ ...prev, ...cfg }));
    }catch{}
    alert('üìè Layout guardado (foto + nombre/logo/rol)');
  }
  document.getElementById('btn-save-layout')?.addEventListener('click', (e)=>{
    e.stopImmediatePropagation?.();
    saveLayoutPlus();
  }, { capture:true });

  // Guardar credencial (BD): nombre y foto actuales
  document.getElementById('btn-save-cred')?.addEventListener('click', async ()=>{
    try{
      const user = await waitForUser();
      if (!user) return location.href = 'login.html?next=' + encodeURIComponent(location.pathname + location.search);
      const nombre = document.getElementById('nombre')?.textContent?.trim() || '';
      const foto   = document.getElementById('foto')?.src || null;
      await upsertCred(user.uid, user.email, nombre || null, foto || null);
      alert('‚úÖ Credencial guardada');
      await renderCarnet(user);
    }catch(err){
      console.error(err); alert('‚ùå No se pudo guardar la credencial');
    }
  });
})();
</script>
</body>
</html>