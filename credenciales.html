<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Credenciales ‚Äì C√°ritas CNC (Modo Simple)</title>

<style>
  :root{
    /* Tama√±o CR80 vertical */
    --card-w: 54mm;
    --card-h: 85.6mm;

    /* C√≠rculo de foto (se ajusta por dise√±o) */
    --cx: 26mm;     /* centro X */
    --cy: 21mm;     /* centro Y */
    --d:  30mm;     /* di√°metro */

    /* Texto / medidas */
    --name-size: 14px;
    --role-size: 11px;

    /* QR (solo en reverso; se ajusta por dise√±o del reverso) */
    --qr-size: 19mm;
    --qr-x: 7mm;
    --qr-y: 8mm;
  }

  *{box-sizing:border-box}
  body{margin:0;background:#0b0d12;color:#e8e8e8;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
  body.tema-blanco{background:#f3f5f7;color:#111}
  main{max-width:1100px;margin:12px auto;padding:12px;display:grid;grid-template-columns:380px 1fr;gap:16px}
  @media(max-width:900px){main{grid-template-columns:1fr}}

  /* Panel izquierdo */
  #side{
    background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px;
    padding:12px;
    backdrop-filter:saturate(120%) blur(6px);
  }
  #side h2{margin:.3rem 0 .6rem 0;font-size:1.05rem}
  .row{display:flex;gap:.5rem;align-items:center;margin:.5rem 0}
  .row input[type="text"]{flex:1;padding:.55rem;border-radius:10px;border:1px solid #ccc;background:#fff;color:#111}
  .row input[type="file"]{flex:1}
  .muted{opacity:.7;font-size:.88rem}

  /* Selectores */
  .selectors{display:grid;gap:.5rem;margin:.25rem 0 .5rem 0}
  .selectors .line{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
  .selectors label{cursor:pointer}

  /* Botones */
  .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem}
  .btn{appearance:none;border:0;border-radius:12px;padding:.6rem .9rem;font-weight:700;cursor:pointer}
  .btn.primary{background:#b10202;color:#fff}
  .btn.ghost{background:#fff;color:#111;border:1px solid #ccc}
  body.tema-blanco .btn.ghost{background:#111;color:#fff;border:1px solid #222}

  /* Lienzo */
  #sheet{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  .card{
    position:relative;width:var(--card-w);height:var(--card-h);
    border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.35);
    background:#111;isolation:isolate;
  }
  .card img.template{
    position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;
    pointer-events:none;user-select:none;
  }

  /* Foto circular que LLENA el c√≠rculo */
  .photo-wrap{
    position:absolute;
    left:calc(var(--cx) - var(--d)/2);
    top: calc(var(--cy) - var(--d)/2);
    width:var(--d);height:var(--d);
    border-radius:50%;overflow:hidden;display:grid;place-items:center;z-index:2;
  }
  .photo{width:100%;height:100%;object-fit:cover;object-position:center;display:block}

  /* Fila de nombre + rol */
  .brand-row{
    position:absolute;left:8mm;top:52mm;right:14mm;
    display:flex;flex-direction:column;gap:2px;align-items:flex-start;z-index:3;
  }
  .brand-row .name{margin:0;font-weight:800;font-size:var(--name-size);line-height:1.15;color:#fff}
  .brand-row .role{margin:0;font-weight:600;font-size:var(--role-size);opacity:.9;color:#fff}
  body.tema-blanco .brand-row .name, body.tema-blanco .brand-row .role{color:#b10202}

  /* QR (SOLO REVERSO) */
  .qr-wrap{
    position:absolute;right:var(--qr-x);bottom:var(--qr-y);
    width:var(--qr-size);height:var(--qr-size);z-index:3;
    background:transparent;border-radius:6px;display:grid;place-items:center;
  }
  .qr-wrap.hidden{display:none}
  .qr-wrap canvas{width:100%;height:100%}

  .draggable{cursor:move}
</style>
</head>

<body class="tema-negro">
<main>
  <!-- PANEL IZQUIERDO -->
  <section id="side">
    <h2>Credencial ‚Äì Modo Simple</h2>

    <div class="selectors">
      <!-- Frente -->
      <div class="line" id="selector-diseno">
        <strong>Frente:</strong>
        <label><input type="radio" name="diseno" value="blanco"> Blanco</label>
        <label><input type="radio" name="diseno" value="negro" checked> Negro</label>
        <span class="muted">(atajo: tecla ‚ÄúT‚Äù)</span>
      </div>

      <!-- Reverso -->
      <div class="line" id="selector-reverso">
        <strong>Reverso:</strong>
        <label><input type="radio" name="reverso" value="blanco" checked> Blanco</label>
        <label><input type="radio" name="reverso" value="negro"> Negro</label>
        <span class="muted">(atajo: tecla ‚ÄúR‚Äù)</span>
      </div>

      <!-- Mostrar/ocultar QR trasero -->
      <div class="line">
        <label><input id="toggle-qr" type="checkbox" checked> Mostrar QR atr√°s</label>
      </div>
    </div>

    <!-- Datos -->
    <div class="row"><label for="input-nombre"><strong>Nombre</strong></label></div>
    <div class="row"><input id="input-nombre" type="text" placeholder="Nombre y Apellido" autocomplete="name" /></div>

    <div class="row"><label for="input-foto"><strong>Foto</strong></label></div>
    <div class="row"><input id="input-foto" type="file" accept="image/*" /></div>

    <div class="actions">
      <button id="btn-guardar-layout" class="btn ghost">üìè Guardar layout</button>
      <button id="btn-descargar" class="btn primary">‚¨áÔ∏è Descargar PNG</button>
      <button id="btn-logout" class="btn ghost" style="margin-left:auto;display:none">Cerrar sesi√≥n</button>
    </div>

    <p class="muted">
      <strong>Nombre</strong>: arrastra o usa <kbd>ALT</kbd> + flechas.
      <br><strong>Foto</strong>: <kbd>Ctrl</kbd> + Flechas (mover), <kbd>Ctrl</kbd> + <kbd>=</kbd>/<kbd>-</kbd> (zoom).
      <br><strong>QR atr√°s</strong>: arrastra o <kbd>ALT</kbd> + flechas (cuando est√° visible).
      <br>Todo queda guardado autom√°ticamente (local).
    </p>
  </section>

  <!-- LIENZO (FRENTE + REVERSO) -->
  <section id="canvas">
    <div id="sheet">
      <!-- Frente -->
      <article id="card-front" class="card gafete">
        <img id="tpl-img-front" class="template" alt="plantilla frente" src="assets/plantillas/cred-frente-negro.png" />
        <div class="photo-wrap"><img id="foto" class="photo" alt="foto" src="" /></div>
        <div id="brand-front" class="brand-row draggable">
          <h3 id="nombre" class="name">Voluntario</h3>
          <p id="rol" class="role">Voluntario C√°ritas CNC</p>
        </div>
      </article>

      <!-- Reverso -->
      <article id="card-back" class="card gafete">
        <img id="tpl-img-back" class="template" alt="plantilla reverso" src="assets/plantillas/cred-reverso.png" />
        <div id="qr-wrap" class="qr-wrap draggable"><canvas id="qr-back"></canvas></div>
      </article>
    </div>
  </section>
</main>

<!-- C√ìDIGO PRINCIPAL -->
<script type="module">
/* Libs ESM */
import QR from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm";
import html2canvas from "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/+esm";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

/* Estado y utilidades */
let lastCred = null;
const LS = window.localStorage;
const STORAGE_KEY = "cred_data";     // nombre, rol, foto, toggles, dise√±os
const LAYOUT_KEY  = "cred_layout";   // css vars y transforms
const $  = (q,root=document)=>root.querySelector(q);
const setVar = (n,v)=>document.documentElement.style.setProperty(n,v);
const mm = (v)=>parseFloat(String(v).replace("mm","")) || 0;
const setVarMM=(n,val)=>setVar(n, `${val.toFixed(2)}mm`);

/* ====== PERSISTENCIA LOCAL ====== */
function loadLocal(){
  try{ return JSON.parse(LS.getItem(STORAGE_KEY)||"{}"); }catch{ return {}; }
}
function saveLocal(patch){
  const now = loadLocal();
  const next = {...now, ...patch};
  try{ LS.setItem(STORAGE_KEY, JSON.stringify(next)); }catch(e){ console.warn("localStorage lleno", e); }
}
function restoreFromLocal(){
  const d = loadLocal();
  // datos
  if (d.nombre) $("#nombre").textContent = d.nombre, $("#input-nombre").value = d.nombre;
  if (d.rol)    $("#rol").textContent    = d.rol;
  if (d.fotoDataUrl) $("#foto").src = d.fotoDataUrl;
  // toggles
  if (typeof d.showQR === "boolean") $("#toggle-qr").checked = d.showQR;
  // plantillas
  if (d.frontDesign) setDisenoFrente(d.frontDesign);
  if (d.backDesign)  setDisenoReverso(d.backDesign);
}

/* Comprime imagen a DataURL (para guardar en LS sin pasarte de 5MB) */
function fileToDataURL(file, maxSize=800){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = () => {
      img.onload = () => {
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d");
        const minSide = Math.min(img.width, img.height);
        // recorte cuadrado centrado
        const sx = (img.width  - minSide)/2;
        const sy = (img.height - minSide)/2;
        const out = Math.min(maxSize, minSide);
        c.width = c.height = out;
        ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, out, out);
        resolve(c.toDataURL("image/jpeg", 0.86));
      };
      img.onerror = reject;
      img.src = reader.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ====== BACKEND (fallbacks seguros) ====== */
async function upsertCred(uid, email, nombre, fotoUrl){
  try{ if (window.upsertCred) return await window.upsertCred(uid,email,nombre,fotoUrl); }catch(e){}
  lastCred = { uid, email, nombre, foto_url: fotoUrl, rol:"Voluntario C√°ritas CNC" };
  return lastCred;
}
async function getPublicCred(uid){
  try{ if (window.getPublicCred) return await window.getPublicCred(uid); }catch(e){}
  return lastCred;
}

/* ====== RENDER ====== */
async function ensureLastCred(user){
  if (lastCred && lastCred.uid===user?.uid) return lastCred;
  const nombreBase = user?.displayName || (user?.email||"").split("@")[0] || "Voluntario";
  await upsertCred(user?.uid, user?.email, nombreBase, null);
  lastCred = await getPublicCred(user?.uid) || lastCred || { nombre:nombreBase, rol:"Voluntario C√°ritas CNC" };
  return lastCred;
}
async function drawQR(canvasId, url){
  const el  = document.getElementById(canvasId);
  const box = el?.parentElement;
  if (!el || !box) return;

  const dpr = Math.max(1, Math.round(window.devicePixelRatio || 1));
  const render = () => {
    let w = box.getBoundingClientRect().width;
    if (!w) {
      const mmSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--qr-size')) || 19;
      w = mmSize * 3.7795; // mm ‚Üí px
    }
    const px = Math.max(96, Math.round(w * dpr));
    el.width = el.height = px;
    el.style.width  = Math.round(w) + "px";
    el.style.height = Math.round(w) + "px";
    QR.toCanvas(el, url, { width: px, margin: 0 });
  };

  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
  render();
  if (window.ResizeObserver) new ResizeObserver(render).observe(box);
  else window.addEventListener("resize", render);
}
async function renderCarnet(){
  const auth = window.CARITAS?.auth;
  const user = auth?.currentUser || null;

  // backend (si existe) + local
  if (user && !lastCred) await ensureLastCred(user);

  // primero restaurar LS (tiene prioridad visual)
  restoreFromLocal();
  const d = loadLocal();

  // nombre/rol fallback
  if (!d.nombre){
    const n = lastCred?.nombre || user?.displayName || (user?.email||"").split("@")[0] || "Voluntario";
    $("#nombre").textContent = n;
    $("#input-nombre").value = n;
    saveLocal({nombre:n});
  }
  if (!d.rol && lastCred?.rol){
    $("#rol").textContent = lastCred.rol;
    saveLocal({rol:lastCred.rol});
  }
  if (!d.fotoDataUrl && lastCred?.foto_url){
    $("#foto").src = lastCred.foto_url;
  }

  // QR s√≥lo reverso
  const qrWrap = $("#qr-wrap");
  const showQR = $("#toggle-qr")?.checked;
  qrWrap?.classList.toggle("hidden", !showQR);
  if (showQR){
    const qrUrl = new URL(`credenciales.html?view=public&id=${user?.uid||"anon"}`, document.baseURI).href;
    await drawQR("qr-back", qrUrl);
  }
}

/* ====== CONMUTADORES (frente y reverso) ====== */
const FRONT_TPLS = {
  blanco: "assets/plantillas/cred-frente-blanco.png",
  negro:  "assets/plantillas/cred-frente-negro.png",
};
const BACK_TPLS = {
  blanco: "assets/plantillas/cred-reverso.png",
  negro:  "assets/plantillas/cred-reverso-negro.png",
};

function setDisenoFrente(key){
  const frontImg = $("#tpl-img-front");
  if (frontImg) frontImg.src = FRONT_TPLS[key] || FRONT_TPLS.blanco;

  document.body.classList.toggle("tema-negro",  key==="negro");
  document.body.classList.toggle("tema-blanco", key==="blanco");

  // Presets de foto por dise√±o
  if (key === "negro"){
    setVar("--cx", "27.6mm"); setVar("--cy", "18.3mm"); setVar("--d",  "34.2mm");
  } else {
    setVar("--cx", "28.2mm"); setVar("--cy", "21.6mm"); setVar("--d",  "34.0mm");
  }
  saveLocal({frontDesign:key});
}
function setDisenoReverso(key){
  const backImg = $("#tpl-img-back");
  if (backImg) backImg.src = BACK_TPLS[key] || BACK_TPLS.blanco;

  // Presets del QR por dise√±o (ajusta si necesitas)
  if (key === "negro"){
    setVar("--qr-size", "19mm"); setVar("--qr-x", "7mm"); setVar("--qr-y", "8mm");
  } else {
    setVar("--qr-size", "19mm"); setVar("--qr-x", "7mm"); setVar("--qr-y", "8mm");
  }
  saveLocal({backDesign:key});
}
function initDisenos(){
  // Frente
  const radiosF = [...document.querySelectorAll('input[name="diseno"]')];
  const savedF  = loadLocal().frontDesign || "negro";
  (radiosF.find(r=>r.value===savedF)||radiosF[0]).checked = true;
  setDisenoFrente(savedF);
  radiosF.forEach(r => r.addEventListener("change", e => { if(e.target.checked){ setDisenoFrente(e.target.value); renderCarnet(); }}));
  window.addEventListener("keydown", ev=>{
    if (ev.key.toLowerCase() !== "t") return;
    const cur = loadLocal().frontDesign || "negro";
    const next = cur === "negro" ? "blanco" : "negro";
    (radiosF.find(r=>r.value===next)||radiosF[0]).checked = true;
    setDisenoFrente(next); renderCarnet();
  });

  // Reverso
  const radiosB = [...document.querySelectorAll('input[name="reverso"]')];
  const savedB  = loadLocal().backDesign || "blanco";
  (radiosB.find(r=>r.value===savedB)||radiosB[0]).checked = true;
  setDisenoReverso(savedB);
  radiosB.forEach(r => r.addEventListener("change", e => { if(e.target.checked){ setDisenoReverso(e.target.value); renderCarnet(); }}));
  window.addEventListener("keydown", ev=>{
    if (ev.key.toLowerCase() !== "r") return;
    const cur = loadLocal().backDesign || "blanco";
    const next = cur === "negro" ? "blanco" : "negro";
    (radiosB.find(r=>r.value===next)||radiosB[0]).checked = true;
    setDisenoReverso(next); renderCarnet();
  });
}

/* ====== ENTRADAS ====== */
function initInputs(){
  const inNombre = $("#input-nombre");
  inNombre?.addEventListener("input", () => {
    const v = inNombre.value.trim() || "‚Äî";
    $("#nombre").textContent = v;
    saveLocal({nombre:v});
    if (lastCred) lastCred.nombre = v;
  });

  $("#toggle-qr")?.addEventListener("change", (e) => {
    saveLocal({showQR: e.target.checked});
    renderCarnet();
  });

  // Foto -> preview y guardar comprimida
  const inFoto = $("#input-foto");
  let lastBlobUrl = null;
  inFoto?.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
    lastBlobUrl = URL.createObjectURL(file);     // preview r√°pida
    $("#foto").src = lastBlobUrl;
    // versi√≥n comprimida persistente
    try{
      const dataUrl = await fileToDataURL(file, 900);
      saveLocal({fotoDataUrl: dataUrl});
    }catch(err){ console.warn("No se pudo comprimir/guardar foto", err); }
  });
}

/* ====== MOVIMIENTO FINO (brand y QR) + FOTO por teclado + guardado layout ====== */
function px(n){ return Number(n.toFixed(2)); }
function initMove(){
  const brand = $("#brand-front");
  const qrBox = $("#qr-wrap");
  brand?.classList.add("draggable"); qrBox?.classList.add("draggable");

  const makeDrag = (el)=>{
    if (!el) return;
    let dragging=false, dx=0, dy=0;
    el.addEventListener("pointerdown",(e)=>{ dragging=true; el.setPointerCapture(e.pointerId); dx=e.clientX; dy=e.clientY; });
    el.addEventListener("pointermove",(e)=>{ if(!dragging) return; el.style.transform=`translate(${px(e.clientX-dx)}px, ${px(e.clientY-dy)}px)`; });
    const end= (e)=>{ if(!dragging) return; dragging=false; el.releasePointerCapture?.(e.pointerId); };
    el.addEventListener("pointerup", end); el.addEventListener("pointercancel", end);
  };
  makeDrag(brand); makeDrag(qrBox);

  // ALT + flechas: mover brand o QR (si visible)
  window.addEventListener("keydown",(e)=>{
    if(!e.altKey) return;
    const target = (!$("#qr-wrap")?.classList.contains("hidden")) ? $("#qr-wrap") : brand;
    const st = getComputedStyle(target);
    const m = st.transform.match(/matrix\(([^)]+)\)/);
    let tx=0, ty=0; if(m){ const a=m[1].split(",").map(Number); tx=a[4]||0; ty=a[5]||0; }
    const step = e.shiftKey ? 2 : 0.5;
    if(e.key==="ArrowLeft"){ tx-=step; } else if(e.key==="ArrowRight"){ tx+=step; }
    else if(e.key==="ArrowUp"){ ty-=step; } else if(e.key==="ArrowDown"){ ty+=step; } else return;
    e.preventDefault(); target.style.transform = `translate(${px(tx)}px, ${px(ty)}px)`;
  });

  // CTRL + flechas: mover centro de FOTO + zoom
  window.addEventListener("keydown",(e)=>{
    if(!e.ctrlKey) return;
    const step = e.shiftKey ? 2 : 0.5; // mm
    const curX = mm(getComputedStyle(document.documentElement).getPropertyValue("--cx"));
    const curY = mm(getComputedStyle(document.documentElement).getPropertyValue("--cy"));
    let nx = curX, ny = curY;
    if(e.key==="ArrowLeft"){ nx = curX - step; }
    else if(e.key==="ArrowRight"){ nx = curX + step; }
    else if(e.key==="ArrowUp"){ ny = curY - step; }
    else if(e.key==="ArrowDown"){ ny = curY + step; }
    else if(e.key==="=" || e.key==="+"){ setVarMM("--d", mm(getComputedStyle(document.documentElement).getPropertyValue("--d")) + (e.shiftKey ? 2 : 0.5)); e.preventDefault(); return; }
    else if(e.key==="-" || e.key==="_"){ setVarMM("--d", Math.max(10, mm(getComputedStyle(document.documentElement).getPropertyValue("--d")) - (e.shiftKey ? 2 : 0.5))); e.preventDefault(); return; }
    else { return; }
    setVarMM("--cx", nx); setVarMM("--cy", ny);
    e.preventDefault();
  });

  // Guardar layout (vars + transforms + visibilidad QR)
  $("#btn-guardar-layout")?.addEventListener("click", ()=>{
    const root = getComputedStyle(document.documentElement);
    const vars = ["--cx","--cy","--d","--card-w","--card-h","--qr-size","--qr-x","--qr-y"];
    const obj = Object.fromEntries(vars.map(v => [v, root.getPropertyValue(v).trim()]));
    obj.brandTransform = getComputedStyle(brand).transform;
    obj.qrTransform    = getComputedStyle(qrBox).transform;
    obj.qrVisible      = !qrBox.classList.contains("hidden");
    try{ LS.setItem(LAYOUT_KEY, JSON.stringify(obj)); alert("Layout guardado."); }catch{}
  });

  // Cargar layout si existe
  try{
    const raw = LS.getItem(LAYOUT_KEY);
    if(raw){
      const obj = JSON.parse(raw);
      Object.entries(obj).forEach(([k,v])=>{
        if(k==="brandTransform"){ brand.style.transform = v || "none"; }
        else if(k==="qrTransform"){ $("#qr-wrap").style.transform = v || "none"; }
        else if(k==="qrVisible"){ $("#toggle-qr").checked = !!v; $("#qr-wrap").classList.toggle("hidden", !v); saveLocal({showQR:!!v}); }
        else if(k.startsWith("--")) setVar(k, v);
      });
    }
  }catch(e){}
}

/* ====== DESCARGA PNG ====== */
async function descargarPNG(){
  const node = document.getElementById("sheet");
  const scale = Math.max(2, Math.round(window.devicePixelRatio||1));
  const canvas = await html2canvas(node, { backgroundColor: null, scale, useCORS: true, logging: false });
  const a = document.createElement("a");
  a.download = "credencial-caritas.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
}

/* ====== AUTH (opcional) ====== */
function initAuth(){
  document.addEventListener("firebase:ready:caritas", () => {
    const auth = window.CARITAS?.auth;
    if (!auth) return;
    // Mostrar bot√≥n logout si hay sesi√≥n
    onAuthStateChanged(auth, (user) => {
      const btn = document.getElementById("btn-logout");
      if (user) { btn.style.display = ""; }
      else { btn.style.display = "none"; }
    });
    document.getElementById("btn-logout")?.addEventListener("click", async ()=>{
      try{ await signOut(auth); alert("Sesi√≥n cerrada."); }catch(e){ console.warn(e); }
    });
  });
}

/* ====== INIT ====== */
function init(){
  initDisenos();
  initInputs();
  initMove();
  initAuth();
  renderCarnet();
  document.getElementById("btn-descargar")?.addEventListener("click", descargarPNG);
}
init();
</script>
</body>
</html>