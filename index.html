<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#b71c1c" />
  <title>C√°ritas CNC</title>
  
  <base href="/Web-familias/">
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script type="module" src="api.js/health-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>
  <link rel="icon" href="img/favicon.ico" />
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- ‚úÖ Pol√≠tica CSP corregida -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://www.gstatic.com;
             style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js" defer></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- ‚úÖ ESM: QRCode -->
<script type="module">
  import QRCode from "https://esm.sh/qrcode@1";
  // Lo expongo global porque tu c√≥digo lo usa como global
  window.QRCode = QRCode;
  console.log("‚úÖ QRCode (ESM) listo");
</script>

<!-- ‚úÖ ESM: jsQR -->
<script type="module">
  import jsQR from "https://esm.sh/jsqr@1.4.0";
  window.jsQR = jsQR;
  console.log("‚úÖ jsQR (ESM) listo");
</script>

<!-- ‚úÖ ESM: html2canvas -->
<script type="module">
  import html2canvas from "https://esm.sh/html2canvas@1.4.1";
  window.html2canvas = html2canvas;
  console.log("‚úÖ html2canvas (ESM) listo");
</script>

  <!-- Firebase (C√°ritas) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script defer src="api.js/firebase-config-caritas.js"></script>

  <!-- ‚úÖ Supabase (ESM, sin eval) -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.CARITAS = window.CARITAS || {};
    window.CARITAS.supabase = supabase;

    console.log("‚úÖ Supabase inicializado sin eval (C√°ritas).");
  </script>

  <!-- Router SPA -->
  <script defer src="api.js/app-router-caritas.js"></script>

  <style>
    /* S√≥lo trazos m√≠nimos; el tema viene de styles-caritas.css */
    #status-bar{position:fixed;left:0;right:0;top:0;z-index:50;text-align:center;font-size:.9rem;padding:.35rem .6rem;display:none}
    #status-bar.offline{display:block;background:#111;color:#fff}
    .header-right{display:flex;gap:.4rem;align-items:center}
    .user-pill{display:none;align-items:center;gap:.4rem;background:#111;color:#fff;border-radius:999px;padding:.25rem .55rem}
    .user-pill img{width:22px;height:22px;border-radius:50%;object-fit:cover;border:2px solid #b71c1c}
    .brand-pin, .brand-home{cursor:pointer}
    .skeleton{animation:pulse 1.2s ease-in-out infinite;background:linear-gradient(90deg,#0000,#0002 40%,#0000 60%),var(--surface,#111);min-height:180px;border-radius:12px}
    @keyframes pulse{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @media (prefers-reduced-motion: reduce){
      #video-fondo{display:none !important}
    }
  </style>
</head>
<body>
  <!-- Conectividad -->
  <div id="status-bar" aria-live="polite"></div>

  <!-- üé• Video de fondo -->
  <video id="video-fondo" autoplay muted loop>
    <source src="videos/fondo.mp4" type="video/mp4">
  </video>

  <!-- üîù Header -->
  <header class="app-header">
    <h1>
      <span id="pinLogin" class="brand-pin" title="Iniciar sesi√≥n">üìå</span>
      <span id="brandHome" class="brand-home" title="Ir a Inicio">C√°ritas CNC</span>
    </h1>

    <nav id="main-nav" aria-label="Navegaci√≥n principal">
      <button data-view="inicio" aria-current="page">üè† Inicio</button>
      <button data-view="registro-fam" data-newtab>üë®‚Äçüë©‚Äçüëß Registro</button>
      <button data-view="perfil" id="btnPerfil" style="display:none" data-newtab>üë§ Perfil</button>
      <button data-view="servicios" id="btnServicios" style="display:none" data-newtab>‚öôÔ∏è Servicios</button>
      <button id="btnLogout" style="display:none">üîí Salir</button>
    </nav>

    <div class="header-right">
      <div id="userPill" class="user-pill" title="Sesi√≥n activa">
        <img id="userAvatar" src="img/avatar-placeholder.png" alt="Avatar" />
        <span id="userName">‚Äî</span>
        <small id="userRole" class="pill" style="margin-left:.25rem">voluntario</small>
      </div>
    </div>
  </header>

  <!-- üîî Bienvenida din√°mica -->
  <section id="bienvenida" class="card center" style="margin:1rem auto;max-width:800px;display:none">
    <h2 id="bienvenida-text">üëã Bienvenid@ a tu plataforma de servicio</h2>
  </section>

  <!-- üìå Contenedor din√°mico -->
  <main id="app" class="seccion active" aria-live="polite">
    <div class="card skeleton" style="margin:1rem auto;max-width:960px;"></div>
  </main>

  <noscript>
    <div class="card" style="max-width:960px;margin:1rem auto">
      <h2>‚ö†Ô∏è JavaScript deshabilitado</h2>
      <p>Activa JavaScript para usar la aplicaci√≥n.</p>
    </div>
  </noscript>

<!-- === Scripts de UI y l√≥gica === -->
<script>
(() => {
  'use strict';

  const nav = document.getElementById('main-nav');
  const statusBar = document.getElementById('status-bar');
  const video = document.getElementById('video-fondo');

  const pinLogin = document.getElementById('pinLogin');
  const brandHome = document.getElementById('brandHome');

  const btnPerfil = document.getElementById('btnPerfil');
  const btnServicios = document.getElementById('btnServicios');
  const btnLogout = document.getElementById('btnLogout');

  const userPill = document.getElementById('userPill');
  const userAvatar = document.getElementById('userAvatar');
  const userName = document.getElementById('userName');
  const userRole = document.getElementById('userRole');

  // ===== Conectividad =====
  function updateOnlineStatus(){
    if (navigator.onLine) {
      statusBar.className = '';
      statusBar.textContent = '';
    } else {
      statusBar.className = 'offline';
      statusBar.textContent = 'üîå Sin conexi√≥n: algunas funciones no estar√°n disponibles.';
    }
  }
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();

  // ===== Accesibilidad: marcar activo =====
  function markActive(view){
    nav.querySelectorAll('button[data-view]').forEach(b => {
      const active = b.dataset.view === view;
      b.classList.toggle('active', active);
      b.setAttribute('aria-current', active ? 'page' : 'false');
    });
  }

  // ===== Preferencias de movimiento =====
  function applyReducedMotionPreference(){
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches && video) {
      video.pause();
    }
  }
  applyReducedMotionPreference();

  // ===== Header desde storage =====
  function hydrateHeaderFromStorage(){
    try {
      const u = JSON.parse(localStorage.getItem('caritasUser') || '{}');
      const rol = u.rol || 'invitado';
      const name = (u.email || '‚Äî').split('@')[0];
      const logged = !!u.uid;

      btnPerfil.style.display = logged ? '' : 'none';
      btnServicios.style.display = logged ? '' : 'none';
      btnLogout.style.display = logged ? '' : 'none';

      if (logged) {
        userPill.style.display = 'inline-flex';
        userName.textContent = name;
        userRole.textContent = rol;
        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=111&color=fff`;
      } else {
        userPill.style.display = 'none';
      }
    } catch {}
  }
  hydrateHeaderFromStorage();

  // ===== Firebase listo =====
  document.addEventListener('firebase:ready:caritas', () => {
    const user = window.CARITAS?.auth?.currentUser;
    if (user) {
      btnPerfil.style.display = '';
      btnServicios.style.display = '';
      btnLogout.style.display = '';
      const stored = JSON.parse(localStorage.getItem('caritasUser') || '{}');
      if (!stored?.uid) {
        localStorage.setItem('caritasUser', JSON.stringify({
          email: user.email,
          uid: user.uid,
          rol: stored.rol || 'voluntario'
        }));
      }
    } else {
      btnPerfil.style.display = 'none';
      btnServicios.style.display = 'none';
      btnLogout.style.display = 'none';
    }
    hydrateHeaderFromStorage();
  });

  // ===== Logout =====
  btnLogout?.addEventListener('click', async () => {
    try { await window.CARITAS?.auth?.signOut(); } catch(e) {}
    localStorage.removeItem('caritasUser');
    location.hash = '#login';
  });

  // ===== Tachuela (üìå) =====
  pinLogin.addEventListener('click', () => {
    const u = JSON.parse(localStorage.getItem('caritasUser') || '{}');
    if (u?.uid || window.CARITAS?.auth?.currentUser) {
      window.open(`${location.origin}${location.pathname}#carnet`, '_blank', 'noopener');
    } else {
      location.hash = '#login';
    }
  });

  // ===== T√≠tulo ‚Üí Inicio =====
  brandHome.addEventListener('click', () => {
    if (window.CARITAS?.goto) window.CARITAS.goto('inicio');
    else location.hash = '#inicio';
  });

  // ===== Notificaciones =====
  async function setupNotifications(){
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
      try { await Notification.requestPermission(); } catch {}
    }
    window.enviarNotificacion = async (title, body) => {
      try {
        if (Notification.permission !== 'granted') return;
        const reg = await navigator.serviceWorker?.getRegistration();
        if (reg) reg.showNotification(title, { body, icon: 'icon-192.png', badge: 'icon-192.png' });
        else new Notification(title, { body });
      } catch {}
    };
  }
  document.addEventListener('DOMContentLoaded', setupNotifications);
  document.addEventListener('firebase:ready:caritas', setupNotifications);

  // ===== Bienvenida din√°mica =====
  (function bienvenidaBlock(){
    const bienvenida = document.getElementById('bienvenida');
    const bienvenidaText = document.getElementById('bienvenida-text');

    function getStoredUser(){ 
      try { return JSON.parse(localStorage.getItem('caritasUser')||'null'); } 
      catch { return null; } 
    }
    function getFirebaseUser(){ return window.CARITAS?.auth?.currentUser || null; }
    function computeNombre(uS,uF){
      const email = uS?.email || uF?.email;
      const nom = (uS?.nombre||'').trim() || (email ? email.split('@')[0] : '');
      return nom;
    }
    function refresh(){
      if (!bienvenida || !bienvenidaText) return;
      const uS = getStoredUser(); 
      const uF = getFirebaseUser(); 
      const nombre = computeNombre(uS,uF);
      if (nombre) { 
        bienvenidaText.textContent = `üëã ¬°Bienvenid@, ${nombre}!`; 
        bienvenida.style.display=''; 
      } else { 
        bienvenida.style.display='none'; 
      }
    }

    document.addEventListener('DOMContentLoaded', refresh);
    document.addEventListener('firebase:ready:caritas', () => {
      try { window.CARITAS?.auth?.onAuthStateChanged(() => refresh()); } catch {}
      refresh();
    });
    window.addEventListener('storage', (e)=>{ if (e.key==='caritasUser') refresh(); });
    setTimeout(refresh, 500);
  })();

  // ===== Navegaci√≥n (abrir vistas en nueva pesta√±a) =====
  nav.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-view]');
    if (!btn) return;
    const view = btn.dataset.view;

    if (view && view !== 'inicio') {
      e.preventDefault();
      const url = `${location.origin}/Web-familias/pestanas/${view}.html`;
      window.open(url, '_blank', 'noopener');
      return;
    }
    location.hash = '#inicio';
  });

  // ===== Hash activo en header =====
  function initActiveFromHash(){ 
    const v = (location.hash || '#inicio').replace('#',''); 
    markActive(v); 
  }
  window.addEventListener('hashchange', initActiveFromHash);
  document.addEventListener('DOMContentLoaded', initActiveFromHash);

  // ===== Fallback si falla el video =====
  video?.addEventListener('error', () => document.body.classList.add('no-video'));
})();
</script>
<!-- L√≥gica del listado (carga global) -->
<script defer src="api.js/familias.js"></script>
<script>
  // Ejecuta el listado cuando el router termine de inyectar la vista
  document.addEventListener('view:loaded:caritas', (e) => {
    const v = e.detail?.view;
    if (v === 'listado' || v === 'familias-list') {
      if (window.initListadoView)      window.initListadoView();
      else if (window.initFamiliasView) window.initFamiliasView();
      else if (window.initFamilias)     window.initFamilias();
    }
  });
</script>
</body>
</html>