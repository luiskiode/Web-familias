<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#b71c1c" />
  <title>CÃ¡ritas CNC</title>

  <link rel="icon" href="img/favicon.ico" />
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js" defer></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- Utilidades -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

 <!-- Firebase (CÃ¡ritas) -->
<script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script defer src="api.js/firebase-config-caritas.js"></script>

  <!-- Supabase (CÃ¡ritas) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script defer src="api.js/supabase-config-caritas.js"></script>

  <!-- Router SPA -->
  <script defer src="api.js/app-router-caritas.js"></script>

  <style>
    /* SÃ³lo trazos mÃ­nimos; el tema viene de styles-caritas.css */
    #status-bar{position:fixed;left:0;right:0;top:0;z-index:50;text-align:center;font-size:.9rem;padding:.35rem .6rem;display:none}
    #status-bar.offline{display:block;background:#111;color:#fff}
    .header-right{display:flex;gap:.4rem;align-items:center}
    .user-pill{display:none;align-items:center;gap:.4rem;background:#111;color:#fff;border-radius:999px;padding:.25rem .55rem}
    .user-pill img{width:22px;height:22px;border-radius:50%;object-fit:cover;border:2px solid #b71c1c}
    .brand-pin, .brand-home{cursor:pointer}
    .skeleton{animation:pulse 1.2s ease-in-out infinite;background:linear-gradient(90deg,#0000,#0002 40%,#0000 60%),var(--surface,#111);min-height:180px;border-radius:12px}
    @keyframes pulse{0%{background-position:-200% 0}100%{background-position:200% 0}}
    @media (prefers-reduced-motion: reduce){
      #video-fondo{display:none !important}
    }
  </style>
</head>
<body>
  <!-- Conectividad -->
  <div id="status-bar" aria-live="polite"></div>

  <!-- ğŸ¥ Video de fondo -->
  <video id="video-fondo" autoplay muted loop>
    <source src="videos/fondo.mp4" type="video/mp4">
  </video>

  <!-- ğŸ” Header -->
  <header class="app-header">
    <h1>
      <span id="pinLogin" class="brand-pin" title="Iniciar sesiÃ³n">ğŸ“Œ</span>
      <span id="brandHome" class="brand-home" title="Ir a Inicio">CÃ¡ritas CNC</span>
    </h1>

    <nav id="main-nav" aria-label="NavegaciÃ³n principal">
      <button data-view="inicio" aria-current="page">ğŸ  Inicio</button>
      <button data-view="registro-fam" data-newtab>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Registro</button>
      <button data-view="perfil" id="btnPerfil" style="display:none" data-newtab>ğŸ‘¤ Perfil</button>
      <button data-view="servicios" id="btnServicios" style="display:none" data-newtab>âš™ï¸ Servicios</button>
      <!-- BotÃ³n Ingresar eliminado: la tachuela ğŸ“Œ hace login -->
      <button id="btnLogout" style="display:none">ğŸ”’ Salir</button>
    </nav>

    <div class="header-right">
      <div id="userPill" class="user-pill" title="SesiÃ³n activa">
        <img id="userAvatar" src="img/avatar-placeholder.png" alt="Avatar" />
        <span id="userName">â€”</span>
        <small id="userRole" class="pill" style="margin-left:.25rem">voluntario</small>
      </div>
    </div>
  </header>

  <!-- ğŸ”” Bienvenida dinÃ¡mica -->
  <section id="bienvenida" class="card center" style="margin:1rem auto;max-width:800px;display:none">
    <h2 id="bienvenida-text">ğŸ‘‹ Bienvenid@ a tu plataforma de servicio</h2>
  </section>

  <!-- ğŸ“Œ Contenedor dinÃ¡mico -->
  <main id="app" class="seccion active" aria-live="polite">
    <div class="card skeleton" style="margin:1rem auto;max-width:960px;"></div>
  </main>

  <noscript>
    <div class="card" style="max-width:960px;margin:1rem auto">
      <h2>âš ï¸ JavaScript deshabilitado</h2>
      <p>Activa JavaScript para usar la aplicaciÃ³n.</p>
    </div>
  </noscript>

  <script>
  (() => {
    'use strict';

    const nav = document.getElementById('main-nav');
    const statusBar = document.getElementById('status-bar');
    const video = document.getElementById('video-fondo');

    const pinLogin = document.getElementById('pinLogin');
    const brandHome = document.getElementById('brandHome');

    const btnPerfil = document.getElementById('btnPerfil');
    const btnServicios = document.getElementById('btnServicios');
    const btnLogout = document.getElementById('btnLogout');

    const userPill = document.getElementById('userPill');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userRole = document.getElementById('userRole');

    // ===== Conectividad =====
    function updateOnlineStatus(){
      if (navigator.onLine) { statusBar.className=''; statusBar.textContent=''; }
      else { statusBar.className='offline'; statusBar.textContent='ğŸ”Œ Sin conexiÃ³n: algunas funciones no estarÃ¡n disponibles.'; }
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    // ===== Accesibilidad: marcar activo =====
    function markActive(view){
      nav.querySelectorAll('button[data-view]').forEach(b => {
        const active = b.dataset.view === view;
        b.classList.toggle('active', active);
        b.setAttribute('aria-current', active ? 'page' : 'false');
      });
    }

    // ===== Preferencias de movimiento =====
    function applyReducedMotionPreference(){
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches && video) video.pause();
    }
    applyReducedMotionPreference();

    // ===== Header desde storage =====
    function hydrateHeaderFromStorage(){
      try {
        const u = JSON.parse(localStorage.getItem('caritasUser') || '{}');
        const rol = u.rol || 'invitado';
        const name = (u.email || 'â€”').split('@')[0];
        const logged = !!u.uid;

        btnPerfil.style.display = logged ? '' : 'none';
        btnServicios.style.display = logged ? '' : 'none';
        btnLogout.style.display = logged ? '' : 'none';

        if (logged) {
          userPill.style.display = 'inline-flex';
          userName.textContent = name;
          userRole.textContent = rol;
          userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=111&color=fff`;
        } else {
          userPill.style.display = 'none';
        }
      } catch {}
    }
    hydrateHeaderFromStorage();

    // ===== Firebase listo =====
    document.addEventListener('firebase:ready:caritas', () => {
      const user = window.CARITAS?.auth?.currentUser;
      if (user) {
        btnPerfil.style.display = '';
        btnServicios.style.display = '';
        btnLogout.style.display = '';
        const stored = JSON.parse(localStorage.getItem('caritasUser') || '{}');
        if (!stored?.uid) {
          localStorage.setItem('caritasUser', JSON.stringify({
            email: user.email, uid: user.uid, rol: stored.rol || 'voluntario'
          }));
        }
      } else {
        btnPerfil.style.display = 'none';
        btnServicios.style.display = 'none';
        btnLogout.style.display = 'none';
      }
      hydrateHeaderFromStorage();
    });

    // ===== Logout =====
    btnLogout?.addEventListener('click', async () => {
      try { await window.CARITAS?.auth?.signOut(); } catch(e) {}
      localStorage.removeItem('caritasUser');
      location.href = 'login.html';
    });

    // ===== Tachuela (ğŸ“Œ) â†’ Login si no hay sesiÃ³n, si hay sesiÃ³n abre credencial en nueva pestaÃ±a
    pinLogin.addEventListener('click', () => {
      const u = JSON.parse(localStorage.getItem('caritasUser') || '{}');
      if (u?.uid || window.CARITAS?.auth?.currentUser) {
        window.open('carnet.html', '_blank', 'noopener');
      } else {
        location.href = 'login.html';
      }
    });

    // ===== TÃ­tulo â†’ Inicio
    brandHome.addEventListener('click', () => {
      if (window.CARITAS?.goto) window.CARITAS.goto('inicio');
      else location.hash = '#inicio';
    });

    // ===== Notificaciones (activa permiso y util global)
    async function setupNotifications(){
      if (!('Notification' in window)) return;
      if (Notification.permission === 'default') {
        try { await Notification.requestPermission(); } catch {}
      }
      window.enviarNotificacion = async (title, body) => {
        try {
          if (Notification.permission !== 'granted') return;
          const reg = await navigator.serviceWorker?.getRegistration();
          if (reg) { reg.showNotification(title, { body, icon: 'icon-192.png', badge: 'icon-192.png' }); }
          else { new Notification(title, { body }); }
        } catch {}
      };
    }
    document.addEventListener('DOMContentLoaded', setupNotifications);
    document.addEventListener('firebase:ready:caritas', setupNotifications);

  // === Bienvenida dinÃ¡mica robusta (usa storage o auth actual) ===
(function bienvenidaBlock(){
  const bienvenida = document.getElementById('bienvenida');
  const bienvenidaText = document.getElementById('bienvenida-text');

  function getStoredUser() { try { return JSON.parse(localStorage.getItem('caritasUser')||'null'); } catch { return null; } }
  function getFirebaseUser(){ return window.CARITAS?.auth?.currentUser || null; }
  function computeNombre(uS, uF){
    const email = uS?.email || uF?.email;
    const nom = (uS?.nombre||'').trim() || (email ? email.split('@')[0] : '');
    return nom;
  }
  function refresh(){
    if (!bienvenida || !bienvenidaText) return;
    const uS = getStoredUser(); const uF = getFirebaseUser(); const nombre = computeNombre(uS,uF);
    if (nombre) { bienvenidaText.textContent = `ğŸ‘‹ Â¡Bienvenid@, ${nombre}!`; bienvenida.style.display=''; }
    else { bienvenida.style.display='none'; }
  }
  
  // Arranques y eventos relevantes
  document.addEventListener('DOMContentLoaded', refresh);
  document.addEventListener('firebase:ready:caritas', () => {
    try { window.CARITAS?.auth?.onAuthStateChanged(() => refresh()); } catch {}
    refresh();
  });
  window.addEventListener('storage', (e)=>{ if (e.key==='caritasUser') refresh(); });
  setTimeout(refresh, 500);
})();

    // ===== NavegaciÃ³n: abrir pestaÃ±as en nueva ventana (todas excepto inicio)
    nav.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-view]');
      if (!btn) return;
      const view = btn.dataset.view;
      if (view && view !== 'inicio') {
        e.preventDefault();
        const url = `${location.origin}${location.pathname}#${view}`;
        window.open(url, '_blank', 'noopener');
      } else {
        // deja que el router navegue en esta pestaÃ±a
      }
    });

    // Marcar activo por hash
    function initActiveFromHash(){ const v=(location.hash||'#inicio').replace('#',''); markActive(v); }
    window.addEventListener('hashchange', initActiveFromHash);
    document.addEventListener('DOMContentLoaded', initActiveFromHash);

    // Fallback si falla el video
    video?.addEventListener('error', () => document.body.classList.add('no-video'));
  })();
  </script>
</body>
</html>