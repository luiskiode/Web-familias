<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#b91c1c" />
  <title>Cáritas CNC</title>
  
  <base href="/Web-familias/">
  <link rel="icon" href="img/favicon.ico" />
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- ✅ CSP -->
  <meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
           script-src 'self' 'unsafe-inline' https://esm.sh https://unpkg.com https://www.gstatic.com;
           style-src 'self' 'unsafe-inline' https://unpkg.com;
           img-src * data: blob:;
           connect-src *;
           font-src * data:;">

  <!-- 🛠 Herramientas de diagnóstico -->
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>

  <!-- ✅ Supabase ESM -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw"; // ⚠️ reemplaza con tu anon key

    window.CARITAS = window.CARITAS || {};
    window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    document.dispatchEvent(new Event("supabase:ready:caritas"));
  </script>
</head>
<body>
  <!-- 🎥 Fondo -->
  <video id="video-fondo" autoplay muted loop>
    <source src="videos/fondo.mp4" type="video/mp4">
  </video>

  <!-- Encabezado -->
  <header class="app-header">
    <h1>Cáritas CNC</h1>
  </header>

  <!-- 📌 Misión y Visión -->
  <section class="container card">
    <h2>🌟 Nuestra Misión</h2>
    <p>
      Servir a las familias más necesitadas con solidaridad, acompañamiento y amor cristiano,
      promoviendo la dignidad y la esperanza.
    </p>
    <h2>👁️ Nuestra Visión</h2>
    <p>
      Ser una comunidad unida que transforma la realidad de las familias vulnerables,
      sembrando valores de fe, justicia y caridad.
    </p>
  </section>

  <!-- 📂 Botón a Google Drive -->
  <section class="container card center">
    <a class="btn" href="https://drive.google.com/drive/folders/1OaDPvylPIL_5ySTv4zWiU0YHbiZJiIpv?usp=drive_link" target="_blank">📂 Acceder a Drive</a>
  </section>

<!-- 🎫 Credenciales (botón único) -->
<section class="container card center">
  <h2>🎫 Credenciales Cáritas CNC</h2>
  <p>Gestiona tu carnet, comparte el enlace público y, si eres Admin, administra todas las credenciales.</p>
  <a class="btn" href="credenciales.html">🪪 Abrir Credenciales</a>
</section>
  
  <!-- 📋 Formulario Integral -->
  <section class="container card">
  <h2>📋 Registro Integral de Familia</h2>
  <p>Complete todos los datos requeridos para registrar su solicitud de ayuda.</p>

  <form id="famForm" enctype="multipart/form-data">

    <!-- I. DATOS BÁSICOS -->
    <fieldset>
      <legend>I. Datos Básicos</legend>
      <div class="form-grid">
        <label>👤 Nombre y apellidos*<br>
          <input type="text" id="nombres_apellidos" required>
        </label>
        <label>📍 Dirección*<br>
          <input type="text" id="direccion" required>
        </label>
        <label>📞 Teléfono*<br>
          <input type="tel" id="telefono_contacto" required>
        </label>
      </div>
      <div class="form-grid">
        <label>🪪 DNI<br>
          <input type="text" id="dni_solicitante">
        </label>
        <label>👨‍👩‍👧 Apellido de la familia<br>
          <input type="text" id="apellido_familia">
        </label>
      </div>
      <label>📝 Observaciones<br>
        <textarea id="observaciones" rows="3"></textarea>
      </label>
      <label>📂 Subir archivo<br>
        <input type="file" id="archivo" accept=".pdf,.doc,.docx,.jpg,.png">
      </label>
    </fieldset>

    <!-- II. DATOS COMPLEMENTARIOS -->
    <fieldset>
      <legend>II. Datos Complementarios</legend>
      <div class="form-grid">
        <label>Jefe(a) de hogar<br><input type="text" id="jefe_hogar"></label>
        <label>Edad<br><input type="number" id="edad"></label>
        <label>Estado civil<br>
          <select id="estado_civil">
            <option value="">Seleccione...</option>
            <option>Soltero(a)</option><option>Casado(a)</option>
            <option>Conviviente</option><option>Divorciado(a)</option><option>Viudo(a)</option>
          </select>
        </label>
      </div>
      <div class="form-grid">
        <label>Ocupación<br><input type="text" id="ocupacion"></label>
        <label>Grado de instrucción<br>
          <select id="instruccion">
            <option value="">Seleccione...</option>
            <option>Sin estudios</option><option>Primaria</option><option>Secundaria</option>
            <option>Técnico</option><option>Universitario</option><option>Otro</option>
          </select>
        </label>
        <label>Integrantes<br><input type="number" id="num_integrantes"></label>
      </div>
      <label>Fecha entrevista<br><input type="date" id="fecha_entrevista"></label>
    </fieldset>

    <!-- III. SOCIO-ECONÓMICO -->
    <fieldset>
      <legend>III. Socio-Económico</legend>
      <div class="form-grid">
        <label>🏠 Casa precaria<br><select id="casa_precaria"><option></option><option>si</option><option>no</option></select></label>
        <label>💧 Servicios básicos<br><select id="servicios_basicos"><option></option><option>si</option><option>no</option></select></label>
        <label>🍽 Dificultad alimentos<br><select id="dificultad_alimentos"><option></option><option>si</option><option>no</option></select></label>
      </div>
      <div class="form-grid">
        <label>⚖️ Mínimo alimentario<br><select id="minimo_alimentario"><option></option><option>si</option><option>no</option></select></label>
        <label>👥 Hacinamiento<br><select id="hacinamiento"><option></option><option>si</option><option>no</option></select></label>
        <label>💸 Vendió pertenencias<br><select id="vende_pertenencias"><option></option><option>si</option><option>no</option></select></label>
      </div>
    </fieldset>

    <!-- IV. DISCAPACIDAD -->
    <fieldset>
      <legend>IV. Discapacidad</legend>
      <div class="form-grid">
        <label>Discapacidad grave<br><select id="discapacidad_grave"><option></option><option>si</option><option>no</option></select></label>
        <label>Tipo discapacidad<br><input type="text" id="tipo_discapacidad"></label>
        <label>Aparatos de ayuda<br><select id="aparatos_ayuda"><option></option><option>si</option><option>no</option></select></label>
      </div>
      <div class="form-grid">
        <label>Intelectual grave<br><select id="discapacidad_intelectual"><option></option><option>si</option><option>no</option></select></label>
        <label>Bajo tratamiento<br><select id="bajo_tratamiento"><option></option><option>si</option><option>no</option></select></label>
        <label>Requiere cuidador<br><select id="requiere_cuidador"><option></option><option>si</option><option>no</option></select></label>
      </div>
    </fieldset>

    <!-- V. VULNERABILIDAD -->
    <fieldset>
      <legend>V. Vulnerabilidad</legend>
      <div class="form-grid">
        <label>Abandono/depresión<br><select id="abandono_depresion"><option></option><option>si</option><option>no</option></select></label>
        <label>Enfermedad crónica<br><select id="enfermedad_cronica"><option></option><option>si</option><option>no</option></select></label>
        <label>Violencia<br><select id="violencia"><option></option><option>si</option><option>no</option></select></label>
      </div>
    </fieldset>

    <!-- VI. EDUCACIÓN -->
    <fieldset>
      <legend>VI. Educación</legend>
      <label>Niños fuera de escuela<br><select id="ninos_fuera_colegio"><option></option><option>si</option><option>no</option></select></label>
      <label>¿Quiénes?<br><input type="text" id="quienes_fuera"></label>
      <label>Causas<br><textarea id="causas_no_asistencia" rows="3"></textarea></label>
      <label>Dispuestos a retorno<br><select id="dispuesto_retorno"><option></option><option>si</option><option>no</option></select></label>
      <label>Apoyo requerido<br><input type="text" id="apoyo_requerido"></label>
    </fieldset>

    <!-- VII. PROGRAMAS -->
    <fieldset>
      <legend>VII. Programas del Estado</legend>
      <div class="form-grid">
        <label><input type="checkbox" name="programas_estado" value="Vaso de Leche"> Vaso de Leche</label>
        <label><input type="checkbox" name="programas_estado" value="Comedor Popular"> Comedor Popular</label>
        <label><input type="checkbox" name="programas_estado" value="Juntos"> Programa Juntos</label>
        <label><input type="checkbox" name="programas_estado" value="SIS"> SIS</label>
        <label><input type="checkbox" name="programas_estado" value="Pensión 65"> Pensión 65</label>
        <label><input type="checkbox" name="programas_estado" value="ONG"> ONG</label>
        <label><input type="checkbox" name="programas_estado" value="Otro"> Otro</label>
      </div>
      <label>¿Apoyo suficiente?<br><select id="apoyo_suficiente"><option></option><option>si</option><option>no</option></select></label>
      <label>Apoyo adicional<br><input type="text" id="apoyo_adicional"></label>
    </fieldset>

    <div class="center">
      <button type="submit" class="btn">💾 Guardar Familia</button>
    </div>
  </form>
</section>

   <!-- 👨‍👩‍👧 Familias registradas -->
  <main class="container card">
  <h2>👨‍👩‍👧 Familias Registradas</h2>
  <div id="msg"></div>

  <div class="table-wrapper">
    <table id="familiasTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombres</th>
          <th>Dirección</th>
          <th>Teléfono</th>
          <th>Visitada</th>
          <th>Mapa</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;">
    <button id="prevPage" class="btn">⏮ Anterior</button>
    <button id="nextPage" class="btn">Siguiente ⏭</button>
  </div>
</main>

<!-- 🔐 Firebase ESM bootstrap: inicializa y expone window.CARITAS.auth en esta página -->
<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD5X6LUG_dOwuaUf6jQUHw_LM5PFgOmc40",
    authDomain: "web-familias.firebaseapp.com",
    projectId: "web-familias",
    storageBucket: "web-familias.appspot.com",
    messagingSenderId: "261699620792",
    appId: "1:261699620792:web:8ff59afb72e96c371dc94d"
  };

  const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence).catch(()=>{});

  window.CARITAS = window.CARITAS || {};
  window.CARITAS.auth = auth;

  // Notifica listo y re-notifica en cada cambio
  document.dispatchEvent(new Event("firebase:ready:caritas"));
  onAuthStateChanged(auth, () => document.dispatchEvent(new Event("firebase:ready:caritas")));
</script>

<!-- ✅ Script de formulario y listado (con fallback a db.js) -->
<script type="module">
  const supabase = window.CARITAS?.supabase;
  const tabla = document.querySelector("#familiasTable tbody");
  const msg = document.getElementById("msg");
  let page = 0;
  const pageSize = 10;

  // Fallback para savePendiente si ./api.js/db.js no existe
  let savePendiente = async (datos) => {
    try {
      const k = "pendiente:" + Date.now();
      localStorage.setItem(k, JSON.stringify(datos));
      console.warn("db.js no encontrado. Guardado local simple en localStorage:", k);
    } catch(e) { console.warn("No se pudo guardar localmente:", e); }
  };
  try {
    const mod = await import("./api.js/db.js");
    if (mod?.savePendiente) savePendiente = mod.savePendiente;
  } catch(e) {
    console.warn("No se pudo importar ./api.js/db.js (ok en Pages):", e);
  }

  function showMsg(text, type="info"){
    msg.textContent = text;
    msg.className = type;
    setTimeout(()=>{ msg.textContent=""; },4000);
  }

  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  // Guardar familia
  const form = document.getElementById("famForm");
  form.addEventListener("submit", async e => {
    e.preventDefault();

    const datos = {
      nombres_apellidos: form.nombres_apellidos.value,
      direccion: form.direccion.value,
      telefono_contacto: form.telefono_contacto.value,
      dni_solicitante: form.dni_solicitante.value || null,
      apellido_familia: form.apellido_familia.value || null,
      observaciones: form.observaciones.value || null
    };

    if (!navigator.onLine) {
      await savePendiente(datos);
      alert("📦 Guardado local. Se enviará cuando vuelva internet.");
      if ("serviceWorker" in navigator && "SyncManager" in window) {
        const reg = await navigator.serviceWorker.ready;
        await reg.sync.register("sync-familias");
      }
    } else {
      const { error } = await supabase.from("familias").insert([datos]);
      if (error) {
        console.error("❌ Error guardando en Supabase:", error);
        alert("❌ Error al guardar en Supabase");
      } else {
        alert("✅ Familia registrada en Supabase");
        form.reset();
        cargarFamilias();
      }
    }
  });

  async function cargarFamilias(){
    try {
      const start = page * pageSize;
      const end = start + pageSize - 1;
      const { data, error } = await supabase
        .from("familias")
        .select("*")
        .order("id",{ascending:true})
        .range(start,end);

      if(error) throw error;
      tabla.innerHTML="";
      if(!data || data.length===0){
        tabla.innerHTML="<tr><td colspan='6'>Sin registros</td></tr>";
        return;
      }

      data.forEach(fam=>{
        const tr = document.createElement("tr");
        tr.dataset.id = fam.id;

        tr.innerHTML = `
          <td>${fam.id}</td>
          <td contenteditable="true" data-field="nombres_apellidos">${esc(fam.nombres_apellidos||"")}</td>
          <td contenteditable="true" data-field="direccion">${esc(fam.direccion||"")}</td>
          <td contenteditable="true" data-field="telefono_contacto">${esc(fam.telefono_contacto||"")}</td>
          <td><input type="checkbox" data-id="${fam.id}" ${fam.visitada?"checked":""}></td>
          <td>${fam.direccion ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fam.direccion)}" target="_blank">🗺</a>` : "—"}</td>
          <td><button class="btn-del" data-del="${fam.id}">🗑 Eliminar</button></td>
        `;
        tabla.appendChild(tr);
      });
    }catch(err){
      console.error(err);
      tabla.innerHTML="<tr><td colspan='6'>Error al cargar datos</td></tr>";
    }
  }

  // Guardar cambios de visitada
  document.getElementById("familiasTable")
    ?.addEventListener("change", async e => {
      if (e.target && e.target.type === "checkbox") {
        const id = e.target.dataset.id;
        const visitada = e.target.checked;
        if (!supabase) return showMsg("❌ Supabase no inicializado", "error");

        try {
          await supabase.from("familias").update({ visitada }).eq("id", id);
          showMsg("✅ Estado actualizado", "success");
        } catch (err) {
          console.error("❌ Error actualizando visitada:", err);
          showMsg("❌ Error al actualizar", "error");
          e.target.checked = !visitada;
        }
      }
    });

  // Paginación
  document.getElementById("prevPage").addEventListener("click",()=>{ if(page>0){ page--; cargarFamilias(); }});
  document.getElementById("nextPage").addEventListener("click",()=>{ page++; cargarFamilias(); });

  cargarFamilias();

  // Guardado inline
  document.getElementById("familiasTable").addEventListener("blur", async e => {
    if (e.target.matches("[contenteditable]")) {
      const id = e.target.closest("tr").dataset.id;
      const field = e.target.dataset.field;
      const value = e.target.textContent.trim();

      try {
        const { error } = await supabase
          .from("familias")
          .update({ [field]: value })
          .eq("id", id);
        if (error) throw error;
        showMsg("✅ Campo actualizado", "success");
      } catch (err) {
        console.error("❌ Error al actualizar:", err);
        showMsg("❌ Error al actualizar", "error");
      }
    }
  }, true);

  // Eliminar fila
  document.getElementById("familiasTable").addEventListener("click", async e => {
    if (e.target.dataset.del) {
      const id = e.target.dataset.del;
      if (confirm("¿Seguro que deseas eliminar esta familia?")) {
        try {
          await supabase.from("familias").delete().eq("id", id);
          showMsg("🗑️ Familia eliminada", "success");
          cargarFamilias();
        } catch (err) {
          console.error("❌ Error eliminando:", err);
          showMsg("❌ Error al eliminar", "error");
        }
      }
    }
  });
</script>
</body>
</html>