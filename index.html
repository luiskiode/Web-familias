<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#b91c1c" />
  <title>CÃ¡ritas CNC</title>
  
  <base href="/Web-familias/">
  <link rel="icon" href="img/favicon.ico" />
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- âœ… CSP -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://esm.sh https://unpkg.com;
             style-src 'self' 'unsafe-inline' https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <!-- ğŸ›  Herramientas de diagnÃ³stico -->
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script type="module" src="api.js/health-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>

  <!-- âœ… Supabase ESM -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw"; // âš ï¸ reemplaza con tu anon key

    window.CARITAS = window.CARITAS || {};
    window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    document.dispatchEvent(new Event("supabase:ready:caritas"));
  </script>
</head>
<body>
  <!-- ğŸ¥ Fondo -->
  <video id="video-fondo" autoplay muted loop>
    <source src="videos/fondo.mp4" type="video/mp4">
  </video>

  <!-- Encabezado -->
  <header class="app-header">
    <h1>CÃ¡ritas CNC</h1>
  </header>

  <!-- ğŸ“Œ MisiÃ³n y VisiÃ³n -->
  <section class="container card">
    <h2>ğŸŒŸ Nuestra MisiÃ³n</h2>
    <p>
      Servir a las familias mÃ¡s necesitadas con solidaridad, acompaÃ±amiento y amor cristiano,
      promoviendo la dignidad y la esperanza.
    </p>
    <h2>ğŸ‘ï¸ Nuestra VisiÃ³n</h2>
    <p>
      Ser una comunidad unida que transforma la realidad de las familias vulnerables,
      sembrando valores de fe, justicia y caridad.
    </p>
  </section>

  <!-- ğŸ“‚ BotÃ³n a Google Drive -->
  <section class="container card center">
    <a class="btn" href="https://drive.google.com/" target="_blank">ğŸ“‚ Acceder a Drive</a>
  </section>


  
  <!-- ğŸ“‹ Formulario Integral -->
  <section class="container card">
    <h2>ğŸ“‹ Registro Integral de Familia</h2>
    <p>Complete todos los datos requeridos para registrar su solicitud de ayuda.</p>

    <form id="famForm" enctype="multipart/form-data">
      <label>ğŸ‘¤ Nombre y apellidos del solicitante:</label>
      <input type="text" id="nombres_apellidos" required>

      <label>ğŸ“ DirecciÃ³n de la familia:</label>
      <input type="text" id="direccion" placeholder="Ej: Calle 123, Ciudad" required>

      <label>ğŸ“ TelÃ©fono de contacto:</label>
      <input type="tel" id="telefono_contacto" required>

      <label>ğŸªª DNI del solicitante:</label>
      <input type="text" id="dni_solicitante">

      <label>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Apellido de la familia:</label>
      <input type="text" id="apellido_familia">

      <label>ğŸ“ Observaciones:</label>
      <textarea id="observaciones" rows="3"></textarea>

      <label>ğŸ“‚ Subir archivo de registro:</label>
      <input type="file" id="archivo" accept=".pdf,.doc,.docx,.jpg,.png">

    <hr>

    <!-- II. DATOS COMPLEMENTARIOS -->
    <h3>Datos complementarios</h3>
    <input type="text" id="jefe_hogar" placeholder="Nombre del Jefe(a) del Hogar">
    <input type="number" id="edad" placeholder="Edad">
    <select id="estado_civil">
      <option value="">Estado Civil</option>
      <option>Soltero(a)</option><option>Casado(a)</option><option>Conviviente</option>
      <option>Divorciado(a)</option><option>Viudo(a)</option>
    </select>
    <input type="text" id="ocupacion" placeholder="OcupaciÃ³n">
    <select id="instruccion">
      <option value="">Grado de InstrucciÃ³n</option>
      <option>Sin estudios</option><option>Primaria</option><option>Secundaria</option>
      <option>TÃ©cnico</option><option>Universitario</option><option>Otro</option>
    </select>
    <input type="number" id="num_integrantes" placeholder="NÃºmero de integrantes del hogar">
    <input type="date" id="fecha_entrevista">

    <hr>

    <!-- III. SOCIO-ECONÃ“MICO -->
    <h3>AplicaciÃ³n socio-econÃ³mica</h3>
    <label>Â¿Viven en casa con materiales precarios?</label>
    <select id="casa_precaria"><option>si</option><option>no</option></select>

    <label>Â¿Tiene acceso a servicios bÃ¡sicos?</label>
    <select id="servicios_basicos"><option>si</option><option>no</option></select>

    <label>Â¿Se encuentra en el lÃ­mite alimentario de la Ley?</label>
    <select id="minimo_alimentario"><option>si</option><option>no</option></select>

    <label>Â¿Dificultad para obtener alimentos bÃ¡sicos?</label>
    <select id="dificultad_alimentos"><option>si</option><option>no</option></select>

    <label>Â¿Viven en hacinamiento?</label>
    <select id="hacinamiento"><option>si</option><option>no</option></select>

    <label>Â¿Ha vendido pertenencias?</label>
    <select id="vende_pertenencias"><option>si</option><option>no</option></select>

    <hr>

    <!-- IV. DISCAPACIDAD -->
    <h3>Discapacidad</h3>
    <label>Â¿Hay discapacidad grave?</label>
    <select id="discapacidad_grave"><option>si</option><option>no</option></select>
    <input type="text" id="tipo_discapacidad" placeholder="Tipo de discapacidad">
    <label>Â¿Usa aparatos de ayuda?</label>
    <select id="aparatos_ayuda"><option>si</option><option>no</option></select>

    <label>Â¿Discapacidad intelectual grave?</label>
    <select id="discapacidad_intelectual"><option>si</option><option>no</option></select>
    <label>Â¿Bajo tratamiento mÃ©dico?</label>
    <select id="bajo_tratamiento"><option>si</option><option>no</option></select>
    <label>Â¿Requiere cuidador?</label>
    <select id="requiere_cuidador"><option>si</option><option>no</option></select>

    <hr>

    <!-- V. VULNERABILIDADES -->
    <h3>Condiciones de vulnerabilidad</h3>
    <label>Â¿Sufre abandono o depresiÃ³n familiar?</label>
    <select id="abandono_depresion"><option>si</option><option>no</option></select>
    <input type="text" id="abandono_detalle" placeholder="Explique si aplica">

    <label>Â¿Enfermedad crÃ³nica grave?</label>
    <select id="enfermedad_cronica"><option>si</option><option>no</option></select>
    <input type="text" id="enfermedad_detalle" placeholder="CuÃ¡l?">

    <label>Â¿ExposiciÃ³n a violencia?</label>
    <select id="violencia"><option>si</option><option>no</option></select>
    <input type="text" id="violencia_detalle" placeholder="Explique si aplica">

    <hr>

    <!-- VI. EDUCACIÃ“N -->
    <h3>Vulnerabilidad educativa</h3>
    <label>Â¿NiÃ±os/as fuera de la escuela?</label>
    <select id="ninos_fuera_colegio"><option>si</option><option>no</option></select>
    <input type="text" id="quienes_fuera" placeholder="Â¿QuiÃ©nes?">
    <label>Causas:</label>
    <textarea id="causas_no_asistencia" rows="3"></textarea>
    <label>Â¿Dispuestos a retorno?</label>
    <select id="dispuesto_retorno"><option>si</option><option>no</option></select>
    <input type="text" id="apoyo_requerido" placeholder="Apoyo que necesita">

    <hr>

    <!-- VII. PROGRAMAS DEL ESTADO -->
    <h3>Programas de apoyo del Estado</h3>
    <label>Seleccione los programas:</label>
    <div>
      <label><input type="checkbox" name="programas_estado" value="Vaso de Leche"> Vaso de Leche</label><br>
      <label><input type="checkbox" name="programas_estado" value="Comedor Popular"> Comedor Popular / Ollas</label><br>
      <label><input type="checkbox" name="programas_estado" value="Juntos"> Programa Juntos</label><br>
      <label><input type="checkbox" name="programas_estado" value="SIS"> SIS</label><br>
      <label><input type="checkbox" name="programas_estado" value="PensiÃ³n 65"> PensiÃ³n 65</label><br>
      <label><input type="checkbox" name="programas_estado" value="ONG"> ONG</label><br>
      <label><input type="checkbox" name="programas_estado" value="Otro"> Otro</label>
    </div>
    <label>Â¿Es suficiente este apoyo?</label>
    <select id="apoyo_suficiente"><option>si</option><option>no</option></select>
    <input type="text" id="apoyo_adicional" placeholder="Â¿QuÃ© mÃ¡s requiere?">

    <br><br>
   <button type="submit" class="btn">ğŸ’¾ Guardar Familia</button>
    </form>
  </section>

   <!-- ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Familias registradas -->
  <main class="container card">
    <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Familias Registradas</h2>
    <div id="msg"></div>
    <table id="familiasTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombres</th>
          <th>DirecciÃ³n</th>
          <th>TelÃ©fono</th>
          <th>Visitada</th>
          <th>Mapa</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;">
      <button id="prevPage" class="btn">â® Anterior</button>
      <button id="nextPage" class="btn">Siguiente â­</button>
    </div>
    <button id="guardarCambios" class="btn" style="margin-top:1rem;">ğŸ’¾ Guardar cambios</button>
  </main>
  
   <!-- âœ… Script de formulario y listado -->
  <script type="module">
    const supabase = window.CARITAS?.supabase;
    const tabla = document.querySelector("#familiasTable tbody");
    const msg = document.getElementById("msg");
    const cambios = new Map();
    let page = 0;
    const pageSize = 10;

    function showMsg(text, type="info"){
      msg.textContent = text;
      msg.className = type;
      setTimeout(()=>{ msg.textContent=""; },4000);
    }

    const esc = (s="") => String(s).replace(/[&<>"']/g,
      m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );

    // Guardar familia
    document.getElementById("famForm").addEventListener("submit", async e=>{
      e.preventDefault();
      const form = e.target;

      const datos = {
        nombres_apellidos: form.nombres_apellidos.value,
        direccion: form.direccion.value,
        telefono_contacto: form.telefono_contacto.value,
        dni_solicitante: form.dni_solicitante.value || null,
        apellido_familia: form.apellido_familia.value || null,
        observaciones: form.observaciones.value || null
        // ğŸ‘‰ aquÃ­ aÃ±adirÃ­as el resto de campos opcionales del cuestionario
      };

      const { error } = await supabase.from("familias").insert([datos]);
      if (error) {
        alert("âŒ Error al guardar");
        console.error(error);
      } else {
        alert("âœ… Familia registrada");
        form.reset();
        cargarFamilias();
      }
    });

    async function cargarFamilias(){
      try {
        const start = page * pageSize;
        const end = start + pageSize - 1;
        const { data, error } = await supabase
          .from("familias")
          .select("*")
          .order("id",{ascending:true})
          .range(start,end);

        if(error) throw error;
        tabla.innerHTML="";
        if(!data || data.length===0){
          tabla.innerHTML="<tr><td colspan='6'>Sin registros</td></tr>";
          return;
        }

        data.forEach(fam=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fam.id}</td>
            <td>${esc(fam.nombres_apellidos||"")}</td>
            <td>${esc(fam.direccion||"")}</td>
            <td>${esc(fam.telefono_contacto||"")}</td>
            <td><input type="checkbox" data-id="${fam.id}" ${fam.visitada?"checked":""}></td>
            <td>${fam.direccion ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fam.direccion)}" target="_blank">ğŸ—º</a>` : "â€”"}</td>
          `;
          tabla.appendChild(tr);
        });
      }catch(err){
        console.error(err);
        tabla.innerHTML="<tr><td colspan='6'>Error al cargar datos</td></tr>";
      }
    }

    // Cambios de visitada â€” guardado inmediato
document.getElementById("familiasTable")
  ?.addEventListener("change", async e => {
    if (e.target && e.target.type === "checkbox") {
      const id = e.target.dataset.id;
      const visitada = e.target.checked;
      const supabase = window.CARITAS?.supabase;
      if (!supabase) return showMsg("âŒ Supabase no inicializado", "error");

      try {
        await supabase.from("familias").update({ visitada }).eq("id", id);
        showMsg("âœ… Estado actualizado", "success");
      } catch (err) {
        console.error("âŒ Error actualizando visitada:", err);
        showMsg("âŒ Error actualizando", "error");
        // revertir checkbox
        e.target.checked = !visitada;
      }
    }
  });

    // Detectar cambios en checkboxes
    document.getElementById("familiasTable").addEventListener("change", e=>{
      if(e.target.type==="checkbox"){
        cambios.set(e.target.dataset.id,e.target.checked);
      }
    });

    // PaginaciÃ³n
    document.getElementById("prevPage").addEventListener("click",()=>{
      if(page>0){ page--; cargarFamilias(); }
    });
    document.getElementById("nextPage").addEventListener("click",()=>{
      page++; cargarFamilias();
    });

    cargarFamilias();
  </script>
</body>
</html>