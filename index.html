<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#b91c1c" />
  <title>C√°ritas CNC</title>

  <link rel="icon" type="image/png" href="img/favicon.png">
  <base href="/Web-familias/">
  <link rel="icon" href="img/favicon.ico" />
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- üé® Ajustes de dise√±o espec√≠ficos de esta p√°gina -->
  <style>
    /* Un poco m√°s de espacio entre texto y bot√≥n en tarjetas centradas */
    .card.center .btn {
      margin-top: 0.5rem;
    }

    /* Galer√≠a de fotos din√°mica */
    .gallery {
      margin-top: 0.75rem;
    }
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 0.5rem;
    }
    .gallery-item {
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.35);
    }
    body.tema-blanco .gallery-item {
      background: #f3f4f6;
      border-color: #e5e7eb;
    }
    .gallery-item img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
    }
    .gallery-item::after {
      content: "üîç Ver";
      position: absolute;
      right: 6px;
      bottom: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      font-size: 0.7rem;
    }
    .gallery-item:hover img {
      transform: scale(1.05);
      filter: brightness(1.08);
    }

    /* Modal espec√≠fico de galer√≠a reutilizando estilos base */
    #galleryModal .modal-card {
      max-width: 900px;
    }
    #galleryFull {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      display: block;
      margin: 0 auto;
    }
  </style>

  <!-- ‚úÖ CSP (agregamos jsdelivr para Chart.js) -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://esm.sh https://unpkg.com https://www.gstatic.com https://cdn.jsdelivr.net;
             style-src 'self' 'unsafe-inline' https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <!-- üõ† Herramientas de diagn√≥stico -->
  <script type="module" src="api.js/self-heal-caritas.js"></script>
  <script defer src="api.js/error-overlay.js"></script>

  <!-- ‚úÖ Supabase ESM (√∫nico cliente para toda la app) -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpdmpsc3ZjanlxeW1vbW1mZGtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjA2MjUsImV4cCI6MjA2OTkzNjYyNX0.YN0W5miJeWwu96jhqKiGB-cA8t9TeIboQWURCjTFVbw";

    window.CARITAS = window.CARITAS || {};
    window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    document.dispatchEvent(new Event("supabase:ready:caritas"));
  </script>
</head>

<body>
  <!-- üé• Fondo -->
  <video id="video-fondo" autoplay muted loop>
    <source src="videos/fondo.mp4" type="video/mp4">
  </video>

  <!-- Encabezado -->
  <header class="app-header">
    <h1>C√°ritas CNC</h1>
  </header>

  <!-- üìå Misi√≥n y Visi√≥n -->
  <section class="container card">
    <h2>üåü Nuestra Misi√≥n</h2>
    <p>
      Servir a las familias m√°s necesitadas con solidaridad, acompa√±amiento y amor cristiano,
      promoviendo la dignidad y la esperanza.
    </p>
    <h2>üëÅÔ∏è Nuestra Visi√≥n</h2>
    <p>
      Ser una comunidad unida que transforma la realidad de las familias vulnerables,
      sembrando valores de fe, justicia y caridad.
    </p>
  </section>

  <!-- üìÇ Botones principales -->
  <section class="container card center">
    <a
      id="btn-drive"
      class="btn"
      href="https://drive.google.com/drive/folders/15O0gRC4yDubSsrd2Qvo_ni7Hm7Bk1KBc?usp=drive_link"
      target="_blank"
      rel="noopener noreferrer"
    >üìÇ Acceder a Drive</a>
    <button id="btn-familias" class="btn btn-ghost" type="button" style="margin-left:8px">üë®‚Äçüë©‚Äçüëß Familias</button>
  </section>

  <!-- üîΩ Panel plegable donde se monta la tabla de familias -->
  <section id="familiasPanel" class="familias-panel" hidden>
    <header class="familias-head">
      <h3 class="familias-title">Lista de familias</h3>
      <input id="familiasSearch" class="familias-search" type="search" placeholder="Filtrar..." />
      <button id="familiasExport" class="btn">‚¨áÔ∏è Exportar CSV</button>
    </header>
    <div id="familiasMountInline" class="familias-body">
      <!-- Aqu√≠ se MOVER√Å (no clonar) #familiasTable -->
    </div>
  </section>

  <!-- üé´ Credenciales -->
  <section class="container card center">
    <h2>üé´ Credenciales C√°ritas CNC</h2>
    <p>Gestiona tu carnet, comparte el enlace p√∫blico y, si eres Admin, administra todas las credenciales.</p>
    <a class="btn" href="credenciales.html">ü™™ Abrir Credenciales</a>
  </section>

  <!-- ü§ù Sobre el grupo + Galer√≠a -->
  <section class="container card" id="sobre-grupo">
    <h2>ü§ù Sobre C√°ritas CNC</h2>
    <p>
      C√°ritas CNC est√° formada por voluntarios que, con alegr√≠a y compromiso, visitan familias,
      organizan campa√±as de ayuda y sostienen espacios de servicio en comunidad.
    </p>

    <div class="gallery">
      <h3 style="font-size:1rem;margin-top:0.75rem;">üì∏ Galer√≠a de momentos</h3>
      <div class="gallery-grid">
        <!-- Miniaturas (usa tus fotos en /img) -->
        <figure class="gallery-item">
          <img src="img/galeria1.jpg" alt="Actividad 1" data-gallery-full="img/galeria1.jpg">
        </figure>
        <figure class="gallery-item">
          <img src="img/galeria2.jpg" alt="Actividad 2" data-gallery-full="img/galeria2.jpg">
        </figure>
        <figure class="gallery-item">
          <img src="img/galeria3.jpg" alt="Actividad 3" data-gallery-full="img/galeria3.jpg">
        </figure>
        <figure class="gallery-item">
          <img src="img/galeria4.jpg" alt="Actividad 4" data-gallery-full="img/galeria4.jpg">
        </figure>
        <figure class="gallery-item">
          <img src="img/galeria5.jpg" alt="Actividad 5" data-gallery-full="img/galeria5.jpg">
        </figure>
      </div>
      <p class="muted" style="margin-top:.6rem;font-size:.85rem;">
        Puedes cambiar estas im√°genes colocando tus fotos en la carpeta <code>img/</code> y actualizando los nombres de archivo.
      </p>
    </div>
  </section>

  <!-- üí∞ Dashboard financiero -->
  <section class="container card" id="tesoreria">
    <h2>üí∞ Dashboard financiero C√°ritas CNC</h2>
    <p>Resumen de ingresos y gastos registrados en tesorer√≠a.</p>

    <!-- Tarjetas de resumen -->
    <div class="dash-grid">
      <div class="stat-card">
        <span>Total ingresos</span>
        <strong id="tesoIngresos">S/ 0.00</strong>
      </div>
      <div class="stat-card">
        <span>Total gastos</span>
        <strong id="tesoGastos">S/ 0.00</strong>
      </div>
      <div class="stat-card">
        <span>Saldo</span>
        <strong id="tesoSaldo">S/ 0.00</strong>
      </div>
      <div class="stat-card">
        <span>Movimientos</span>
        <strong id="tesoMovs">0</strong>
      </div>
    </div>

    <!-- Filtros y acciones -->
    <div class="teso-filtros">
      <label>Tipo:
        <select id="tesoFiltroTipo">
          <option value="">Todos</option>
          <option value="ingreso">Ingresos</option>
          <option value="gasto">Gastos</option>
        </select>
      </label>

      <button class="btn" id="tesoExport">‚¨áÔ∏è Exportar CSV</button>
    </div>

    <!-- Form + gr√°fico -->
    <div class="teso-layout">
      <!-- Formulario nuevo movimiento -->
      <form id="tesoForm" class="teso-form">
        <h3>‚ûï Registrar movimiento</h3>
        <div class="form-grid">
          <label>Tipo<br>
            <select name="tipo" required>
              <option value="ingreso">Ingreso</option>
              <option value="gasto">Gasto</option>
            </select>
          </label>
          <label>Categor√≠a<br>
            <input type="text" name="categoria" placeholder="Chocolatada, log√≠stica‚Ä¶">
          </label>
          <label>Monto (S/)<br>
            <input type="number" name="monto" step="0.01" required>
          </label>
        </div>
        <div class="form-grid">
          <label>Abonado / Responsable<br>
            <input type="text" name="abonado" placeholder="Nombre">
          </label>
          <label>Medio de pago<br>
            <input type="text" name="medio_pago" placeholder="Yape, efectivo‚Ä¶">
          </label>
        </div>
        <label>Concepto<br>
          <input type="text" name="concepto" placeholder="Ej: Aporte campa√±a, compra de v√≠veres‚Ä¶">
        </label>
        <label>Observaciones<br>
          <textarea name="observaciones" rows="2"></textarea>
        </label>
        <button type="submit" class="btn" style="margin-top:.5rem;">Guardar movimiento</button>
      </form>

      <!-- Gr√°fico -->
      <div class="teso-chart">
        <h3>üìä Ingresos vs gastos</h3>
        <canvas id="tesoChart"></canvas>
      </div>
    </div>

    <!-- Tabla editable de tesorer√≠a -->
    <div class="table-wrapper teso-table-wrapper">
      <table id="tesoTable">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Categor√≠a</th>
            <th>Concepto</th>
            <th>Abonado</th>
            <th>Monto (S/)</th>
            <th>Medio</th>
            <th>Fecha (texto)</th>
            <th>Hora</th>
            <th>Obs.</th>
            <th>Validado</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- üìã Formulario Integral de Familias -->
  <section class="container card">
    <h2>üìã Registro Integral de Familia</h2>
    <p>Complete todos los datos requeridos para registrar su solicitud de ayuda.</p>

    <form id="famForm" enctype="multipart/form-data">

      <!-- I. DATOS B√ÅSICOS -->
      <fieldset>
        <legend>I. Datos B√°sicos</legend>
        <div class="form-grid">
          <label>üë§ Nombre y apellidos*<br>
            <input type="text" id="nombres_apellidos" name="nombres_apellidos" required>
          </label>
          <label>üìç Direcci√≥n*<br>
            <input type="text" id="direccion" name="direccion" required>
          </label>
          <label>üìû Tel√©fono*<br>
            <input type="tel" id="telefono_contacto" name="telefono_contacto" required>
          </label>
        </div>
        <div class="form-grid">
          <label>ü™™ DNI<br>
            <input type="text" id="dni_solicitante" name="dni_solicitante">
          </label>
          <label>üë®‚Äçüë©‚Äçüëß Apellido de la familia<br>
            <input type="text" id="apellido_familia" name="apellido_familia">
          </label>
        </div>
        <label>üìù Observaciones<br>
          <textarea id="observaciones" name="observaciones" rows="3"></textarea>
        </label>
        <label>üìÇ Subir archivo<br>
          <input type="file" id="archivo" accept=".pdf,.doc,.docx,.jpg,.png">
        </label>
      </fieldset>

      <!-- II. DATOS COMPLEMENTARIOS -->
      <fieldset>
        <legend>II. Datos Complementarios</legend>
        <div class="form-grid">
          <label>Jefe(a) de hogar<br><input type="text" id="jefe_hogar"></label>
          <label>Edad<br><input type="number" id="edad"></label>
          <label>Estado civil<br>
            <select id="estado_civil">
              <option value="">Seleccione...</option>
              <option>Soltero(a)</option><option>Casado(a)</option>
              <option>Conviviente</option><option>Divorciado(a)</option><option>Viudo(a)</option>
            </select>
          </label>
        </div>
        <div class="form-grid">
          <label>Ocupaci√≥n<br><input type="text" id="ocupacion"></label>
          <label>Grado de instrucci√≥n<br>
            <select id="instruccion">
              <option value="">Seleccione...</option>
              <option>Sin estudios</option><option>Primaria</option><option>Secundaria</option>
              <option>T√©cnico</option><option>Universitario</option><option>Otro</option>
            </select>
          </label>
          <label>Integrantes<br><input type="number" id="num_integrantes"></label>
        </div>
        <label>Fecha entrevista<br><input type="date" id="fecha_entrevista"></label>
      </fieldset>

      <!-- III. SOCIO-ECON√ìMICO -->
      <fieldset>
        <legend>III. Socio-Econ√≥mico</legend>
        <div class="form-grid">
          <label>üè† Casa precaria<br><select id="casa_precaria"><option></option><option>si</option><option>no</option></select></label>
          <label>üíß Servicios b√°sicos<br><select id="servicios_basicos"><option></option><option>si</option><option>no</option></select></label>
          <label>üçΩ Dificultad alimentos<br><select id="dificultad_alimentos"><option></option><option>si</option><option>no</option></select></label>
        </div>
        <div class="form-grid">
          <label>‚öñÔ∏è M√≠nimo alimentario<br><select id="minimo_alimentario"><option></option><option>si</option><option>no</option></select></label>
          <label>üë• Hacinamiento<br><select id="hacinamiento"><option></option><option>si</option><option>no</option></select></label>
          <label>üí∏ Vendi√≥ pertenencias<br><select id="vende_pertenencias"><option></option><option>si</option><option>no</option></select></label>
        </div>
      </fieldset>

      <!-- IV. DISCAPACIDAD -->
      <fieldset>
        <legend>IV. Discapacidad</legend>
        <div class="form-grid">
          <label>Discapacidad grave<br><select id="discapacidad_grave"><option></option><option>si</option><option>no</option></select></label>
          <label>Tipo discapacidad<br><input type="text" id="tipo_discapacidad"></label>
          <label>Aparatos de ayuda<br><select id="aparatos_ayuda"><option></option><option>si</option><option>no</option></select></label>
        </div>
        <div class="form-grid">
          <label>Intelectual grave<br><select id="discapacidad_intelectual"><option></option><option>si</option><option>no</option></select></label>
          <label>Bajo tratamiento<br><select id="bajo_tratamiento"><option></option><option>si</option><option>no</option></select></label>
          <label>Requiere cuidador<br><select id="requiere_cuidador"><option></option><option>si</option><option>no</option></select></label>
        </div>
      </fieldset>

      <!-- V. VULNERABILIDAD -->
      <fieldset>
        <legend>V. Vulnerabilidad</legend>
        <div class="form-grid">
          <label>Abandono/depresi√≥n<br><select id="abandono_depresion"><option></option><option>si</option><option>no</option></select></label>
          <label>Enfermedad cr√≥nica<br><select id="enfermedad_cronica"><option></option><option>si</option><option>no</option></select></label>
          <label>Violencia<br><select id="violencia"><option></option><option>si</option><option>no</option></select></label>
        </div>
      </fieldset>

      <!-- VI. EDUCACI√ìN -->
      <fieldset>
        <legend>VI. Educaci√≥n</legend>
        <label>Ni√±os fuera de escuela<br><select id="ninos_fuera_colegio"><option></option><option>si</option><option>no</option></select></label>
        <label>¬øQui√©nes?<br><input type="text" id="quienes_fuera"></label>
        <label>Causas<br><textarea id="causas_no_asistencia" rows="3"></textarea></label>
        <label>Dispuestos a retorno<br><select id="dispuesto_retorno"><option></option><option>si</option><option>no</option></select></label>
        <label>Apoyo requerido<br><input type="text" id="apoyo_requerido"></label>
      </fieldset>

      <!-- VII. PROGRAMAS -->
      <fieldset>
        <legend>VII. Programas del Estado</legend>
        <div class="form-grid">
          <label><input type="checkbox" name="programas_estado" value="Vaso de Leche"> Vaso de Leche</label>
          <label><input type="checkbox" name="programas_estado" value="Comedor Popular"> Comedor Popular</label>
          <label><input type="checkbox" name="programas_estado" value="Juntos"> Programa Juntos</label>
          <label><input type="checkbox" name="programas_estado" value="SIS"> SIS</label>
          <label><input type="checkbox" name="programas_estado" value="Pensi√≥n 65"> Pensi√≥n 65</label>
          <label><input type="checkbox" name="programas_estado" value="ONG"> ONG</label>
          <label><input type="checkbox" name="programas_estado" value="Otro"> Otro</label>
        </div>
        <label>¬øApoyo suficiente?<br><select id="apoyo_suficiente"><option></option><option>si</option><option>no</option></select></label>
        <label>Apoyo adicional<br><input type="text" id="apoyo_adicional"></label>
      </fieldset>

      <div class="center">
        <button type="submit" class="btn">üíæ Guardar Familia</button>
      </div>
    </form>
  </section>

  <!-- üë®‚Äçüë©‚Äçüëß Familias registradas -->
  <main class="container card">
    <h2>üë®‚Äçüë©‚Äçüëß Familias Registradas</h2>
    <div id="msg"></div>

    <div class="table-wrapper">
      <table id="familiasTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombres</th>
            <th>Direcci√≥n</th>
            <th>Tel√©fono</th>
            <th>Visitada</th>
            <th>Mapa</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;">
      <button id="prevPage" class="btn">‚èÆ Anterior</button>
      <button id="nextPage" class="btn">Siguiente ‚è≠</button>
    </div>
  </main>

  <!-- ===== Script Familias (Supabase + tabla + historial b√°sico) ===== -->
  <!-- ===== Script Familias (Supabase + tabla + historial b√°sico) ===== -->
<script type="module">
  const supabaseFamilias = window.CARITAS?.supabase;
  const tabla = document.querySelector("#familiasTable tbody");
  const msg = document.getElementById("msg");
  let page = 0;
  const pageSize = 10;

  // Fallback para savePendiente si ./api.js/db.js no existe
  let savePendiente = async (datos) => {
    try {
      const k = "pendiente:" + Date.now();
      localStorage.setItem(k, JSON.stringify(datos));
      console.warn("db.js no encontrado. Guardado local simple en localStorage:", k);
    } catch(e) { console.warn("No se pudo guardar localmente:", e); }
  };
  try {
    const mod = await import("./api.js/db.js");
    if (mod?.savePendiente) savePendiente = mod.savePendiente;
  } catch(e) {
    console.warn("No se pudo importar ./api.js/db.js (ok en Pages):", e);
  }

  function showMsg(text, type="info"){
    msg.textContent = text;
    msg.className = type;
    setTimeout(()=>{ msg.textContent=""; },4000);
  }

  const esc = (s="") => String(s).replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  // Guardar familia
  const famForm = document.getElementById("famForm");
  famForm.addEventListener("submit", async e => {
    e.preventDefault();

    const datos = {
      nombres_apellidos: famForm.nombres_apellidos.value,
      direccion: famForm.direccion.value,
      telefono_contacto: famForm.telefono_contacto.value,
      dni_solicitante: famForm.dni_solicitante.value || null,
      apellido_familia: famForm.apellido_familia.value || null,
      observaciones: famForm.observaciones.value || null
    };

    if (!navigator.onLine) {
      await savePendiente(datos);
      alert("üì¶ Guardado local. Se enviar√° cuando vuelva internet.");
      if ("serviceWorker" in navigator && "SyncManager" in window) {
        const reg = await navigator.serviceWorker.ready;
        await reg.sync.register("sync-familias");
      }
    } else {
      const { error } = await supabaseFamilias.from("familias").insert([datos]);
      if (error) {
        console.error("‚ùå Error guardando en Supabase:", error);
        alert("‚ùå Error al guardar en Supabase");
      } else {
        alert("‚úÖ Familia registrada en Supabase");
        famForm.reset();
        cargarFamilias();
      }
    }
  });

  async function cargarFamilias(){
    try {
      const start = page * pageSize;
      const end = start + pageSize - 1;
      const { data, error } = await supabaseFamilias
        .from("familias")
        .select("*")
        .order("id",{ascending:true})
        .range(start,end);

      if(error) throw error;
      tabla.innerHTML="";
      if(!data || data.length===0){
        tabla.innerHTML="<tr><td colspan='7'>Sin registros</td></tr>";
        return;
      }

      data.forEach(fam=>{
        const tr = document.createElement("tr");
        tr.dataset.id = fam.id;

        tr.innerHTML = `
         <td>${fam.id}</td>
         <td contenteditable="true" data-field="nombres_apellidos">${esc(fam.nombres_apellidos||"")}</td>
         <td contenteditable="true" data-field="direccion">${esc(fam.direccion||"")}</td>
         <td contenteditable="true" data-field="telefono_contacto">${esc(fam.telefono_contacto||"")}</td>
         <td><input type="checkbox" data-id="${fam.id}" ${fam.visitada?"checked":""}></td>
         <td>${fam.direccion ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fam.direccion)}" target="_blank">üó∫</a>` : "‚Äî"}</td>
         <td>
           <button class="btn btn-ghost" data-hist="${fam.id}">Historial</button>
           <button class="btn-del" data-del="${fam.id}">üóë Eliminar</button>
         </td>
        `;
        tabla.appendChild(tr);
      });
    }catch(err){
      console.error(err);
      tabla.innerHTML="<tr><td colspan='7'>Error al cargar datos</td></tr>";
    }
  }

  // Guardar cambios de visitada
  document.getElementById("familiasTable")
    ?.addEventListener("change", async e => {
      if (e.target && e.target.type === "checkbox") {
        const id = e.target.dataset.id;
        const visitada = e.target.checked;
        if (!supabaseFamilias) return showMsg("‚ùå Supabase no inicializado", "error");

        try {
          await supabaseFamilias.from("familias").update({ visitada }).eq("id", id);
          showMsg("‚úÖ Estado actualizado", "success");
        } catch (err) {
          console.error("‚ùå Error actualizando visitada:", err);
          showMsg("‚ùå Error al actualizar", "error");
          e.target.checked = !visitada;
        }
      }
    });

  // Paginaci√≥n
  document.getElementById("prevPage").addEventListener("click",()=>{ if(page>0){ page--; cargarFamilias(); }});
  document.getElementById("nextPage").addEventListener("click",()=>{ page++; cargarFamilias(); });

  cargarFamilias();

  // Guardado inline
  document.getElementById("familiasTable").addEventListener("blur", async e => {
    if (e.target.matches("[contenteditable]")) {
      const id = e.target.closest("tr").dataset.id;
      const field = e.target.dataset.field;
      const value = e.target.textContent.trim();

      try {
        const { error } = await supabaseFamilias
          .from("familias")
          .update({ [field]: value })
          .eq("id", id);
        if (error) throw error;
        showMsg("‚úÖ Campo actualizado", "success");
      } catch (err) {
        console.error("‚ùå Error al actualizar:", err);
        showMsg("‚ùå Error al actualizar", "error");
      }
    }
  }, true);

  // Eliminar fila (delegado)
  document.getElementById("familiasTable").addEventListener("click", async (e) => {
    const id = e.target?.dataset?.del;
    if (!id) return;

    e.preventDefault();
    if (!confirm("¬øSeguro que deseas eliminar esta familia?")) return;

    try {
      await supabaseFamilias.from("familias").delete().eq("id", id);
      showMsg("üóëÔ∏è Familia eliminada", "success");
      cargarFamilias();
    } catch (err) {
      console.error("‚ùå Error eliminando:", err);
      showMsg("‚ùå Error al eliminar", "error");
    }
  });

  // Abrir Historial (delegado)
  document.getElementById("familiasTable").addEventListener("click", (e) => {
    const id = e.target?.dataset?.hist;
    if (!id) return;

    e.preventDefault();
    if (window.openHistoryModal) {
      window.openHistoryModal(id);
    } else {
      console.warn("openHistoryModal no est√° disponible todav√≠a.");
    }
  });
</script>


  <!-- üîç Galer√≠a: lightbox -->
  <script>
  (function(){
    const modal = document.getElementById('galleryModal');
    const fullImg = document.getElementById('galleryFull');
    const btnClose = document.getElementById('galleryClose');
    if (!modal || !fullImg) return;

    function open(src, alt){
      fullImg.src = src;
      fullImg.alt = alt || 'Foto C√°ritas CNC';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function close(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      fullImg.src = '';
    }

    document.addEventListener('click', (e)=>{
      const img = e.target.closest('[data-gallery-full]');
      if (!img) return;
      const src = img.getAttribute('data-gallery-full') || img.src;
      const alt = img.alt || '';
      open(src, alt);
    });
    btnClose?.addEventListener('click', close);
    modal.addEventListener('click', (e)=>{ if (e.target === modal) close(); });
  })();
  </script>

  <!-- Panel familias: mover tabla al panel y filtros -->
  <script>
  (function(){
    const TABLE_SEL = '#familiasTable';
    const $ = (q,root=document)=>root.querySelector(q);

    let moved = false;
    function mountFamiliesBlockOnce(){
      if (moved) return true;

      const table = document.querySelector(TABLE_SEL);
      const mount = $('#familiasMountInline');
      if (!table || !mount) return false;

      const wrapper = table.closest('.table-wrapper') || table;
      const pager   = document.getElementById('prevPage')?.parentElement || null;

      const phWrapper = document.createComment('familias-wrapper-placeholder');
      wrapper.parentNode.insertBefore(phWrapper, wrapper);

      let phPager = null;
      if (pager && pager.parentNode) {
        phPager = document.createComment('familias-pager-placeholder');
        pager.parentNode.insertBefore(phPager, pager);
      }

      const block = document.createElement('div');
      block.id = 'familiasBlockInline';
      block.appendChild(wrapper);
      if (pager) block.appendChild(pager);

      mount.appendChild(block);
      moved = true;
      return true;
    }

    function togglePanel(force){
      const panel = $('#familiasPanel');
      if (!panel) return;
      if (panel.hasAttribute('hidden')) {
        mountFamiliesBlockOnce();
      }
      const willOpen = (typeof force === 'boolean') ? force : panel.hasAttribute('hidden');
      if (willOpen) {
        panel.removeAttribute('hidden');
        panel.scrollIntoView({ behavior:'smooth', block:'start' });
      } else {
        panel.setAttribute('hidden','');
      }
    }

    function filterFamilies(q){
      const table = document.querySelector(TABLE_SEL);
      if (!table) return;
      const needle = (q||'').trim().toLowerCase();

      table.querySelectorAll('tbody tr').forEach(tr=>{
        const text = tr.textContent.toLowerCase();
        tr.style.display = (!needle || text.includes(needle)) ? '' : 'none';
      });
    }

    function exportCSV(){
      const table = document.querySelector(TABLE_SEL);
      if (!table) return;
      const root = table.closest('table') || table;
      const rows = [];
      const trs = root.querySelectorAll('tr');
      trs.forEach(tr=>{
        if (tr.style && tr.style.display==='none') return;
        const cells = [...tr.querySelectorAll('th,td')].map(td=>{
          let t=(td.innerText||'').replace(/\s+/g,' ').trim();
          if (/[",;\n]/.test(t)) t=`"${t.replace(/"/g,'""')}"`;
          return t;
        });
        if (cells.length) rows.push(cells.join(','));
      });
      const csv = rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'familias.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    document.addEventListener('click', (e)=>{
      if (e.target.closest('#btn-familias')) togglePanel();
      if (e.target.closest('#familiasExport')) exportCSV();
    });
    document.addEventListener('input', (e)=>{
      if (e.target && e.target.id==='familiasSearch') filterFamilies(e.target.value);
    });

    if (location.hash.replace('#','').toLowerCase().includes('familias')) {
      togglePanel(true);
    }
  })();
  </script>

  <!-- ==== Modal: Galer√≠a ==== -->
  <div id="galleryModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Galer√≠a C√°ritas CNC</h3>
        <button id="galleryClose" class="btn ghost">Cerrar</button>
      </div>
      <div class="modal-body center">
        <img id="galleryFull" src="" alt="Foto C√°ritas CNC">
      </div>
    </div>
  </div>

  <!-- ==== Modal: Historial por familia ==== -->
  <div id="histModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="histTitle">Historial</h3>
        <input id="histSearch" class="search" type="search" placeholder="Filtrar..." />
        <button id="histExport" class="btn">‚¨áÔ∏è Exportar CSV</button>
        <button id="histClose" class="btn ghost">Cerrar</button>
      </div>
      <div class="modal-body">
        <table id="histTable">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Usuario</th>
              <th>Resumen de cambios</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Historial local por familia -->
  <script>
  (function(){
    const STORAGE_KEY = 'familias_history_v1';
    const $ = (q,root=document)=>root.querySelector(q);
    const nowISO = ()=> new Date().toISOString();

    function loadDB(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch{ return {}; } }
    function saveDB(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
    function getHistory(familyId){ const db = loadDB(); return db[familyId] || []; }
    function addHistory(familyId, entry){
      const db = loadDB(); db[familyId] = db[familyId] || [];
      db[familyId].unshift(entry); saveDB(db);
    }

    function diffObjects(prev, cur){
      const keys = Array.from(new Set([...Object.keys(prev||{}), ...Object.keys(cur||{})]));
      const changes = [];
      keys.forEach(k=>{
        const a = (prev||{})[k] ?? '';
        const b = (cur||{})[k] ?? '';
        if (String(a) !== String(b)) changes.push({field:k, from:a, to:b});
      });
      return changes;
    }

    async function logFamilyUpdate(formData, opts={}){
      const user = (window.CARITAS?.auth?.currentUser) || null;
      const familyId = formData.id; // en creaci√≥n todav√≠a no hay id real, as√≠ que ahora mismo no se usa
      if(!familyId) return;

      const hist = getHistory(familyId);
      const prevSnapshot = hist.find(h=>h.snapshot)?.snapshot || {};
      const changes = diffObjects(prevSnapshot, formData);

      addHistory(familyId, {
        ts: nowISO(),
        user: user?.email || user?.displayName || 'anon',
        action: opts.action || 'update',
        snapshot: formData,
        changes
      });
    }

    function renderHistoryTable(familyId, q=''){
      const tbody = $('#histTable tbody'); tbody.innerHTML = '';
      const rows = getHistory(familyId);
      const needle = q.trim().toLowerCase();

      rows.forEach(r=>{
        const summary = (r.changes && r.changes.length)
          ? r.changes.map(c=> `${c.field}: ‚Äú${c.from}‚Äù ‚Üí ‚Äú${c.to}‚Äù`).join(' | ')
          : '(sin cambios detectados)';
        const line = `${r.ts} ${r.user||''} ${summary}`.toLowerCase();
        if (needle && !line.includes(needle)) return;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.ts).toLocaleString()}</td>
          <td>${r.user || '‚Äî'}</td>
          <td>${summary}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openHistoryModal(familyId){
      const modal = document.getElementById('histModal');
      document.getElementById('histTitle').textContent = `Historial ‚Äì ID: ${familyId}`;
      renderHistoryTable(familyId);
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');

      document.getElementById('histSearch').oninput = (e)=> renderHistoryTable(familyId, e.target.value);
      document.getElementById('histExport').onclick = ()=> exportHistoryCSV(familyId);
      document.getElementById('histClose').onclick  = ()=> closeHistoryModal();

      modal.addEventListener('click', (e)=>{ if (e.target === modal) closeHistoryModal(); }, {once:true});
      document.addEventListener('keydown', function esc(e){
        if(e.key==='Escape'){ closeHistoryModal(); document.removeEventListener('keydown', esc); }
      });
    }
    window.openHistoryModal = openHistoryModal;

    function closeHistoryModal(){
      const modal = document.getElementById('histModal');
      modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
    }

    function exportHistoryCSV(familyId){
      const rows = getHistory(familyId);
      const out = [['fecha','usuario','accion','campo','de','a']];
      rows.forEach(r=>{
        if (r.changes?.length){
          r.changes.forEach(c=> out.push([r.ts, r.user||'', r.action||'', c.field, String(c.from||''), String(c.to||'')]));
        } else {
          out.push([r.ts, r.user||'', r.action||'', '', '', '']);
        }
      });
      const csv = out.map(cols => cols.map(v=>{
        let t = String(v).replace(/\s+/g,' ').trim();
        if (/[",;\n]/.test(t)) t = `"${t.replace(/"/g,'""')}"`;
        return t;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `historial_${familyId}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    const form = document.querySelector('#famForm');
    if (form){
      form.addEventListener('submit', async (e)=>{
        try{
          const data = Object.fromEntries(new FormData(form).entries());
          await logFamilyUpdate(data, {action:'submit'});
        }catch(err){ console.warn('No se pudo registrar historial:', err); }
      });
    }
  })();
  </script>


  <!-- ===== Tesorer√≠a: Dashboard financiero (Chart.js + Supabase) ===== -->
<script type="module">
import * as Chart from "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";

  const supabaseTeso = window.CARITAS?.supabase;
  if (!supabaseTeso) console.error("Supabase no inicializado para tesorer√≠a");

  const tBody    = document.querySelector("#tesoTable tbody");
  const tesoForm = document.querySelector("#tesoForm");
  const filtroTipo = document.querySelector("#tesoFiltroTipo");
  const btnExport  = document.querySelector("#tesoExport");

  const elIngresos = document.getElementById("tesoIngresos");
  const elGastos   = document.getElementById("tesoGastos");
  const elSaldo    = document.getElementById("tesoSaldo");
  const elMovs     = document.getElementById("tesoMovs");

  let movimientos = [];
  let chart;

  const fmon = n => "S/ " + (Number(n)||0).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2});

  async function cargarMovimientos(){
    if (!supabaseTeso) return;

    const { data, error } = await supabaseTeso
      .from("tesoreria_movimientos")
      .select("*")
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Error cargando tesorer√≠a:", error);
      return;
    }

    movimientos = data || [];
    renderDashboard();
    renderTabla();
    renderChart();
  }

  function getFiltrados(){
    const tipo = filtroTipo.value;
    return tipo ? movimientos.filter(m => m.tipo === tipo) : movimientos;
  }

  function renderDashboard(){
    const rows = movimientos;
    const ingresos = rows
      .filter(r => r.tipo === "ingreso")
      .reduce((s,r)=> s + Number(r.monto||0), 0);
    const gastos = rows
      .filter(r => r.tipo === "gasto")
      .reduce((s,r)=> s + Number(r.monto||0), 0);
    const saldo = ingresos - gastos;

    elIngresos.textContent = fmon(ingresos);
    elGastos.textContent   = fmon(gastos);
    elSaldo.textContent    = fmon(saldo);
    elMovs.textContent     = rows.length;
  }

  function esc(str=""){
    return String(str).replace(/[&<>"']/g,
      m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );
  }

  function renderTabla(){
    const rows = getFiltrados();
    tBody.innerHTML = "";
    if (!rows.length){
      tBody.innerHTML = "<tr><td colspan='11'>Sin movimientos registrados</td></tr>";
      return;
    }

    for (const r of rows){
      const tr = document.createElement("tr");
      tr.dataset.id = r.id;

      tr.innerHTML = `
        <td>
          <select data-field="tipo">
            <option value="ingreso" ${r.tipo==="ingreso"?"selected":""}>Ingreso</option>
            <option value="gasto" ${r.tipo==="gasto"?"selected":""}>Gasto</option>
          </select>
        </td>
        <td contenteditable="true" data-field="categoria">${esc(r.categoria||"")}</td>
        <td contenteditable="true" data-field="concepto">${esc(r.concepto||"")}</td>
        <td contenteditable="true" data-field="abonado">${esc(r.abonado||"")}</td>
        <td contenteditable="true" data-field="monto">${esc(r.monto||"")}</td>
        <td contenteditable="true" data-field="medio_pago">${esc(r.medio_pago||"")}</td>
        <td contenteditable="true" data-field="fecha_texto">${esc(r.fecha_texto||"")}</td>
        <td contenteditable="true" data-field="hora_texto">${esc(r.hora_texto||"")}</td>
        <td contenteditable="true" data-field="observaciones">${esc(r.observaciones||"")}</td>
        <td style="text-align:center;">
          <input type="checkbox" data-field="validado" ${r.validado ? "checked" : ""}>
        </td>
        <td>
          <button class="btn-del" data-del="${r.id}">üóë</button>
        </td>
      `;
      tBody.appendChild(tr);
    }
  }

  async function actualizarCampo(id, field, value){
    if (!supabaseTeso) return;
    try {
      if (field === "validado") {
        value = !!value;
      }
      if (field === "monto") {
        value = Number(String(value).replace(",","."));
      }

      const { error } = await supabaseTeso
        .from("tesoreria_movimientos")
        .update({ [field]: value })
        .eq("id", id);

      if (error) throw error;

      const row = movimientos.find(m => m.id === id);
      if (row) row[field] = value;

      renderDashboard();
      renderChart();
    } catch (err){
      console.error("Error actualizando movimiento:", err);
      alert("No se pudo guardar el cambio en tesorer√≠a.");
    }
  }

  tBody.addEventListener("change", (e)=>{
    const tr = e.target.closest("tr");
    if (!tr) return;
    const id = Number(tr.dataset.id);
    const field = e.target.dataset.field;
    if (!field) return;

    if (e.target.tagName === "SELECT") {
      actualizarCampo(id, field, e.target.value);
    } else if (e.target.type === "checkbox") {
      actualizarCampo(id, field, e.target.checked);
    }
  });

  tBody.addEventListener("blur", (e)=>{
    const cell = e.target;
    if (!cell.matches("[contenteditable][data-field]")) return;
    const tr = cell.closest("tr");
    const id = Number(tr.dataset.id);
    const field = cell.dataset.field;
    const value = cell.textContent.trim();
    actualizarCampo(id, field, value);
  }, true);

  tBody.addEventListener("click", async (e)=>{
    const id = e.target?.dataset?.del;
    if (!id) return;
    if (!confirm("¬øEliminar este movimiento de tesorer√≠a?")) return;

    const { error } = await supabaseTeso
      .from("tesoreria_movimientos")
      .delete()
      .eq("id", id);

    if (error){
      console.error("Error eliminando:", error);
      alert("No se pudo eliminar el movimiento.");
      return;
    }

    movimientos = movimientos.filter(m => m.id !== Number(id));
    renderDashboard();
    renderTabla();
    renderChart();
  });

  filtroTipo.addEventListener("change", ()=>{
    renderTabla();
    renderChart();
  });

  tesoForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (!supabaseTeso) return;

    const data = Object.fromEntries(new FormData(tesoForm).entries());
    const nuevo = {
      tipo: data.tipo || "ingreso",
      categoria: data.categoria || null,
      concepto: data.concepto || null,
      abonado: data.abonado || null,
      monto: Number(data.monto || 0),
      moneda: "PEN",
      medio_pago: data.medio_pago || null,
      observaciones: data.observaciones || null,
      validado: false
    };

    try{
      const { data: inserted, error } = await supabaseTeso
        .from("tesoreria_movimientos")
        .insert([nuevo])
        .select();

      if (error) throw error;

      movimientos.push(inserted[0]);
      tesoForm.reset();
      renderDashboard();
      renderTabla();
      renderChart();
    } catch(err){
      console.error("Error insertando movimiento:", err);
      alert("No se pudo guardar el movimiento.");
    }
  });

  btnExport.addEventListener("click", ()=>{
    const rows = getFiltrados();
    if (!rows.length) {
      alert("No hay movimientos para exportar.");
      return;
    }

    const headers = ["tipo","categoria","concepto","abonado","monto","moneda","medio_pago","fecha_texto","hora_texto","observaciones","validado"];
    const lines = [
      headers.join(","),
      ...rows.map(r => headers.map(h => {
        let v = r[h];
        if (v === null || v === undefined) v = "";
        v = String(v).replace(/\s+/g," ").trim();
        if (/[",;\n]/.test(v)) v = `"${v.replace(/"/g,'""')}"`;
        return v;
      }).join(","))
    ];

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "tesoreria_movimientos.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  function renderChart(){
    const rows = movimientos;
    const ingresos = rows
      .filter(r => r.tipo === "ingreso")
      .reduce((s,r)=> s + Number(r.monto||0), 0);
    const gastos = rows
      .filter(r => r.tipo === "gasto")
      .reduce((s,r)=> s + Number(r.monto||0), 0);
    const saldo = ingresos - gastos;

    const ctx = document.getElementById("tesoChart");
    if (!ctx) return;

    const data = {
      labels: ["Ingresos", "Gastos", "Saldo"],
      datasets: [{
        label: "Soles",
        data: [ingresos, gastos, saldo]
      }]
    };

    const options = {
      responsive:true,
      scales:{ y:{ beginAtZero:true } }
    };

    if (!chart){
      chart = new Chart(ctx, {
        type: "bar",
        data,
        options
      });
    } else {
      chart.data = data;
      chart.update();
    }
  }

  cargarMovimientos();
</script>

</body>
</html>