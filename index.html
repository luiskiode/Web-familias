<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#b91c1c" />
  <title>Cáritas CNC</title>
  
  <base href="/Web-familias/">
  <link rel="icon" href="img/favicon.ico" />
  <link rel="stylesheet" href="styles-caritas.css" />

  <!-- ✅ CSP -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self';
             script-src 'self' 'unsafe-inline' https://esm.sh https://unpkg.com;
             style-src 'self' 'unsafe-inline' https://unpkg.com;
             img-src * data: blob:;
             connect-src *;
             font-src * data:;">

  <!-- ✅ Supabase ESM -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://qivjlsvcjyqymommfdke.supabase.co";
    const SUPABASE_ANON_KEY = "TU_ANON_KEY"; // ⚠️ pon aquí tu anon key

    window.CARITAS = window.CARITAS || {};
    window.CARITAS.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    document.dispatchEvent(new Event("supabase:ready:caritas"));
  </script>
</head>
<body>
  <!-- 🎥 Fondo -->
  <video id="video-fondo" autoplay muted loop>
    <source src="videos/fondo.mp4" type="video/mp4">
  </video>

  <!-- Encabezado -->
  <header class="app-header">
    <h1>Cáritas CNC</h1>
  </header>

  <!-- 📌 Misión y Visión -->
  <section class="container card">
    <h2>🌟 Nuestra Misión</h2>
    <p>
      Servir a las familias más necesitadas con solidaridad, acompañamiento y amor cristiano,
      promoviendo la dignidad y la esperanza.
    </p>
    <h2>👁️ Nuestra Visión</h2>
    <p>
      Ser una comunidad unida que transforma la realidad de las familias vulnerables,
      sembrando valores de fe, justicia y caridad.
    </p>
  </section>

  <!-- 📂 Botón a Google Drive -->
  <section class="container card center">
    <a class="btn" href="https://drive.google.com/" target="_blank">📂 Acceder a Drive</a>
  </section>

  <!-- 👨‍👩‍👧 Familias registradas -->
  <main class="container card">
    <h2>👨‍👩‍👧 Familias Registradas</h2>
    <div id="msg"></div>
    <table id="familiasTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombres</th>
          <th>Dirección</th>
          <th>Teléfono</th>
          <th>Visitada</th>
          <th>Mapa</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:center;">
      <button id="prevPage" class="btn">⏮ Anterior</button>
      <button id="nextPage" class="btn">Siguiente ⏭</button>
    </div>
    <button id="guardarCambios" class="btn" style="margin-top:1rem;">💾 Guardar cambios</button>
  </main>

  <!-- ✅ Script de familias -->
  <script type="module">
    const supabase = window.CARITAS?.supabase;
    const tabla = document.querySelector("#familiasTable tbody");
    const msg = document.getElementById("msg");
    const cambios = new Map();
    let page = 0;
    const pageSize = 10;

    function showMsg(text, type="info"){
      msg.textContent = text;
      msg.className = type;
      setTimeout(()=>{ msg.textContent=""; },4000);
    }

    const esc = (s="") => String(s).replace(/[&<>"']/g,
      m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );

    async function cargarFamilias(){
      try {
        const start = page * pageSize;
        const end = start + pageSize - 1;
        const { data, error } = await supabase
          .from("familias")
          .select("*")
          .order("id",{ascending:true})
          .range(start,end);

        if(error) throw error;
        tabla.innerHTML="";
        if(!data || data.length===0){
          tabla.innerHTML="<tr><td colspan='6'>Sin registros</td></tr>";
          return;
        }

        data.forEach(fam=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fam.id}</td>
            <td>${esc(fam.nombres_apellidos||"")}</td>
            <td>${esc(fam.direccion||"")}</td>
            <td>${esc(fam.telefono_contacto||"")}</td>
            <td><input type="checkbox" data-id="${fam.id}" ${fam.visitada?"checked":""}></td>
            <td>${fam.direccion ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fam.direccion)}" target="_blank">🗺</a>` : "—"}</td>
          `;
          tabla.appendChild(tr);
        });
      }catch(err){
        console.error(err);
        tabla.innerHTML="<tr><td colspan='6'>Error al cargar datos</td></tr>";
      }
    }

    // Guardar cambios
    document.getElementById("guardarCambios").addEventListener("click", async ()=>{
      try{
        for(const [id,v] of cambios){
          await supabase.from("familias").update({visitada:v}).eq("id",id);
        }
        showMsg("✅ Cambios guardados","success");
        cambios.clear();
        cargarFamilias();
      }catch{
        showMsg("❌ Error guardando cambios","error");
      }
    });

    // Detectar cambios en checkboxes
    document.getElementById("familiasTable").addEventListener("change", e=>{
      if(e.target.type==="checkbox"){
        cambios.set(e.target.dataset.id,e.target.checked);
      }
    });

    // Paginación
    document.getElementById("prevPage").addEventListener("click",()=>{
      if(page>0){ page--; cargarFamilias(); }
    });
    document.getElementById("nextPage").addEventListener("click",()=>{
      page++; cargarFamilias();
    });

    cargarFamilias();
  </script>
</body>
</html>